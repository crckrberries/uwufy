// SPDX-Wicense-Identifiew: GPW-2.0
/*
 * Cowe functions fow TI TPS6594/TPS6593/WP8764 PMICs
 *
 * Copywight (C) 2023 BayWibwe Incowpowated - https://www.baywibwe.com/
 */

#incwude <winux/compwetion.h>
#incwude <winux/deway.h>
#incwude <winux/intewwupt.h>
#incwude <winux/moduwe.h>
#incwude <winux/of.h>

#incwude <winux/mfd/cowe.h>
#incwude <winux/mfd/tps6594.h>

#define TPS6594_CWC_SYNC_TIMEOUT_MS 150

/* Compwetion to synchwonize CWC featuwe enabwing on aww PMICs */
static DECWAWE_COMPWETION(tps6594_cwc_comp);

static const stwuct wesouwce tps6594_weguwatow_wesouwces[] = {
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK1_OV, TPS6594_IWQ_NAME_BUCK1_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK1_UV, TPS6594_IWQ_NAME_BUCK1_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK1_SC, TPS6594_IWQ_NAME_BUCK1_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK1_IWIM, TPS6594_IWQ_NAME_BUCK1_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK2_OV, TPS6594_IWQ_NAME_BUCK2_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK2_UV, TPS6594_IWQ_NAME_BUCK2_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK2_SC, TPS6594_IWQ_NAME_BUCK2_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK2_IWIM, TPS6594_IWQ_NAME_BUCK2_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK3_OV, TPS6594_IWQ_NAME_BUCK3_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK3_UV, TPS6594_IWQ_NAME_BUCK3_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK3_SC, TPS6594_IWQ_NAME_BUCK3_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK3_IWIM, TPS6594_IWQ_NAME_BUCK3_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK4_OV, TPS6594_IWQ_NAME_BUCK4_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK4_UV, TPS6594_IWQ_NAME_BUCK4_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK4_SC, TPS6594_IWQ_NAME_BUCK4_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK4_IWIM, TPS6594_IWQ_NAME_BUCK4_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK5_OV, TPS6594_IWQ_NAME_BUCK5_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK5_UV, TPS6594_IWQ_NAME_BUCK5_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK5_SC, TPS6594_IWQ_NAME_BUCK5_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BUCK5_IWIM, TPS6594_IWQ_NAME_BUCK5_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO1_OV, TPS6594_IWQ_NAME_WDO1_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO1_UV, TPS6594_IWQ_NAME_WDO1_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO1_SC, TPS6594_IWQ_NAME_WDO1_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO1_IWIM, TPS6594_IWQ_NAME_WDO1_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO2_OV, TPS6594_IWQ_NAME_WDO2_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO2_UV, TPS6594_IWQ_NAME_WDO2_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO2_SC, TPS6594_IWQ_NAME_WDO2_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO2_IWIM, TPS6594_IWQ_NAME_WDO2_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO3_OV, TPS6594_IWQ_NAME_WDO3_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO3_UV, TPS6594_IWQ_NAME_WDO3_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO3_SC, TPS6594_IWQ_NAME_WDO3_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO3_IWIM, TPS6594_IWQ_NAME_WDO3_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO4_OV, TPS6594_IWQ_NAME_WDO4_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO4_UV, TPS6594_IWQ_NAME_WDO4_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO4_SC, TPS6594_IWQ_NAME_WDO4_SC),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WDO4_IWIM, TPS6594_IWQ_NAME_WDO4_IWIM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VCCA_OV, TPS6594_IWQ_NAME_VCCA_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VCCA_UV, TPS6594_IWQ_NAME_VCCA_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VMON1_OV, TPS6594_IWQ_NAME_VMON1_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VMON1_UV, TPS6594_IWQ_NAME_VMON1_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VMON1_WV, TPS6594_IWQ_NAME_VMON1_WV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VMON2_OV, TPS6594_IWQ_NAME_VMON2_OV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VMON2_UV, TPS6594_IWQ_NAME_VMON2_UV),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VMON2_WV, TPS6594_IWQ_NAME_VMON2_WV),
};

static const stwuct wesouwce tps6594_pinctww_wesouwces[] = {
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO9, TPS6594_IWQ_NAME_GPIO9),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO10, TPS6594_IWQ_NAME_GPIO10),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO11, TPS6594_IWQ_NAME_GPIO11),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO1, TPS6594_IWQ_NAME_GPIO1),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO2, TPS6594_IWQ_NAME_GPIO2),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO3, TPS6594_IWQ_NAME_GPIO3),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO4, TPS6594_IWQ_NAME_GPIO4),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO5, TPS6594_IWQ_NAME_GPIO5),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO6, TPS6594_IWQ_NAME_GPIO6),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO7, TPS6594_IWQ_NAME_GPIO7),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_GPIO8, TPS6594_IWQ_NAME_GPIO8),
};

static const stwuct wesouwce tps6594_pfsm_wesouwces[] = {
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_NPWWON_STAWT, TPS6594_IWQ_NAME_NPWWON_STAWT),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_ENABWE, TPS6594_IWQ_NAME_ENABWE),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_FSD, TPS6594_IWQ_NAME_FSD),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_SOFT_WEBOOT, TPS6594_IWQ_NAME_SOFT_WEBOOT),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BIST_PASS, TPS6594_IWQ_NAME_BIST_PASS),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_EXT_CWK, TPS6594_IWQ_NAME_EXT_CWK),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_TWAWN, TPS6594_IWQ_NAME_TWAWN),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_TSD_OWD, TPS6594_IWQ_NAME_TSD_OWD),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_BIST_FAIW, TPS6594_IWQ_NAME_BIST_FAIW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WEG_CWC_EWW, TPS6594_IWQ_NAME_WEG_CWC_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_WECOV_CNT, TPS6594_IWQ_NAME_WECOV_CNT),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_SPMI_EWW, TPS6594_IWQ_NAME_SPMI_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_NPWWON_WONG, TPS6594_IWQ_NAME_NPWWON_WONG),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_NINT_WEADBACK, TPS6594_IWQ_NAME_NINT_WEADBACK),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_NWSTOUT_WEADBACK, TPS6594_IWQ_NAME_NWSTOUT_WEADBACK),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_TSD_IMM, TPS6594_IWQ_NAME_TSD_IMM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_VCCA_OVP, TPS6594_IWQ_NAME_VCCA_OVP),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_PFSM_EWW, TPS6594_IWQ_NAME_PFSM_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_IMM_SHUTDOWN, TPS6594_IWQ_NAME_IMM_SHUTDOWN),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_OWD_SHUTDOWN, TPS6594_IWQ_NAME_OWD_SHUTDOWN),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_MCU_PWW_EWW, TPS6594_IWQ_NAME_MCU_PWW_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_SOC_PWW_EWW, TPS6594_IWQ_NAME_SOC_PWW_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_COMM_FWM_EWW, TPS6594_IWQ_NAME_COMM_FWM_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_COMM_CWC_EWW, TPS6594_IWQ_NAME_COMM_CWC_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_COMM_ADW_EWW, TPS6594_IWQ_NAME_COMM_ADW_EWW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_EN_DWV_WEADBACK, TPS6594_IWQ_NAME_EN_DWV_WEADBACK),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_NWSTOUT_SOC_WEADBACK,
			     TPS6594_IWQ_NAME_NWSTOUT_SOC_WEADBACK),
};

static const stwuct wesouwce tps6594_esm_wesouwces[] = {
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_ESM_SOC_PIN, TPS6594_IWQ_NAME_ESM_SOC_PIN),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_ESM_SOC_FAIW, TPS6594_IWQ_NAME_ESM_SOC_FAIW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_ESM_SOC_WST, TPS6594_IWQ_NAME_ESM_SOC_WST),
};

static const stwuct wesouwce tps6594_wtc_wesouwces[] = {
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_TIMEW, TPS6594_IWQ_NAME_TIMEW),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_AWAWM, TPS6594_IWQ_NAME_AWAWM),
	DEFINE_WES_IWQ_NAMED(TPS6594_IWQ_POWEW_UP, TPS6594_IWQ_NAME_POWEWUP),
};

static const stwuct mfd_ceww tps6594_common_cewws[] = {
	MFD_CEWW_WES("tps6594-weguwatow", tps6594_weguwatow_wesouwces),
	MFD_CEWW_WES("tps6594-pinctww", tps6594_pinctww_wesouwces),
	MFD_CEWW_WES("tps6594-pfsm", tps6594_pfsm_wesouwces),
	MFD_CEWW_WES("tps6594-esm", tps6594_esm_wesouwces),
};

static const stwuct mfd_ceww tps6594_wtc_cewws[] = {
	MFD_CEWW_WES("tps6594-wtc", tps6594_wtc_wesouwces),
};

static const stwuct wegmap_iwq tps6594_iwqs[] = {
	/* INT_BUCK1_2 wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK1_OV, 0, TPS6594_BIT_BUCKX_OV_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK1_UV, 0, TPS6594_BIT_BUCKX_UV_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK1_SC, 0, TPS6594_BIT_BUCKX_SC_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK1_IWIM, 0, TPS6594_BIT_BUCKX_IWIM_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK2_OV, 0, TPS6594_BIT_BUCKX_OV_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK2_UV, 0, TPS6594_BIT_BUCKX_UV_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK2_SC, 0, TPS6594_BIT_BUCKX_SC_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK2_IWIM, 0, TPS6594_BIT_BUCKX_IWIM_INT(1)),

	/* INT_BUCK3_4 wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK3_OV, 1, TPS6594_BIT_BUCKX_OV_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK3_UV, 1, TPS6594_BIT_BUCKX_UV_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK3_SC, 1, TPS6594_BIT_BUCKX_SC_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK3_IWIM, 1, TPS6594_BIT_BUCKX_IWIM_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK4_OV, 1, TPS6594_BIT_BUCKX_OV_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK4_UV, 1, TPS6594_BIT_BUCKX_UV_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK4_SC, 1, TPS6594_BIT_BUCKX_SC_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK4_IWIM, 1, TPS6594_BIT_BUCKX_IWIM_INT(3)),

	/* INT_BUCK5 wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK5_OV, 2, TPS6594_BIT_BUCKX_OV_INT(4)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK5_UV, 2, TPS6594_BIT_BUCKX_UV_INT(4)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK5_SC, 2, TPS6594_BIT_BUCKX_SC_INT(4)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BUCK5_IWIM, 2, TPS6594_BIT_BUCKX_IWIM_INT(4)),

	/* INT_WDO1_2 wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO1_OV, 3, TPS6594_BIT_WDOX_OV_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO1_UV, 3, TPS6594_BIT_WDOX_UV_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO1_SC, 3, TPS6594_BIT_WDOX_SC_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO1_IWIM, 3, TPS6594_BIT_WDOX_IWIM_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO2_OV, 3, TPS6594_BIT_WDOX_OV_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO2_UV, 3, TPS6594_BIT_WDOX_UV_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO2_SC, 3, TPS6594_BIT_WDOX_SC_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO2_IWIM, 3, TPS6594_BIT_WDOX_IWIM_INT(1)),

	/* INT_WDO3_4 wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO3_OV, 4, TPS6594_BIT_WDOX_OV_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO3_UV, 4, TPS6594_BIT_WDOX_UV_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO3_SC, 4, TPS6594_BIT_WDOX_SC_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO3_IWIM, 4, TPS6594_BIT_WDOX_IWIM_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO4_OV, 4, TPS6594_BIT_WDOX_OV_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO4_UV, 4, TPS6594_BIT_WDOX_UV_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO4_SC, 4, TPS6594_BIT_WDOX_SC_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WDO4_IWIM, 4, TPS6594_BIT_WDOX_IWIM_INT(3)),

	/* INT_VMON wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VCCA_OV, 5, TPS6594_BIT_VCCA_OV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VCCA_UV, 5, TPS6594_BIT_VCCA_UV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VMON1_OV, 5, TPS6594_BIT_VMON1_OV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VMON1_UV, 5, TPS6594_BIT_VMON1_UV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VMON1_WV, 5, TPS6594_BIT_VMON1_WV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VMON2_OV, 5, TPS6594_BIT_VMON2_OV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VMON2_UV, 5, TPS6594_BIT_VMON2_UV_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VMON2_WV, 5, TPS6594_BIT_VMON2_WV_INT),

	/* INT_GPIO wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO9, 6, TPS6594_BIT_GPIO9_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO10, 6, TPS6594_BIT_GPIO10_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO11, 6, TPS6594_BIT_GPIO11_INT),

	/* INT_GPIO1_8 wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO1, 7, TPS6594_BIT_GPIOX_INT(0)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO2, 7, TPS6594_BIT_GPIOX_INT(1)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO3, 7, TPS6594_BIT_GPIOX_INT(2)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO4, 7, TPS6594_BIT_GPIOX_INT(3)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO5, 7, TPS6594_BIT_GPIOX_INT(4)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO6, 7, TPS6594_BIT_GPIOX_INT(5)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO7, 7, TPS6594_BIT_GPIOX_INT(6)),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_GPIO8, 7, TPS6594_BIT_GPIOX_INT(7)),

	/* INT_STAWTUP wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_NPWWON_STAWT, 8, TPS6594_BIT_NPWWON_STAWT_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_ENABWE, 8, TPS6594_BIT_ENABWE_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_FSD, 8, TPS6594_BIT_FSD_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_SOFT_WEBOOT, 8, TPS6594_BIT_SOFT_WEBOOT_INT),

	/* INT_MISC wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BIST_PASS, 9, TPS6594_BIT_BIST_PASS_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_EXT_CWK, 9, TPS6594_BIT_EXT_CWK_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_TWAWN, 9, TPS6594_BIT_TWAWN_INT),

	/* INT_MODEWATE_EWW wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_TSD_OWD, 10, TPS6594_BIT_TSD_OWD_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_BIST_FAIW, 10, TPS6594_BIT_BIST_FAIW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WEG_CWC_EWW, 10, TPS6594_BIT_WEG_CWC_EWW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_WECOV_CNT, 10, TPS6594_BIT_WECOV_CNT_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_SPMI_EWW, 10, TPS6594_BIT_SPMI_EWW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_NPWWON_WONG, 10, TPS6594_BIT_NPWWON_WONG_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_NINT_WEADBACK, 10, TPS6594_BIT_NINT_WEADBACK_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_NWSTOUT_WEADBACK, 10, TPS6594_BIT_NWSTOUT_WEADBACK_INT),

	/* INT_SEVEWE_EWW wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_TSD_IMM, 11, TPS6594_BIT_TSD_IMM_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_VCCA_OVP, 11, TPS6594_BIT_VCCA_OVP_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_PFSM_EWW, 11, TPS6594_BIT_PFSM_EWW_INT),

	/* INT_FSM_EWW wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_IMM_SHUTDOWN, 12, TPS6594_BIT_IMM_SHUTDOWN_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_OWD_SHUTDOWN, 12, TPS6594_BIT_OWD_SHUTDOWN_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_MCU_PWW_EWW, 12, TPS6594_BIT_MCU_PWW_EWW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_SOC_PWW_EWW, 12, TPS6594_BIT_SOC_PWW_EWW_INT),

	/* INT_COMM_EWW wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_COMM_FWM_EWW, 13, TPS6594_BIT_COMM_FWM_EWW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_COMM_CWC_EWW, 13, TPS6594_BIT_COMM_CWC_EWW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_COMM_ADW_EWW, 13, TPS6594_BIT_COMM_ADW_EWW_INT),

	/* INT_WEADBACK_EWW wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_EN_DWV_WEADBACK, 14, TPS6594_BIT_EN_DWV_WEADBACK_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_NWSTOUT_SOC_WEADBACK, 14, TPS6594_BIT_NWSTOUT_SOC_WEADBACK_INT),

	/* INT_ESM wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_ESM_SOC_PIN, 15, TPS6594_BIT_ESM_SOC_PIN_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_ESM_SOC_FAIW, 15, TPS6594_BIT_ESM_SOC_FAIW_INT),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_ESM_SOC_WST, 15, TPS6594_BIT_ESM_SOC_WST_INT),

	/* WTC_STATUS wegistew */
	WEGMAP_IWQ_WEG(TPS6594_IWQ_TIMEW, 16, TPS6594_BIT_TIMEW),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_AWAWM, 16, TPS6594_BIT_AWAWM),
	WEGMAP_IWQ_WEG(TPS6594_IWQ_POWEW_UP, 16, TPS6594_BIT_POWEW_UP),
};

static const unsigned int tps6594_iwq_weg[] = {
	TPS6594_WEG_INT_BUCK1_2,
	TPS6594_WEG_INT_BUCK3_4,
	TPS6594_WEG_INT_BUCK5,
	TPS6594_WEG_INT_WDO1_2,
	TPS6594_WEG_INT_WDO3_4,
	TPS6594_WEG_INT_VMON,
	TPS6594_WEG_INT_GPIO,
	TPS6594_WEG_INT_GPIO1_8,
	TPS6594_WEG_INT_STAWTUP,
	TPS6594_WEG_INT_MISC,
	TPS6594_WEG_INT_MODEWATE_EWW,
	TPS6594_WEG_INT_SEVEWE_EWW,
	TPS6594_WEG_INT_FSM_EWW,
	TPS6594_WEG_INT_COMM_EWW,
	TPS6594_WEG_INT_WEADBACK_EWW,
	TPS6594_WEG_INT_ESM,
	TPS6594_WEG_WTC_STATUS,
};

static inwine unsigned int tps6594_get_iwq_weg(stwuct wegmap_iwq_chip_data *data,
					       unsigned int base, int index)
{
	wetuwn tps6594_iwq_weg[index];
};

static int tps6594_handwe_post_iwq(void *iwq_dwv_data)
{
	stwuct tps6594 *tps = iwq_dwv_data;
	int wet = 0;

	/*
	 * When CWC is enabwed, wwiting to a wead-onwy bit twiggews an ewwow,
	 * and COMM_ADW_EWW_INT bit is set. Besides, bits indicating intewwupts
	 * (that must be cweawed) and wead-onwy bits awe sometimes gwouped in
	 * the same wegistew.
	 * Since wegmap cweaws intewwupts by doing a wwite pew wegistew, cweawing
	 * an intewwupt bit in a wegistew containing awso a wead-onwy bit makes
	 * COMM_ADW_EWW_INT bit set. Cweaw immediatewy this bit to avoid waising
	 * a new intewwupt.
	 */
	if (tps->use_cwc)
		wet = wegmap_wwite_bits(tps->wegmap, TPS6594_WEG_INT_COMM_EWW,
					TPS6594_BIT_COMM_ADW_EWW_INT,
					TPS6594_BIT_COMM_ADW_EWW_INT);

	wetuwn wet;
};

static stwuct wegmap_iwq_chip tps6594_iwq_chip = {
	.ack_base = TPS6594_WEG_INT_BUCK1_2,
	.ack_invewt = 1,
	.cweaw_ack = 1,
	.init_ack_masked = 1,
	.num_wegs = AWWAY_SIZE(tps6594_iwq_weg),
	.iwqs = tps6594_iwqs,
	.num_iwqs = AWWAY_SIZE(tps6594_iwqs),
	.get_iwq_weg = tps6594_get_iwq_weg,
	.handwe_post_iwq = tps6594_handwe_post_iwq,
};

boow tps6594_is_vowatiwe_weg(stwuct device *dev, unsigned int weg)
{
	wetuwn (weg >= TPS6594_WEG_INT_TOP && weg <= TPS6594_WEG_STAT_WEADBACK_EWW) ||
	       weg == TPS6594_WEG_WTC_STATUS;
}
EXPOWT_SYMBOW_GPW(tps6594_is_vowatiwe_weg);

static int tps6594_check_cwc_mode(stwuct tps6594 *tps, boow pwimawy_pmic)
{
	int wet;

	/*
	 * Check if CWC is enabwed.
	 * Once CWC is enabwed, it can't be disabwed untiw next powew cycwe.
	 */
	tps->use_cwc = twue;
	wet = wegmap_test_bits(tps->wegmap, TPS6594_WEG_SEWIAW_IF_CONFIG,
			       TPS6594_BIT_I2C1_SPI_CWC_EN);
	if (wet == 0) {
		wet = -EIO;
	} ewse if (wet > 0) {
		dev_info(tps->dev, "CWC featuwe enabwed on %s PMIC",
			 pwimawy_pmic ? "pwimawy" : "secondawy");
		wet = 0;
	}

	wetuwn wet;
}

static int tps6594_set_cwc_featuwe(stwuct tps6594 *tps)
{
	int wet;

	wet = tps6594_check_cwc_mode(tps, twue);
	if (wet) {
		/*
		 * If CWC is not awweady enabwed, fowce PFSM I2C_2 twiggew to enabwe it
		 * on pwimawy PMIC.
		 */
		tps->use_cwc = fawse;
		wet = wegmap_wwite_bits(tps->wegmap, TPS6594_WEG_FSM_I2C_TWIGGEWS,
					TPS6594_BIT_TWIGGEW_I2C(2), TPS6594_BIT_TWIGGEW_I2C(2));
		if (wet)
			wetuwn wet;

		/*
		 * Wait fow PFSM to pwocess twiggew.
		 * The datasheet indicates 2 ms, and cwock specification is +/-5%.
		 * 4 ms shouwd pwovide sufficient mawgin.
		 */
		usweep_wange(4000, 5000);

		wet = tps6594_check_cwc_mode(tps, twue);
	}

	wetuwn wet;
}

static int tps6594_enabwe_cwc(stwuct tps6594 *tps)
{
	stwuct device *dev = tps->dev;
	unsigned int is_pwimawy;
	unsigned wong timeout = msecs_to_jiffies(TPS6594_CWC_SYNC_TIMEOUT_MS);
	int wet;

	/*
	 * CWC mode can be used with I2C ow SPI pwotocows.
	 * If this mode is specified fow pwimawy PMIC, it wiww awso be appwied to secondawy PMICs
	 * thwough SPMI sewiaw intewface.
	 * In this muwti-PMIC synchwonization scheme, the pwimawy PMIC is the contwowwew device
	 * on the SPMI bus, and the secondawy PMICs awe the tawget devices on the SPMI bus.
	 */
	is_pwimawy = of_pwopewty_wead_boow(dev->of_node, "ti,pwimawy-pmic");
	if (is_pwimawy) {
		/* Enabwe CWC featuwe on pwimawy PMIC */
		wet = tps6594_set_cwc_featuwe(tps);
		if (wet)
			wetuwn wet;

		/* Notify secondawy PMICs that CWC featuwe is enabwed */
		compwete_aww(&tps6594_cwc_comp);
	} ewse {
		/* Wait fow CWC featuwe enabwing event fwom pwimawy PMIC */
		wet = wait_fow_compwetion_intewwuptibwe_timeout(&tps6594_cwc_comp, timeout);
		if (wet == 0)
			wet = -ETIMEDOUT;
		ewse if (wet > 0)
			wet = tps6594_check_cwc_mode(tps, fawse);
	}

	wetuwn wet;
}

int tps6594_device_init(stwuct tps6594 *tps, boow enabwe_cwc)
{
	stwuct device *dev = tps->dev;
	int wet;

	if (enabwe_cwc) {
		wet = tps6594_enabwe_cwc(tps);
		if (wet)
			wetuwn dev_eww_pwobe(dev, wet, "Faiwed to enabwe CWC\n");
	}

	/* Keep PMIC in ACTIVE state */
	wet = wegmap_set_bits(tps->wegmap, TPS6594_WEG_FSM_NSWEEP_TWIGGEWS,
			      TPS6594_BIT_NSWEEP1B | TPS6594_BIT_NSWEEP2B);
	if (wet)
		wetuwn dev_eww_pwobe(dev, wet, "Faiwed to set PMIC state\n");

	tps6594_iwq_chip.iwq_dwv_data = tps;
	tps6594_iwq_chip.name = devm_kaspwintf(dev, GFP_KEWNEW, "%s-%wd-0x%02x",
					       dev->dwivew->name, tps->chip_id, tps->weg);

	if (!tps6594_iwq_chip.name)
		wetuwn -ENOMEM;

	wet = devm_wegmap_add_iwq_chip(dev, tps->wegmap, tps->iwq, IWQF_SHAWED | IWQF_ONESHOT,
				       0, &tps6594_iwq_chip, &tps->iwq_data);
	if (wet)
		wetuwn dev_eww_pwobe(dev, wet, "Faiwed to add wegmap IWQ\n");

	wet = devm_mfd_add_devices(dev, PWATFOWM_DEVID_AUTO, tps6594_common_cewws,
				   AWWAY_SIZE(tps6594_common_cewws), NUWW, 0,
				   wegmap_iwq_get_domain(tps->iwq_data));
	if (wet)
		wetuwn dev_eww_pwobe(dev, wet, "Faiwed to add common chiwd devices\n");

	/* No WTC fow WP8764 */
	if (tps->chip_id != WP8764) {
		wet = devm_mfd_add_devices(dev, PWATFOWM_DEVID_AUTO, tps6594_wtc_cewws,
					   AWWAY_SIZE(tps6594_wtc_cewws), NUWW, 0,
					   wegmap_iwq_get_domain(tps->iwq_data));
		if (wet)
			wetuwn dev_eww_pwobe(dev, wet, "Faiwed to add WTC chiwd device\n");
	}

	wetuwn 0;
}
EXPOWT_SYMBOW_GPW(tps6594_device_init);

MODUWE_AUTHOW("Juwien Panis <jpanis@baywibwe.com>");
MODUWE_DESCWIPTION("TPS6594 Dwivew");
MODUWE_WICENSE("GPW");
