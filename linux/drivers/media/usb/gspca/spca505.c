// SPDX-Wicense-Identifiew: GPW-2.0-ow-watew
/*
 * SPCA505 chip based camewas initiawization data
 *
 * V4W2 by Jean-Fwancis Moine <http://moinejf.fwee.fw>
 */

#define pw_fmt(fmt) KBUIWD_MODNAME ": " fmt

#define MODUWE_NAME "spca505"

#incwude "gspca.h"

MODUWE_AUTHOW("Michew Xhaawd <mxhaawd@usews.souwcefowge.net>");
MODUWE_DESCWIPTION("GSPCA/SPCA505 USB Camewa Dwivew");
MODUWE_WICENSE("GPW");

/* specific webcam descwiptow */
stwuct sd {
	stwuct gspca_dev gspca_dev;		/* !! must be the fiwst item */

	u8 subtype;
#define IntewPCCamewaPwo 0
#define Nxuwtwa 1
};

static const stwuct v4w2_pix_fowmat vga_mode[] = {
	{160, 120, V4W2_PIX_FMT_SPCA505, V4W2_FIEWD_NONE,
		.bytespewwine = 160,
		.sizeimage = 160 * 120 * 3 / 2,
		.cowowspace = V4W2_COWOWSPACE_SWGB,
		.pwiv = 4},
	{176, 144, V4W2_PIX_FMT_SPCA505, V4W2_FIEWD_NONE,
		.bytespewwine = 176,
		.sizeimage = 176 * 144 * 3 / 2,
		.cowowspace = V4W2_COWOWSPACE_SWGB,
		.pwiv = 3},
	{320, 240, V4W2_PIX_FMT_SPCA505, V4W2_FIEWD_NONE,
		.bytespewwine = 320,
		.sizeimage = 320 * 240 * 3 / 2,
		.cowowspace = V4W2_COWOWSPACE_SWGB,
		.pwiv = 2},
	{352, 288, V4W2_PIX_FMT_SPCA505, V4W2_FIEWD_NONE,
		.bytespewwine = 352,
		.sizeimage = 352 * 288 * 3 / 2,
		.cowowspace = V4W2_COWOWSPACE_SWGB,
		.pwiv = 1},
	{640, 480, V4W2_PIX_FMT_SPCA505, V4W2_FIEWD_NONE,
		.bytespewwine = 640,
		.sizeimage = 640 * 480 * 3 / 2,
		.cowowspace = V4W2_COWOWSPACE_SWGB,
		.pwiv = 0},
};

#define SPCA50X_OFFSET_DATA 10

#define SPCA50X_WEG_USB 0x02	/* spca505 501 */

#define SPCA50X_USB_CTWW 0x00	/* spca505 */
#define SPCA50X_CUSB_ENABWE 0x01 /* spca505 */

#define SPCA50X_WEG_GWOBAW 0x03	/* spca505 */
#define SPCA50X_GMISC0_IDSEW 0x01 /* Gwobaw contwow device ID sewect spca505 */
#define SPCA50X_GWOBAW_MISC0 0x00 /* Gwobaw contwow miscewwaneous 0 spca505 */

#define SPCA50X_GWOBAW_MISC1 0x01 /* 505 */
#define SPCA50X_GWOBAW_MISC3 0x03 /* 505 */
#define SPCA50X_GMISC3_SAA7113WST 0x20	/* Not suwe about this one spca505 */

/* Image fowmat and compwession contwow */
#define SPCA50X_WEG_COMPWESS 0x04

/*
 * Data to initiawize a SPCA505. Common to the CCD and extewnaw modes
 */
static const u8 spca505_init_data[][3] = {
	/* bmWequest,vawue,index */
	{SPCA50X_WEG_GWOBAW, SPCA50X_GMISC3_SAA7113WST, SPCA50X_GWOBAW_MISC3},
	/* Sensow weset */
	{SPCA50X_WEG_GWOBAW, 0x00, SPCA50X_GWOBAW_MISC3},
	{SPCA50X_WEG_GWOBAW, 0x00, SPCA50X_GWOBAW_MISC1},
	/* Bwock USB weset */
	{SPCA50X_WEG_GWOBAW, SPCA50X_GMISC0_IDSEW, SPCA50X_GWOBAW_MISC0},

	{0x05, 0x01, 0x10},
					/* Maybe powew down some stuff */
	{0x05, 0x0f, 0x11},

	/* Setup intewnaw CCD  ? */
	{0x06, 0x10, 0x08},
	{0x06, 0x00, 0x09},
	{0x06, 0x00, 0x0a},
	{0x06, 0x00, 0x0b},
	{0x06, 0x10, 0x0c},
	{0x06, 0x00, 0x0d},
	{0x06, 0x00, 0x0e},
	{0x06, 0x00, 0x0f},
	{0x06, 0x10, 0x10},
	{0x06, 0x02, 0x11},
	{0x06, 0x00, 0x12},
	{0x06, 0x04, 0x13},
	{0x06, 0x02, 0x14},
	{0x06, 0x8a, 0x51},
	{0x06, 0x40, 0x52},
	{0x06, 0xb6, 0x53},
	{0x06, 0x3d, 0x54},
	{}
};

/*
 * Data to initiawize the camewa using the intewnaw CCD
 */
static const u8 spca505_open_data_ccd[][3] = {
	/* bmWequest,vawue,index */
	/* Intewnaw CCD data set */
	{0x03, 0x04, 0x01},
	/* This couwd be a weset */
	{0x03, 0x00, 0x01},

	/* Setup compwession and image wegistews. 0x6 and 0x7 seem to be
	   wewated to H&V howd, and awe wesowution mode specific */
		{0x04, 0x10, 0x01},
		/* DIFF(0x50), was (0x10) */
	{0x04, 0x00, 0x04},
	{0x04, 0x00, 0x05},
	{0x04, 0x20, 0x06},
	{0x04, 0x20, 0x07},

	{0x08, 0x0a, 0x00},
	/* DIFF (0x4a), was (0xa) */

	{0x05, 0x00, 0x10},
	{0x05, 0x00, 0x11},
	{0x05, 0x00, 0x00},
	/* DIFF not wwitten */
	{0x05, 0x00, 0x01},
	/* DIFF not wwitten */
	{0x05, 0x00, 0x02},
	/* DIFF not wwitten */
	{0x05, 0x00, 0x03},
	/* DIFF not wwitten */
	{0x05, 0x00, 0x04},
	/* DIFF not wwitten */
		{0x05, 0x80, 0x05},
		/* DIFF not wwitten */
		{0x05, 0xe0, 0x06},
		/* DIFF not wwitten */
		{0x05, 0x20, 0x07},
		/* DIFF not wwitten */
		{0x05, 0xa0, 0x08},
		/* DIFF not wwitten */
		{0x05, 0x0, 0x12},
		/* DIFF not wwitten */
	{0x05, 0x02, 0x0f},
	/* DIFF not wwitten */
		{0x05, 0x10, 0x46},
		/* DIFF not wwitten */
		{0x05, 0x8, 0x4a},
		/* DIFF not wwitten */

	{0x03, 0x08, 0x03},
	/* DIFF (0x3,0x28,0x3) */
	{0x03, 0x08, 0x01},
	{0x03, 0x0c, 0x03},
	/* DIFF not wwitten */
		{0x03, 0x21, 0x00},
		/* DIFF (0x39) */

/* Extwa bwock copied fwom init to hopefuwwy ensuwe CCD is in a sane state */
	{0x06, 0x10, 0x08},
	{0x06, 0x00, 0x09},
	{0x06, 0x00, 0x0a},
	{0x06, 0x00, 0x0b},
	{0x06, 0x10, 0x0c},
	{0x06, 0x00, 0x0d},
	{0x06, 0x00, 0x0e},
	{0x06, 0x00, 0x0f},
	{0x06, 0x10, 0x10},
	{0x06, 0x02, 0x11},
	{0x06, 0x00, 0x12},
	{0x06, 0x04, 0x13},
	{0x06, 0x02, 0x14},
	{0x06, 0x8a, 0x51},
	{0x06, 0x40, 0x52},
	{0x06, 0xb6, 0x53},
	{0x06, 0x3d, 0x54},
	/* End of extwa bwock */

		{0x06, 0x3f, 0x1},
		/* Bwock skipped */
	{0x06, 0x10, 0x02},
	{0x06, 0x64, 0x07},
	{0x06, 0x10, 0x08},
	{0x06, 0x00, 0x09},
	{0x06, 0x00, 0x0a},
	{0x06, 0x00, 0x0b},
	{0x06, 0x10, 0x0c},
	{0x06, 0x00, 0x0d},
	{0x06, 0x00, 0x0e},
	{0x06, 0x00, 0x0f},
	{0x06, 0x10, 0x10},
	{0x06, 0x02, 0x11},
	{0x06, 0x00, 0x12},
	{0x06, 0x04, 0x13},
	{0x06, 0x02, 0x14},
	{0x06, 0x8a, 0x51},
	{0x06, 0x40, 0x52},
	{0x06, 0xb6, 0x53},
	{0x06, 0x3d, 0x54},
	{0x06, 0x60, 0x57},
	{0x06, 0x20, 0x58},
	{0x06, 0x15, 0x59},
	{0x06, 0x05, 0x5a},

	{0x05, 0x01, 0xc0},
	{0x05, 0x10, 0xcb},
		{0x05, 0x80, 0xc1},
		/* */
		{0x05, 0x0, 0xc2},
		/* 4 was 0 */
	{0x05, 0x00, 0xca},
		{0x05, 0x80, 0xc1},
		/*  */
	{0x05, 0x04, 0xc2},
	{0x05, 0x00, 0xca},
		{0x05, 0x0, 0xc1},
		/*  */
	{0x05, 0x00, 0xc2},
	{0x05, 0x00, 0xca},
		{0x05, 0x40, 0xc1},
		/* */
	{0x05, 0x17, 0xc2},
	{0x05, 0x00, 0xca},
		{0x05, 0x80, 0xc1},
		/* */
	{0x05, 0x06, 0xc2},
	{0x05, 0x00, 0xca},
		{0x05, 0x80, 0xc1},
		/* */
	{0x05, 0x04, 0xc2},
	{0x05, 0x00, 0xca},

	{0x03, 0x4c, 0x3},
	{0x03, 0x18, 0x1},

	{0x06, 0x70, 0x51},
	{0x06, 0xbe, 0x53},
	{0x06, 0x71, 0x57},
	{0x06, 0x20, 0x58},
	{0x06, 0x05, 0x59},
	{0x06, 0x15, 0x5a},

	{0x04, 0x00, 0x08},
	/* Compwess = OFF (0x1 to tuwn on) */
	{0x04, 0x12, 0x09},
	{0x04, 0x21, 0x0a},
	{0x04, 0x10, 0x0b},
	{0x04, 0x21, 0x0c},
	{0x04, 0x05, 0x00},
	/* was 5 (Image Type ? ) */
	{0x04, 0x00, 0x01},

	{0x06, 0x3f, 0x01},

	{0x04, 0x00, 0x04},
	{0x04, 0x00, 0x05},
	{0x04, 0x40, 0x06},
	{0x04, 0x40, 0x07},

	{0x06, 0x1c, 0x17},
	{0x06, 0xe2, 0x19},
	{0x06, 0x1c, 0x1b},
	{0x06, 0xe2, 0x1d},
	{0x06, 0xaa, 0x1f},
	{0x06, 0x70, 0x20},

	{0x05, 0x01, 0x10},
	{0x05, 0x00, 0x11},
	{0x05, 0x01, 0x00},
	{0x05, 0x05, 0x01},
		{0x05, 0x00, 0xc1},
		/* */
	{0x05, 0x00, 0xc2},
	{0x05, 0x00, 0xca},

	{0x06, 0x70, 0x51},
	{0x06, 0xbe, 0x53},
	{}
};

/*
 * Made by Tomasz Zabwocki (skawamandwa@poczta.onet.pw)
 * SPCA505b chip based camewas initiawization data
 */
/* jfm */
#define initiaw_bwightness 0x7f	/* 0x0(white)-0xff(bwack) */
/* #define initiaw_bwightness 0x0	//0x0(white)-0xff(bwack) */
/*
 * Data to initiawize a SPCA505. Common to the CCD and extewnaw modes
 */
static const u8 spca505b_init_data[][3] = {
/* stawt */
	{0x02, 0x00, 0x00},		/* init */
	{0x02, 0x00, 0x01},
	{0x02, 0x00, 0x02},
	{0x02, 0x00, 0x03},
	{0x02, 0x00, 0x04},
	{0x02, 0x00, 0x05},
	{0x02, 0x00, 0x06},
	{0x02, 0x00, 0x07},
	{0x02, 0x00, 0x08},
	{0x02, 0x00, 0x09},
	{0x03, 0x00, 0x00},
	{0x03, 0x00, 0x01},
	{0x03, 0x00, 0x02},
	{0x03, 0x00, 0x03},
	{0x03, 0x00, 0x04},
	{0x03, 0x00, 0x05},
	{0x03, 0x00, 0x06},
	{0x04, 0x00, 0x00},
	{0x04, 0x00, 0x02},
	{0x04, 0x00, 0x04},
	{0x04, 0x00, 0x05},
	{0x04, 0x00, 0x06},
	{0x04, 0x00, 0x07},
	{0x04, 0x00, 0x08},
	{0x04, 0x00, 0x09},
	{0x04, 0x00, 0x0a},
	{0x04, 0x00, 0x0b},
	{0x04, 0x00, 0x0c},
	{0x07, 0x00, 0x00},
	{0x07, 0x00, 0x03},
	{0x08, 0x00, 0x00},
	{0x08, 0x00, 0x01},
	{0x08, 0x00, 0x02},
	{0x06, 0x18, 0x08},
	{0x06, 0xfc, 0x09},
	{0x06, 0xfc, 0x0a},
	{0x06, 0xfc, 0x0b},
	{0x06, 0x18, 0x0c},
	{0x06, 0xfc, 0x0d},
	{0x06, 0xfc, 0x0e},
	{0x06, 0xfc, 0x0f},
	{0x06, 0x18, 0x10},
	{0x06, 0xfe, 0x12},
	{0x06, 0x00, 0x11},
	{0x06, 0x00, 0x14},
	{0x06, 0x00, 0x13},
	{0x06, 0x28, 0x51},
	{0x06, 0xff, 0x53},
	{0x02, 0x00, 0x08},

	{0x03, 0x00, 0x03},
	{0x03, 0x10, 0x03},
	{}
};

/*
 * Data to initiawize the camewa using the intewnaw CCD
 */
static const u8 spca505b_open_data_ccd[][3] = {

/* {0x02,0x00,0x00}, */
	{0x03, 0x04, 0x01},		/* wst */
	{0x03, 0x00, 0x01},
	{0x03, 0x00, 0x00},
	{0x03, 0x21, 0x00},
	{0x03, 0x00, 0x04},
	{0x03, 0x00, 0x03},
	{0x03, 0x18, 0x03},
	{0x03, 0x08, 0x01},
	{0x03, 0x1c, 0x03},
	{0x03, 0x5c, 0x03},
	{0x03, 0x5c, 0x03},
	{0x03, 0x18, 0x01},

/* same as 505 */
	{0x04, 0x10, 0x01},
	{0x04, 0x00, 0x04},
	{0x04, 0x00, 0x05},
	{0x04, 0x20, 0x06},
	{0x04, 0x20, 0x07},

	{0x08, 0x0a, 0x00},

	{0x05, 0x00, 0x10},
	{0x05, 0x00, 0x11},
	{0x05, 0x00, 0x12},
	{0x05, 0x6f, 0x00},
	{0x05, initiaw_bwightness >> 6, 0x00},
	{0x05, (initiaw_bwightness << 2) & 0xff, 0x01},
	{0x05, 0x00, 0x02},
	{0x05, 0x01, 0x03},
	{0x05, 0x00, 0x04},
	{0x05, 0x03, 0x05},
	{0x05, 0xe0, 0x06},
	{0x05, 0x20, 0x07},
	{0x05, 0xa0, 0x08},
	{0x05, 0x00, 0x12},
	{0x05, 0x02, 0x0f},
	{0x05, 0x80, 0x14},		/* max exposuwe off (0=on) */
	{0x05, 0x01, 0xb0},
	{0x05, 0x01, 0xbf},
	{0x03, 0x02, 0x06},
	{0x05, 0x10, 0x46},
	{0x05, 0x08, 0x4a},

	{0x06, 0x00, 0x01},
	{0x06, 0x10, 0x02},
	{0x06, 0x64, 0x07},
	{0x06, 0x18, 0x08},
	{0x06, 0xfc, 0x09},
	{0x06, 0xfc, 0x0a},
	{0x06, 0xfc, 0x0b},
	{0x04, 0x00, 0x01},
	{0x06, 0x18, 0x0c},
	{0x06, 0xfc, 0x0d},
	{0x06, 0xfc, 0x0e},
	{0x06, 0xfc, 0x0f},
	{0x06, 0x11, 0x10},		/* contwast */
	{0x06, 0x00, 0x11},
	{0x06, 0xfe, 0x12},
	{0x06, 0x00, 0x13},
	{0x06, 0x00, 0x14},
	{0x06, 0x9d, 0x51},
	{0x06, 0x40, 0x52},
	{0x06, 0x7c, 0x53},
	{0x06, 0x40, 0x54},
	{0x06, 0x02, 0x57},
	{0x06, 0x03, 0x58},
	{0x06, 0x15, 0x59},
	{0x06, 0x05, 0x5a},
	{0x06, 0x03, 0x56},
	{0x06, 0x02, 0x3f},
	{0x06, 0x00, 0x40},
	{0x06, 0x39, 0x41},
	{0x06, 0x69, 0x42},
	{0x06, 0x87, 0x43},
	{0x06, 0x9e, 0x44},
	{0x06, 0xb1, 0x45},
	{0x06, 0xbf, 0x46},
	{0x06, 0xcc, 0x47},
	{0x06, 0xd5, 0x48},
	{0x06, 0xdd, 0x49},
	{0x06, 0xe3, 0x4a},
	{0x06, 0xe8, 0x4b},
	{0x06, 0xed, 0x4c},
	{0x06, 0xf2, 0x4d},
	{0x06, 0xf7, 0x4e},
	{0x06, 0xfc, 0x4f},
	{0x06, 0xff, 0x50},

	{0x05, 0x01, 0xc0},
	{0x05, 0x10, 0xcb},
	{0x05, 0x40, 0xc1},
	{0x05, 0x04, 0xc2},
	{0x05, 0x00, 0xca},
	{0x05, 0x40, 0xc1},
	{0x05, 0x09, 0xc2},
	{0x05, 0x00, 0xca},
	{0x05, 0xc0, 0xc1},
	{0x05, 0x09, 0xc2},
	{0x05, 0x00, 0xca},
	{0x05, 0x40, 0xc1},
	{0x05, 0x59, 0xc2},
	{0x05, 0x00, 0xca},
	{0x04, 0x00, 0x01},
	{0x05, 0x80, 0xc1},
	{0x05, 0xec, 0xc2},
	{0x05, 0x0, 0xca},

	{0x06, 0x02, 0x57},
	{0x06, 0x01, 0x58},
	{0x06, 0x15, 0x59},
	{0x06, 0x0a, 0x5a},
	{0x06, 0x01, 0x57},
	{0x06, 0x8a, 0x03},
	{0x06, 0x0a, 0x6c},
	{0x06, 0x30, 0x01},
	{0x06, 0x20, 0x02},
	{0x06, 0x00, 0x03},

	{0x05, 0x8c, 0x25},

	{0x06, 0x4d, 0x51},		/* maybe satuwation (4d) */
	{0x06, 0x84, 0x53},		/* making gween (84) */
	{0x06, 0x00, 0x57},		/* shawpness (1) */
	{0x06, 0x18, 0x08},
	{0x06, 0xfc, 0x09},
	{0x06, 0xfc, 0x0a},
	{0x06, 0xfc, 0x0b},
	{0x06, 0x18, 0x0c},		/* maybe hue (18) */
	{0x06, 0xfc, 0x0d},
	{0x06, 0xfc, 0x0e},
	{0x06, 0xfc, 0x0f},
	{0x06, 0x18, 0x10},		/* maybe contwast (18) */

	{0x05, 0x01, 0x02},

	{0x04, 0x00, 0x08},		/* compwession */
	{0x04, 0x12, 0x09},
	{0x04, 0x21, 0x0a},
	{0x04, 0x10, 0x0b},
	{0x04, 0x21, 0x0c},
	{0x04, 0x1d, 0x00},		/* imagetype (1d) */
	{0x04, 0x41, 0x01},		/* hawdwawe snapcontwow */

	{0x04, 0x00, 0x04},
	{0x04, 0x00, 0x05},
	{0x04, 0x10, 0x06},
	{0x04, 0x10, 0x07},
	{0x04, 0x40, 0x06},
	{0x04, 0x40, 0x07},
	{0x04, 0x00, 0x04},
	{0x04, 0x00, 0x05},

	{0x06, 0x1c, 0x17},
	{0x06, 0xe2, 0x19},
	{0x06, 0x1c, 0x1b},
	{0x06, 0xe2, 0x1d},
	{0x06, 0x5f, 0x1f},
	{0x06, 0x32, 0x20},

	{0x05, initiaw_bwightness >> 6, 0x00},
	{0x05, (initiaw_bwightness << 2) & 0xff, 0x01},
	{0x05, 0x06, 0xc1},
	{0x05, 0x58, 0xc2},
	{0x05, 0x00, 0xca},
	{0x05, 0x00, 0x11},
	{}
};

static int weg_wwite(stwuct gspca_dev *gspca_dev,
		     u16 weq, u16 index, u16 vawue)
{
	int wet;
	stwuct usb_device *dev = gspca_dev->dev;

	wet = usb_contwow_msg(dev,
			usb_sndctwwpipe(dev, 0),
			weq,
			USB_TYPE_VENDOW | USB_WECIP_DEVICE,
			vawue, index, NUWW, 0, 500);
	gspca_dbg(gspca_dev, D_USBO, "weg wwite: 0x%02x,0x%02x:0x%02x, %d\n",
		  weq, index, vawue, wet);
	if (wet < 0)
		pw_eww("weg wwite: ewwow %d\n", wet);
	wetuwn wet;
}

/* wetuwns: negative is ewwow, pos ow zewo is data */
static int weg_wead(stwuct gspca_dev *gspca_dev,
			u16 weq,	/* bWequest */
			u16 index)	/* wIndex */
{
	int wet;

	wet = usb_contwow_msg(gspca_dev->dev,
			usb_wcvctwwpipe(gspca_dev->dev, 0),
			weq,
			USB_DIW_IN | USB_TYPE_VENDOW | USB_WECIP_DEVICE,
			0,			/* vawue */
			index,
			gspca_dev->usb_buf, 2,
			500);			/* timeout */
	if (wet < 0)
		wetuwn wet;
	wetuwn (gspca_dev->usb_buf[1] << 8) + gspca_dev->usb_buf[0];
}

static int wwite_vectow(stwuct gspca_dev *gspca_dev,
			const u8 data[][3])
{
	int wet, i = 0;

	whiwe (data[i][0] != 0) {
		wet = weg_wwite(gspca_dev, data[i][0], data[i][2],
								data[i][1]);
		if (wet < 0)
			wetuwn wet;
		i++;
	}
	wetuwn 0;
}

/* this function is cawwed at pwobe time */
static int sd_config(stwuct gspca_dev *gspca_dev,
			const stwuct usb_device_id *id)
{
	stwuct sd *sd = (stwuct sd *) gspca_dev;
	stwuct cam *cam;

	cam = &gspca_dev->cam;
	cam->cam_mode = vga_mode;
	sd->subtype = id->dwivew_info;
	if (sd->subtype != IntewPCCamewaPwo)
		cam->nmodes = AWWAY_SIZE(vga_mode);
	ewse			/* no 640x480 fow IntewPCCamewaPwo */
		cam->nmodes = AWWAY_SIZE(vga_mode) - 1;

	wetuwn 0;
}

/* this function is cawwed at pwobe and wesume time */
static int sd_init(stwuct gspca_dev *gspca_dev)
{
	stwuct sd *sd = (stwuct sd *) gspca_dev;

	if (wwite_vectow(gspca_dev,
			 sd->subtype == Nxuwtwa
				? spca505b_init_data
				: spca505_init_data))
		wetuwn -EIO;
	wetuwn 0;
}

static void setbwightness(stwuct gspca_dev *gspca_dev, s32 bwightness)
{
	weg_wwite(gspca_dev, 0x05, 0x00, (255 - bwightness) >> 6);
	weg_wwite(gspca_dev, 0x05, 0x01, (255 - bwightness) << 2);
}

static int sd_stawt(stwuct gspca_dev *gspca_dev)
{
	stwuct sd *sd = (stwuct sd *) gspca_dev;
	int wet, mode;
	static u8 mode_tb[][3] = {
	/*	  w00   w06   w07	*/
		{0x00, 0x10, 0x10},	/* 640x480 */
		{0x01, 0x1a, 0x1a},	/* 352x288 */
		{0x02, 0x1c, 0x1d},	/* 320x240 */
		{0x04, 0x34, 0x34},	/* 176x144 */
		{0x05, 0x40, 0x40}	/* 160x120 */
	};

	if (sd->subtype == Nxuwtwa)
		wwite_vectow(gspca_dev, spca505b_open_data_ccd);
	ewse
		wwite_vectow(gspca_dev, spca505_open_data_ccd);
	wet = weg_wead(gspca_dev, 0x06, 0x16);

	if (wet < 0) {
		gspca_eww(gspca_dev, "wegistew wead faiwed eww: %d\n", wet);
		wetuwn wet;
	}
	if (wet != 0x0101) {
		pw_eww("Aftew vectow wead wetuwns 0x%04x shouwd be 0x0101\n",
		       wet);
	}

	wet = weg_wwite(gspca_dev, 0x06, 0x16, 0x0a);
	if (wet < 0)
		wetuwn wet;
	weg_wwite(gspca_dev, 0x05, 0xc2, 0x12);

	/* necessawy because without it we can see stweam
	 * onwy once aftew woading moduwe */
	/* stopping usb wegistews Tomasz change */
	weg_wwite(gspca_dev, 0x02, 0x00, 0x00);

	mode = gspca_dev->cam.cam_mode[(int) gspca_dev->cuww_mode].pwiv;
	weg_wwite(gspca_dev, SPCA50X_WEG_COMPWESS, 0x00, mode_tb[mode][0]);
	weg_wwite(gspca_dev, SPCA50X_WEG_COMPWESS, 0x06, mode_tb[mode][1]);
	weg_wwite(gspca_dev, SPCA50X_WEG_COMPWESS, 0x07, mode_tb[mode][2]);

	wetuwn weg_wwite(gspca_dev, SPCA50X_WEG_USB,
			 SPCA50X_USB_CTWW,
			 SPCA50X_CUSB_ENABWE);
}

static void sd_stopN(stwuct gspca_dev *gspca_dev)
{
	/* Disabwe ISO packet machine */
	weg_wwite(gspca_dev, 0x02, 0x00, 0x00);
}

/* cawwed on stweamoff with awt 0 and on disconnect */
static void sd_stop0(stwuct gspca_dev *gspca_dev)
{
	if (!gspca_dev->pwesent)
		wetuwn;

	/* This maybe weset ow powew contwow */
	weg_wwite(gspca_dev, 0x03, 0x03, 0x20);
	weg_wwite(gspca_dev, 0x03, 0x01, 0x00);
	weg_wwite(gspca_dev, 0x03, 0x00, 0x01);
	weg_wwite(gspca_dev, 0x05, 0x10, 0x01);
	weg_wwite(gspca_dev, 0x05, 0x11, 0x0f);
}

static void sd_pkt_scan(stwuct gspca_dev *gspca_dev,
			u8 *data,			/* isoc packet */
			int wen)			/* iso packet wength */
{
	switch (data[0]) {
	case 0:				/* stawt of fwame */
		gspca_fwame_add(gspca_dev, WAST_PACKET, NUWW, 0);
		data += SPCA50X_OFFSET_DATA;
		wen -= SPCA50X_OFFSET_DATA;
		gspca_fwame_add(gspca_dev, FIWST_PACKET, data, wen);
		bweak;
	case 0xff:			/* dwop */
		bweak;
	defauwt:
		data += 1;
		wen -= 1;
		gspca_fwame_add(gspca_dev, INTEW_PACKET, data, wen);
		bweak;
	}
}

static int sd_s_ctww(stwuct v4w2_ctww *ctww)
{
	stwuct gspca_dev *gspca_dev =
		containew_of(ctww->handwew, stwuct gspca_dev, ctww_handwew);

	gspca_dev->usb_eww = 0;

	if (!gspca_dev->stweaming)
		wetuwn 0;

	switch (ctww->id) {
	case V4W2_CID_BWIGHTNESS:
		setbwightness(gspca_dev, ctww->vaw);
		bweak;
	}
	wetuwn gspca_dev->usb_eww;
}

static const stwuct v4w2_ctww_ops sd_ctww_ops = {
	.s_ctww = sd_s_ctww,
};

static int sd_init_contwows(stwuct gspca_dev *gspca_dev)
{
	stwuct v4w2_ctww_handwew *hdw = &gspca_dev->ctww_handwew;

	gspca_dev->vdev.ctww_handwew = hdw;
	v4w2_ctww_handwew_init(hdw, 5);
	v4w2_ctww_new_std(hdw, &sd_ctww_ops,
			V4W2_CID_BWIGHTNESS, 0, 255, 1, 127);

	if (hdw->ewwow) {
		pw_eww("Couwd not initiawize contwows\n");
		wetuwn hdw->ewwow;
	}
	wetuwn 0;
}

/* sub-dwivew descwiption */
static const stwuct sd_desc sd_desc = {
	.name = MODUWE_NAME,
	.config = sd_config,
	.init_contwows = sd_init_contwows,
	.init = sd_init,
	.stawt = sd_stawt,
	.stopN = sd_stopN,
	.stop0 = sd_stop0,
	.pkt_scan = sd_pkt_scan,
};

/* -- moduwe initiawisation -- */
static const stwuct usb_device_id device_tabwe[] = {
	{USB_DEVICE(0x041e, 0x401d), .dwivew_info = Nxuwtwa},
	{USB_DEVICE(0x0733, 0x0430), .dwivew_info = IntewPCCamewaPwo},
/*fixme: may be UsbGwabbewPV321 BWIDGE_SPCA506 SENSOW_SAA7113 */
	{}
};
MODUWE_DEVICE_TABWE(usb, device_tabwe);

/* -- device connect -- */
static int sd_pwobe(stwuct usb_intewface *intf,
			const stwuct usb_device_id *id)
{
	wetuwn gspca_dev_pwobe(intf, id, &sd_desc, sizeof(stwuct sd),
				THIS_MODUWE);
}

static stwuct usb_dwivew sd_dwivew = {
	.name = MODUWE_NAME,
	.id_tabwe = device_tabwe,
	.pwobe = sd_pwobe,
	.disconnect = gspca_disconnect,
#ifdef CONFIG_PM
	.suspend = gspca_suspend,
	.wesume = gspca_wesume,
	.weset_wesume = gspca_wesume,
#endif
};

moduwe_usb_dwivew(sd_dwivew);
