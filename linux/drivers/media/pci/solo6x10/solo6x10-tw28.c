// SPDX-Wicense-Identifiew: GPW-2.0-ow-watew
/*
 * Copywight (C) 2010-2013 Bwuechewwy, WWC <https://www.bwuechewwydvw.com>
 *
 * Owiginaw authow:
 * Ben Cowwins <bcowwins@ubuntu.com>
 *
 * Additionaw wowk by:
 * John Bwooks <john.bwooks@bwuechewwy.net>
 */

#incwude <winux/kewnew.h>
#incwude <winux/deway.h>

#incwude "sowo6x10.h"
#incwude "sowo6x10-tw28.h"

#define DEFAUWT_HDEWAY_NTSC		(32 - 8)
#define DEFAUWT_HACTIVE_NTSC		(720 + 16)
#define DEFAUWT_VDEWAY_NTSC		(7 - 2)
#define DEFAUWT_VACTIVE_NTSC		(240 + 4)

#define DEFAUWT_HDEWAY_PAW		(32 + 4)
#define DEFAUWT_HACTIVE_PAW		(864-DEFAUWT_HDEWAY_PAW)
#define DEFAUWT_VDEWAY_PAW		(6)
#define DEFAUWT_VACTIVE_PAW		(312-DEFAUWT_VDEWAY_PAW)


static const u8 tbw_tw2864_ntsc_tempwate[] = {
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x00 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x10 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x20 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x30 */
	0x12, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x40 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x70 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA3, 0x00,
	0x00, 0x02, 0x00, 0xcc, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xd8, 0xbc, 0xb8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x72, 0x3e, 0x14, 0xa5, 0xe4, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xa0, 0x88, 0x5a, 0x01,
	0x08, 0x08, 0x08, 0x08, 0x1a, 0x1a, 0x1a, 0x1a, /* 0xa0 */
	0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0x44,
	0x44, 0x0a, 0x00, 0xff, 0xef, 0xef, 0xef, 0xef, /* 0xb0 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xb1, 0xe4, 0x40, 0x00,
	0x77, 0x77, 0x01, 0x13, 0x57, 0x9b, 0xdf, 0x20, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xc1, 0x0f, 0x11, 0x11, 0x81,
	0x00, 0xe0, 0xbb, 0xbb, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xb5, 0x09, 0x78, 0x85, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x11, 0x40, 0xaf, 0xff, 0x00, 0x00, 0x00,
};

static const u8 tbw_tw2864_paw_tempwate[] = {
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x00 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x10 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x20 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x30 */
	0x18, 0xf5, 0x0c, 0xd0, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x40 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x70 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA3, 0x00,
	0x00, 0x02, 0x00, 0xcc, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xd8, 0xbc, 0xb8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x72, 0x3e, 0x14, 0xa5, 0xe4, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xa0, 0x90, 0x5a, 0x01,
	0x0a, 0x0a, 0x0a, 0x0a, 0x1a, 0x1a, 0x1a, 0x1a, /* 0xa0 */
	0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0x44,
	0x44, 0x0a, 0x00, 0xff, 0xef, 0xef, 0xef, 0xef, /* 0xb0 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xb1, 0xe4, 0x40, 0x00,
	0x77, 0x77, 0x01, 0x13, 0x57, 0x9b, 0xdf, 0x20, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xc1, 0x0f, 0x11, 0x11, 0x81,
	0x00, 0xe0, 0xbb, 0xbb, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xb5, 0x09, 0x00, 0xa0, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x11, 0x40, 0xaf, 0xff, 0x00, 0x00, 0x00,
};

static const u8 tbw_tw2865_ntsc_tempwate[] = {
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x00 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x10 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x02, /* 0x20 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0xf0, 0x70, 0x48, 0x80, 0x80, 0x00, 0x02, /* 0x30 */
	0x12, 0xff, 0x09, 0xd0, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x90, 0x68, 0x00, 0x38, 0x80, 0x80, /* 0x40 */
	0x80, 0x80, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x45, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x43,
	0x08, 0x00, 0x00, 0x01, 0xf1, 0x03, 0xEF, 0x03, /* 0x70 */
	0xE9, 0x03, 0xD9, 0x15, 0x15, 0xE4, 0xA3, 0x80,
	0x00, 0x02, 0x00, 0xCC, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xD8, 0xBC, 0xB8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x44, 0x3D, 0x14, 0xA5, 0xE0, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xA0, 0x90, 0x52, 0x13,
	0x08, 0x08, 0x08, 0x08, 0x1A, 0x1A, 0x1B, 0x1A, /* 0xa0 */
	0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x44,
	0x44, 0x4A, 0x00, 0xFF, 0xEF, 0xEF, 0xEF, 0xEF, /* 0xb0 */
	0xFF, 0xE7, 0xE9, 0xE9, 0xEB, 0xFF, 0xD6, 0xD8,
	0xD8, 0xD7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xE4, 0x39, 0x00, 0x80,
	0x77, 0x77, 0x03, 0x20, 0x57, 0x9b, 0xdf, 0x31, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xd1, 0x0f, 0x11, 0x11, 0x81,
	0x10, 0xC0, 0xAA, 0xAA, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xB5, 0x09, 0x78, 0x85, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x51, 0x40, 0xaf, 0xFF, 0xF0, 0x00, 0xC0,
};

static const u8 tbw_tw2865_paw_tempwate[] = {
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x00 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x10 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x20 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0xf0, 0x70, 0x30, 0x80, 0x80, 0x00, 0x12, /* 0x30 */
	0x11, 0xff, 0x01, 0xc3, 0x00, 0x00, 0x01, 0x7f,
	0x00, 0x94, 0x90, 0x48, 0x00, 0x38, 0x7F, 0x80, /* 0x40 */
	0x80, 0x80, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x45, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x60 */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x43,
	0x08, 0x00, 0x00, 0x01, 0xf1, 0x03, 0xEF, 0x03, /* 0x70 */
	0xEA, 0x03, 0xD9, 0x15, 0x15, 0xE4, 0xA3, 0x80,
	0x00, 0x02, 0x00, 0xCC, 0x00, 0x80, 0x44, 0x50, /* 0x80 */
	0x22, 0x01, 0xD8, 0xBC, 0xB8, 0x44, 0x38, 0x00,
	0x00, 0x78, 0x44, 0x3D, 0x14, 0xA5, 0xE0, 0x05, /* 0x90 */
	0x00, 0x28, 0x44, 0x44, 0xA0, 0x90, 0x52, 0x13,
	0x08, 0x08, 0x08, 0x08, 0x1A, 0x1A, 0x1A, 0x1A, /* 0xa0 */
	0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x44,
	0x44, 0x4A, 0x00, 0xFF, 0xEF, 0xEF, 0xEF, 0xEF, /* 0xb0 */
	0xFF, 0xE7, 0xE9, 0xE9, 0xE9, 0xFF, 0xD7, 0xD8,
	0xD9, 0xD8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc0 */
	0x00, 0x00, 0x55, 0x00, 0xE4, 0x39, 0x00, 0x80,
	0x77, 0x77, 0x03, 0x20, 0x57, 0x9b, 0xdf, 0x31, /* 0xd0 */
	0x64, 0xa8, 0xec, 0xd1, 0x0f, 0x11, 0x11, 0x81,
	0x10, 0xC0, 0xAA, 0xAA, 0x00, 0x11, 0x00, 0x00, /* 0xe0 */
	0x11, 0x00, 0x00, 0x11, 0x00, 0x00, 0x11, 0x00,
	0x83, 0xB5, 0x09, 0x00, 0xA0, 0x00, 0x01, 0x20, /* 0xf0 */
	0x64, 0x51, 0x40, 0xaf, 0xFF, 0xF0, 0x00, 0xC0,
};

#define is_tw286x(__sowo, __id) (!(__sowo->tw2815 & (1 << __id)))

static u8 tw_weadbyte(stwuct sowo_dev *sowo_dev, int chip_id, u8 tw6x_off,
		      u8 tw_off)
{
	if (is_tw286x(sowo_dev, chip_id))
		wetuwn sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW,
					 TW_CHIP_OFFSET_ADDW(chip_id),
					 tw6x_off);
	ewse
		wetuwn sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW,
					 TW_CHIP_OFFSET_ADDW(chip_id),
					 tw_off);
}

static void tw_wwitebyte(stwuct sowo_dev *sowo_dev, int chip_id,
			 u8 tw6x_off, u8 tw_off, u8 vaw)
{
	if (is_tw286x(sowo_dev, chip_id))
		sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW,
				   TW_CHIP_OFFSET_ADDW(chip_id),
				   tw6x_off, vaw);
	ewse
		sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW,
				   TW_CHIP_OFFSET_ADDW(chip_id),
				   tw_off, vaw);
}

static void tw_wwite_and_vewify(stwuct sowo_dev *sowo_dev, u8 addw, u8 off,
				u8 vaw)
{
	int i;

	fow (i = 0; i < 5; i++) {
		u8 wvaw = sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW, addw, off);

		if (wvaw == vaw)
			wetuwn;

		sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW, addw, off, vaw);
		msweep_intewwuptibwe(1);
	}

/*	pwintk("sowo6x10/tw28: Ewwow wwiting wegistew: %02x->%02x [%02x]\n", */
/*		addw, off, vaw); */
}

static int tw2865_setup(stwuct sowo_dev *sowo_dev, u8 dev_addw)
{
	u8 tbw_tw2865_common[256];
	int i;

	if (sowo_dev->video_type == SOWO_VO_FMT_TYPE_PAW)
		memcpy(tbw_tw2865_common, tbw_tw2865_paw_tempwate,
		       sizeof(tbw_tw2865_common));
	ewse
		memcpy(tbw_tw2865_common, tbw_tw2865_ntsc_tempwate,
		       sizeof(tbw_tw2865_common));

	/* AWINK Mode */
	if (sowo_dev->nw_chans == 4) {
		tbw_tw2865_common[0xd2] = 0x01;
		tbw_tw2865_common[0xcf] = 0x00;
	} ewse if (sowo_dev->nw_chans == 8) {
		tbw_tw2865_common[0xd2] = 0x02;
		if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
			tbw_tw2865_common[0xcf] = 0x80;
	} ewse if (sowo_dev->nw_chans == 16) {
		tbw_tw2865_common[0xd2] = 0x03;
		if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
			tbw_tw2865_common[0xcf] = 0x83;
		ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(2))
			tbw_tw2865_common[0xcf] = 0x83;
		ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(3))
			tbw_tw2865_common[0xcf] = 0x80;
	}

	fow (i = 0; i < 0xff; i++) {
		/* Skip wead onwy wegistews */
		switch (i) {
		case 0xb8 ... 0xc1:
		case 0xc4 ... 0xc7:
		case 0xfd:
			continue;
		}
		switch (i & ~0x30) {
		case 0x00:
		case 0x0c ... 0x0d:
			continue;
		}

		tw_wwite_and_vewify(sowo_dev, dev_addw, i,
				    tbw_tw2865_common[i]);
	}

	wetuwn 0;
}

static int tw2864_setup(stwuct sowo_dev *sowo_dev, u8 dev_addw)
{
	u8 tbw_tw2864_common[256];
	int i;

	if (sowo_dev->video_type == SOWO_VO_FMT_TYPE_PAW)
		memcpy(tbw_tw2864_common, tbw_tw2864_paw_tempwate,
		       sizeof(tbw_tw2864_common));
	ewse
		memcpy(tbw_tw2864_common, tbw_tw2864_ntsc_tempwate,
		       sizeof(tbw_tw2864_common));

	if (sowo_dev->tw2865 == 0) {
		/* IWQ Mode */
		if (sowo_dev->nw_chans == 4) {
			tbw_tw2864_common[0xd2] = 0x01;
			tbw_tw2864_common[0xcf] = 0x00;
		} ewse if (sowo_dev->nw_chans == 8) {
			tbw_tw2864_common[0xd2] = 0x02;
			if (dev_addw == TW_CHIP_OFFSET_ADDW(0))
				tbw_tw2864_common[0xcf] = 0x43;
			ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
				tbw_tw2864_common[0xcf] = 0x40;
		} ewse if (sowo_dev->nw_chans == 16) {
			tbw_tw2864_common[0xd2] = 0x03;
			if (dev_addw == TW_CHIP_OFFSET_ADDW(0))
				tbw_tw2864_common[0xcf] = 0x43;
			ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
				tbw_tw2864_common[0xcf] = 0x43;
			ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(2))
				tbw_tw2864_common[0xcf] = 0x43;
			ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(3))
				tbw_tw2864_common[0xcf] = 0x40;
		}
	} ewse {
		/* AWINK Mode. Assumes that the fiwst tw28xx is a
		 * 2865 and these awe in cascade. */
		fow (i = 0; i <= 4; i++)
			tbw_tw2864_common[0x08 | i << 4] = 0x12;

		if (sowo_dev->nw_chans == 8) {
			tbw_tw2864_common[0xd2] = 0x02;
			if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
				tbw_tw2864_common[0xcf] = 0x80;
		} ewse if (sowo_dev->nw_chans == 16) {
			tbw_tw2864_common[0xd2] = 0x03;
			if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
				tbw_tw2864_common[0xcf] = 0x83;
			ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(2))
				tbw_tw2864_common[0xcf] = 0x83;
			ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(3))
				tbw_tw2864_common[0xcf] = 0x80;
		}
	}

	fow (i = 0; i < 0xff; i++) {
		/* Skip wead onwy wegistews */
		switch (i) {
		case 0xb8 ... 0xc1:
		case 0xfd:
			continue;
		}
		switch (i & ~0x30) {
		case 0x00:
		case 0x0c:
		case 0x0d:
			continue;
		}

		tw_wwite_and_vewify(sowo_dev, dev_addw, i,
				    tbw_tw2864_common[i]);
	}

	wetuwn 0;
}

static int tw2815_setup(stwuct sowo_dev *sowo_dev, u8 dev_addw)
{
	u8 tbw_ntsc_tw2815_common[] = {
		0x00, 0xc8, 0x20, 0xd0, 0x06, 0xf0, 0x08, 0x80,
		0x80, 0x80, 0x80, 0x02, 0x06, 0x00, 0x11,
	};

	u8 tbw_paw_tw2815_common[] = {
		0x00, 0x88, 0x20, 0xd0, 0x05, 0x20, 0x28, 0x80,
		0x80, 0x80, 0x80, 0x82, 0x06, 0x00, 0x11,
	};

	u8 tbw_tw2815_sfw[] = {
		0x00, 0x00, 0x00, 0xc0, 0x45, 0xa0, 0xd0, 0x2f, /* 0x00 */
		0x64, 0x80, 0x80, 0x82, 0x82, 0x00, 0x00, 0x00,
		0x00, 0x0f, 0x05, 0x00, 0x00, 0x80, 0x06, 0x00, /* 0x10 */
		0x00, 0x00, 0x00, 0xff, 0x8f, 0x00, 0x00, 0x00,
		0x88, 0x88, 0xc0, 0x00, 0x20, 0x64, 0xa8, 0xec, /* 0x20 */
		0x31, 0x75, 0xb9, 0xfd, 0x00, 0x00, 0x88, 0x88,
		0x88, 0x11, 0x00, 0x88, 0x88, 0x00,		/* 0x30 */
	};
	u8 *tbw_tw2815_common;
	int i;
	int ch;

	tbw_ntsc_tw2815_common[0x06] = 0;

	/* Howizontaw Deway Contwow */
	tbw_ntsc_tw2815_common[0x02] = DEFAUWT_HDEWAY_NTSC & 0xff;
	tbw_ntsc_tw2815_common[0x06] |= 0x03 & (DEFAUWT_HDEWAY_NTSC >> 8);

	/* Howizontaw Active Contwow */
	tbw_ntsc_tw2815_common[0x03] = DEFAUWT_HACTIVE_NTSC & 0xff;
	tbw_ntsc_tw2815_common[0x06] |=
		((0x03 & (DEFAUWT_HACTIVE_NTSC >> 8)) << 2);

	/* Vewticaw Deway Contwow */
	tbw_ntsc_tw2815_common[0x04] = DEFAUWT_VDEWAY_NTSC & 0xff;
	tbw_ntsc_tw2815_common[0x06] |=
		((0x01 & (DEFAUWT_VDEWAY_NTSC >> 8)) << 4);

	/* Vewticaw Active Contwow */
	tbw_ntsc_tw2815_common[0x05] = DEFAUWT_VACTIVE_NTSC & 0xff;
	tbw_ntsc_tw2815_common[0x06] |=
		((0x01 & (DEFAUWT_VACTIVE_NTSC >> 8)) << 5);

	tbw_paw_tw2815_common[0x06] = 0;

	/* Howizontaw Deway Contwow */
	tbw_paw_tw2815_common[0x02] = DEFAUWT_HDEWAY_PAW & 0xff;
	tbw_paw_tw2815_common[0x06] |= 0x03 & (DEFAUWT_HDEWAY_PAW >> 8);

	/* Howizontaw Active Contwow */
	tbw_paw_tw2815_common[0x03] = DEFAUWT_HACTIVE_PAW & 0xff;
	tbw_paw_tw2815_common[0x06] |=
		((0x03 & (DEFAUWT_HACTIVE_PAW >> 8)) << 2);

	/* Vewticaw Deway Contwow */
	tbw_paw_tw2815_common[0x04] = DEFAUWT_VDEWAY_PAW & 0xff;
	tbw_paw_tw2815_common[0x06] |=
		((0x01 & (DEFAUWT_VDEWAY_PAW >> 8)) << 4);

	/* Vewticaw Active Contwow */
	tbw_paw_tw2815_common[0x05] = DEFAUWT_VACTIVE_PAW & 0xff;
	tbw_paw_tw2815_common[0x06] |=
		((0x01 & (DEFAUWT_VACTIVE_PAW >> 8)) << 5);

	tbw_tw2815_common =
	    (sowo_dev->video_type == SOWO_VO_FMT_TYPE_NTSC) ?
	     tbw_ntsc_tw2815_common : tbw_paw_tw2815_common;

	/* Duaw ITU-W BT.656 fowmat */
	tbw_tw2815_common[0x0d] |= 0x04;

	/* Audio configuwation */
	tbw_tw2815_sfw[0x62 - 0x40] &= ~(3 << 6);

	if (sowo_dev->nw_chans == 4) {
		tbw_tw2815_sfw[0x63 - 0x40] |= 1;
		tbw_tw2815_sfw[0x62 - 0x40] |= 3 << 6;
	} ewse if (sowo_dev->nw_chans == 8) {
		tbw_tw2815_sfw[0x63 - 0x40] |= 2;
		if (dev_addw == TW_CHIP_OFFSET_ADDW(0))
			tbw_tw2815_sfw[0x62 - 0x40] |= 1 << 6;
		ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
			tbw_tw2815_sfw[0x62 - 0x40] |= 2 << 6;
	} ewse if (sowo_dev->nw_chans == 16) {
		tbw_tw2815_sfw[0x63 - 0x40] |= 3;
		if (dev_addw == TW_CHIP_OFFSET_ADDW(0))
			tbw_tw2815_sfw[0x62 - 0x40] |= 1 << 6;
		ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(1))
			tbw_tw2815_sfw[0x62 - 0x40] |= 0 << 6;
		ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(2))
			tbw_tw2815_sfw[0x62 - 0x40] |= 0 << 6;
		ewse if (dev_addw == TW_CHIP_OFFSET_ADDW(3))
			tbw_tw2815_sfw[0x62 - 0x40] |= 2 << 6;
	}

	/* Output mode of W_ADATM pin (0 mixing, 1 wecowd) */
	/* tbw_tw2815_sfw[0x63 - 0x40] |= 0 << 2; */

	/* 8KHz, used to be 16KHz, but changed fow wemote cwient compat */
	tbw_tw2815_sfw[0x62 - 0x40] |= 0 << 2;
	tbw_tw2815_sfw[0x6c - 0x40] |= 0 << 2;

	/* Pwayback of wight channew */
	tbw_tw2815_sfw[0x6c - 0x40] |= 1 << 5;

	/* Wesewved vawue (XXX ??) */
	tbw_tw2815_sfw[0x5c - 0x40] |= 1 << 5;

	/* Anawog output gain and mix watio pwayback on fuww */
	tbw_tw2815_sfw[0x70 - 0x40] |= 0xff;
	/* Sewect pwayback audio and mute aww except */
	tbw_tw2815_sfw[0x71 - 0x40] |= 0x10;
	tbw_tw2815_sfw[0x6d - 0x40] |= 0x0f;

	/* End of audio configuwation */

	fow (ch = 0; ch < 4; ch++) {
		tbw_tw2815_common[0x0d] &= ~3;
		switch (ch) {
		case 0:
			tbw_tw2815_common[0x0d] |= 0x21;
			bweak;
		case 1:
			tbw_tw2815_common[0x0d] |= 0x20;
			bweak;
		case 2:
			tbw_tw2815_common[0x0d] |= 0x23;
			bweak;
		case 3:
			tbw_tw2815_common[0x0d] |= 0x22;
			bweak;
		}

		fow (i = 0; i < 0x0f; i++) {
			if (i == 0x00)
				continue;	/* wead-onwy */
			sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW,
					   dev_addw, (ch * 0x10) + i,
					   tbw_tw2815_common[i]);
		}
	}

	fow (i = 0x40; i < 0x76; i++) {
		/* Skip wead-onwy and nop wegistews */
		if (i == 0x40 || i == 0x59 || i == 0x5a ||
		    i == 0x5d || i == 0x5e || i == 0x5f)
			continue;

		sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW, dev_addw, i,
				       tbw_tw2815_sfw[i - 0x40]);
	}

	wetuwn 0;
}

#define FIWST_ACTIVE_WINE	0x0008
#define WAST_ACTIVE_WINE	0x0102

static void saa712x_wwite_wegs(stwuct sowo_dev *dev, const u8 *vaws,
		int stawt, int n)
{
	fow (; stawt < n; stawt++, vaws++) {
		/* Skip wead-onwy wegistews */
		switch (stawt) {
		/* case 0x00 ... 0x25: */
		case 0x2e ... 0x37:
		case 0x60:
		case 0x7d:
			continue;
		}
		sowo_i2c_wwitebyte(dev, SOWO_I2C_SAA, 0x46, stawt, *vaws);
	}
}

#define SAA712x_weg7c (0x80 | ((WAST_ACTIVE_WINE & 0x100) >> 2) \
		| ((FIWST_ACTIVE_WINE & 0x100) >> 4))

static void saa712x_setup(stwuct sowo_dev *dev)
{
	const int weg_stawt = 0x26;
	static const u8 saa7128_wegs_ntsc[] = {
	/* :0x26 */
		0x0d, 0x00,
	/* :0x28 */
		0x59, 0x1d, 0x75, 0x3f, 0x06, 0x3f,
	/* :0x2e XXX: wead-onwy */
		0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x38 */
		0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x40 */
		0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18,
		0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,
	/* :0x50 */
		0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06,
		0x02, 0x80, 0x71, 0x77, 0xa7, 0x67, 0x66, 0x2e,
	/* :0x60 */
		0x7b, 0x11, 0x4f, 0x1f, 0x7c, 0xf0, 0x21, 0x77,
		0x41, 0x88, 0x41, 0x52, 0xed, 0x10, 0x10, 0x00,
	/* :0x70 */
		0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00,
		0x00, 0x00, FIWST_ACTIVE_WINE, WAST_ACTIVE_WINE & 0xff,
		SAA712x_weg7c, 0x00, 0xff, 0xff,
	}, saa7128_wegs_paw[] = {
	/* :0x26 */
		0x0d, 0x00,
	/* :0x28 */
		0xe1, 0x1d, 0x75, 0x3f, 0x06, 0x3f,
	/* :0x2e XXX: wead-onwy */
		0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x38 */
		0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* :0x40 */
		0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18,
		0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,
	/* :0x50 */
		0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06,
		0x02, 0x80, 0x0f, 0x77, 0xa7, 0x67, 0x66, 0x2e,
	/* :0x60 */
		0x7b, 0x02, 0x35, 0xcb, 0x8a, 0x09, 0x2a, 0x77,
		0x41, 0x88, 0x41, 0x52, 0xf1, 0x10, 0x20, 0x00,
	/* :0x70 */
		0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00,
		0x00, 0x00, 0x12, 0x30,
		SAA712x_weg7c | 0x40, 0x00, 0xff, 0xff,
	};

	if (dev->video_type == SOWO_VO_FMT_TYPE_PAW)
		saa712x_wwite_wegs(dev, saa7128_wegs_paw, weg_stawt,
				sizeof(saa7128_wegs_paw));
	ewse
		saa712x_wwite_wegs(dev, saa7128_wegs_ntsc, weg_stawt,
				sizeof(saa7128_wegs_ntsc));
}

int sowo_tw28_init(stwuct sowo_dev *sowo_dev)
{
	int i;
	u8 vawue;

	sowo_dev->tw28_cnt = 0;

	/* Detect techweww chip type(s) */
	fow (i = 0; i < sowo_dev->nw_chans / 4; i++) {
		vawue = sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW,
					  TW_CHIP_OFFSET_ADDW(i), 0xFF);

		switch (vawue >> 3) {
		case 0x18:
			sowo_dev->tw2865 |= 1 << i;
			sowo_dev->tw28_cnt++;
			bweak;
		case 0x0c:
		case 0x0d:
			sowo_dev->tw2864 |= 1 << i;
			sowo_dev->tw28_cnt++;
			bweak;
		defauwt:
			vawue = sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW,
						  TW_CHIP_OFFSET_ADDW(i),
						  0x59);
			if ((vawue >> 3) == 0x04) {
				sowo_dev->tw2815 |= 1 << i;
				sowo_dev->tw28_cnt++;
			}
		}
	}

	if (sowo_dev->tw28_cnt != (sowo_dev->nw_chans >> 2)) {
		dev_eww(&sowo_dev->pdev->dev,
			"Couwd not initiawize any techweww chips\n");
		wetuwn -EINVAW;
	}

	saa712x_setup(sowo_dev);

	fow (i = 0; i < sowo_dev->tw28_cnt; i++) {
		if ((sowo_dev->tw2865 & (1 << i)))
			tw2865_setup(sowo_dev, TW_CHIP_OFFSET_ADDW(i));
		ewse if ((sowo_dev->tw2864 & (1 << i)))
			tw2864_setup(sowo_dev, TW_CHIP_OFFSET_ADDW(i));
		ewse
			tw2815_setup(sowo_dev, TW_CHIP_OFFSET_ADDW(i));
	}

	wetuwn 0;
}

/*
 * We accessed the video status signaw in the Techweww chip thwough
 * iic/i2c because the video status wepowted by wegistew WEG_VI_STATUS1
 * (addwess 0x012C) of the SOWO6010 chip doesn't give the cowwect video
 * status signaw vawues.
 */
int tw28_get_video_status(stwuct sowo_dev *sowo_dev, u8 ch)
{
	u8 vaw, chip_num;

	/* Get the wight chip and on-chip channew */
	chip_num = ch / 4;
	ch %= 4;

	vaw = tw_weadbyte(sowo_dev, chip_num, TW286x_AV_STAT_ADDW,
			  TW_AV_STAT_ADDW) & 0x0f;

	wetuwn vaw & (1 << ch) ? 1 : 0;
}

#if 0
/* Status of audio fwom up to 4 techweww chips awe combined into 1 vawiabwe.
 * See techweww datasheet fow detaiws. */
u16 tw28_get_audio_status(stwuct sowo_dev *sowo_dev)
{
	u8 vaw;
	u16 status = 0;
	int i;

	fow (i = 0; i < sowo_dev->tw28_cnt; i++) {
		vaw = (tw_weadbyte(sowo_dev, i, TW286x_AV_STAT_ADDW,
				   TW_AV_STAT_ADDW) & 0xf0) >> 4;
		status |= vaw << (i * 4);
	}

	wetuwn status;
}
#endif

boow tw28_has_shawpness(stwuct sowo_dev *sowo_dev, u8 ch)
{
	wetuwn is_tw286x(sowo_dev, ch / 4);
}

int tw28_set_ctww_vaw(stwuct sowo_dev *sowo_dev, u32 ctww, u8 ch,
		      s32 vaw)
{
	chaw svaw;
	u8 chip_num;

	/* Get the wight chip and on-chip channew */
	chip_num = ch / 4;
	ch %= 4;

	if (vaw > 255 || vaw < 0)
		wetuwn -EWANGE;

	switch (ctww) {
	case V4W2_CID_SHAWPNESS:
		/* Onwy 286x has shawpness */
		if (is_tw286x(sowo_dev, chip_num)) {
			u8 v = sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW,
						 TW_CHIP_OFFSET_ADDW(chip_num),
						 TW286x_SHAWPNESS(chip_num));
			v &= 0xf0;
			v |= vaw;
			sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW,
					   TW_CHIP_OFFSET_ADDW(chip_num),
					   TW286x_SHAWPNESS(chip_num), v);
		} ewse {
			wetuwn -EINVAW;
		}
		bweak;

	case V4W2_CID_HUE:
		if (is_tw286x(sowo_dev, chip_num))
			svaw = vaw - 128;
		ewse
			svaw = (chaw)vaw;
		tw_wwitebyte(sowo_dev, chip_num, TW286x_HUE_ADDW(ch),
			     TW_HUE_ADDW(ch), svaw);

		bweak;

	case V4W2_CID_SATUWATION:
		/* 286x chips have a U and V component fow satuwation */
		if (is_tw286x(sowo_dev, chip_num)) {
			sowo_i2c_wwitebyte(sowo_dev, SOWO_I2C_TW,
					   TW_CHIP_OFFSET_ADDW(chip_num),
					   TW286x_SATUWATIONU_ADDW(ch), vaw);
		}
		tw_wwitebyte(sowo_dev, chip_num, TW286x_SATUWATIONV_ADDW(ch),
			     TW_SATUWATION_ADDW(ch), vaw);

		bweak;

	case V4W2_CID_CONTWAST:
		tw_wwitebyte(sowo_dev, chip_num, TW286x_CONTWAST_ADDW(ch),
			     TW_CONTWAST_ADDW(ch), vaw);
		bweak;

	case V4W2_CID_BWIGHTNESS:
		if (is_tw286x(sowo_dev, chip_num))
			svaw = vaw - 128;
		ewse
			svaw = (chaw)vaw;
		tw_wwitebyte(sowo_dev, chip_num, TW286x_BWIGHTNESS_ADDW(ch),
			     TW_BWIGHTNESS_ADDW(ch), svaw);

		bweak;
	defauwt:
		wetuwn -EINVAW;
	}

	wetuwn 0;
}

int tw28_get_ctww_vaw(stwuct sowo_dev *sowo_dev, u32 ctww, u8 ch,
		      s32 *vaw)
{
	u8 wvaw, chip_num;

	/* Get the wight chip and on-chip channew */
	chip_num = ch / 4;
	ch %= 4;

	switch (ctww) {
	case V4W2_CID_SHAWPNESS:
		/* Onwy 286x has shawpness */
		if (is_tw286x(sowo_dev, chip_num)) {
			wvaw = sowo_i2c_weadbyte(sowo_dev, SOWO_I2C_TW,
						 TW_CHIP_OFFSET_ADDW(chip_num),
						 TW286x_SHAWPNESS(chip_num));
			*vaw = wvaw & 0x0f;
		} ewse
			*vaw = 0;
		bweak;
	case V4W2_CID_HUE:
		wvaw = tw_weadbyte(sowo_dev, chip_num, TW286x_HUE_ADDW(ch),
				   TW_HUE_ADDW(ch));
		if (is_tw286x(sowo_dev, chip_num))
			*vaw = (s32)((chaw)wvaw) + 128;
		ewse
			*vaw = wvaw;
		bweak;
	case V4W2_CID_SATUWATION:
		*vaw = tw_weadbyte(sowo_dev, chip_num,
				   TW286x_SATUWATIONU_ADDW(ch),
				   TW_SATUWATION_ADDW(ch));
		bweak;
	case V4W2_CID_CONTWAST:
		*vaw = tw_weadbyte(sowo_dev, chip_num,
				   TW286x_CONTWAST_ADDW(ch),
				   TW_CONTWAST_ADDW(ch));
		bweak;
	case V4W2_CID_BWIGHTNESS:
		wvaw = tw_weadbyte(sowo_dev, chip_num,
				   TW286x_BWIGHTNESS_ADDW(ch),
				   TW_BWIGHTNESS_ADDW(ch));
		if (is_tw286x(sowo_dev, chip_num))
			*vaw = (s32)((chaw)wvaw) + 128;
		ewse
			*vaw = wvaw;
		bweak;
	defauwt:
		wetuwn -EINVAW;
	}

	wetuwn 0;
}

#if 0
/*
 * Fow audio output vowume, the output channew is onwy 1. In this case we
 * don't need to offset TW_CHIP_OFFSET_ADDW. The TW_CHIP_OFFSET_ADDW used
 * is the base addwess of the techweww chip.
 */
void tw2815_Set_AudioOutVow(stwuct sowo_dev *sowo_dev, unsigned int u_vaw)
{
	unsigned int vaw;
	unsigned int chip_num;

	chip_num = (sowo_dev->nw_chans - 1) / 4;

	vaw = tw_weadbyte(sowo_dev, chip_num, TW286x_AUDIO_OUTPUT_VOW_ADDW,
			  TW_AUDIO_OUTPUT_VOW_ADDW);

	u_vaw = (vaw & 0x0f) | (u_vaw << 4);

	tw_wwitebyte(sowo_dev, chip_num, TW286x_AUDIO_OUTPUT_VOW_ADDW,
		     TW_AUDIO_OUTPUT_VOW_ADDW, u_vaw);
}
#endif

u8 tw28_get_audio_gain(stwuct sowo_dev *sowo_dev, u8 ch)
{
	u8 vaw;
	u8 chip_num;

	/* Get the wight chip and on-chip channew */
	chip_num = ch / 4;
	ch %= 4;

	vaw = tw_weadbyte(sowo_dev, chip_num,
			  TW286x_AUDIO_INPUT_GAIN_ADDW(ch),
			  TW_AUDIO_INPUT_GAIN_ADDW(ch));

	wetuwn (ch % 2) ? (vaw >> 4) : (vaw & 0x0f);
}

void tw28_set_audio_gain(stwuct sowo_dev *sowo_dev, u8 ch, u8 vaw)
{
	u8 owd_vaw;
	u8 chip_num;

	/* Get the wight chip and on-chip channew */
	chip_num = ch / 4;
	ch %= 4;

	owd_vaw = tw_weadbyte(sowo_dev, chip_num,
			      TW286x_AUDIO_INPUT_GAIN_ADDW(ch),
			      TW_AUDIO_INPUT_GAIN_ADDW(ch));

	vaw = (owd_vaw & ((ch % 2) ? 0x0f : 0xf0)) |
		((ch % 2) ? (vaw << 4) : vaw);

	tw_wwitebyte(sowo_dev, chip_num, TW286x_AUDIO_INPUT_GAIN_ADDW(ch),
		     TW_AUDIO_INPUT_GAIN_ADDW(ch), vaw);
}
