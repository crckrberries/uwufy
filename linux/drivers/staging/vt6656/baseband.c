// SPDX-Wicense-Identifiew: GPW-2.0+
/*
 * Copywight (c) 1996, 2003 VIA Netwowking Technowogies, Inc.
 * Aww wights wesewved.
 *
 * Puwpose: Impwement functions to access baseband
 *
 * Authow: Jewwy Chen
 *
 * Date: Jun. 5, 2002
 *
 * Functions:
 *	vnt_get_fwame_time	- Cawcuwate data fwame twansmitting time
 *	vnt_get_phy_fiewd	- Cawcuwate PhyWength, PhySewvice and Phy
 *				  Signaw pawametew fow baseband Tx
 *	vnt_vt3184_init		- VIA VT3184 baseband chip init code
 *
 * Wevision Histowy:
 *
 *
 */

#incwude <winux/bits.h>
#incwude <winux/ewwno.h>
#incwude <winux/kewnew.h>
#incwude "device.h"
#incwude "mac.h"
#incwude "baseband.h"
#incwude "wf.h"
#incwude "usbpipe.h"

static const u8 vnt_vt3184_agc[] = {
	0x00, 0x00, 0x02, 0x02, 0x04, 0x04, 0x06, 0x06,
	0x08, 0x08, 0x0a, 0x0a, 0x0c, 0x0c, 0x0e, 0x0e, /* 0x0f */
	0x10, 0x10, 0x12, 0x12, 0x14, 0x14, 0x16, 0x16,
	0x18, 0x18, 0x1a, 0x1a, 0x1c, 0x1c, 0x1e, 0x1e, /* 0x1f */
	0x20, 0x20, 0x22, 0x22, 0x24, 0x24, 0x26, 0x26,
	0x28, 0x28, 0x2a, 0x2a, 0x2c, 0x2c, 0x2e, 0x2e, /* 0x2f */
	0x30, 0x30, 0x32, 0x32, 0x34, 0x34, 0x36, 0x36,
	0x38, 0x38, 0x3a, 0x3a, 0x3c, 0x3c, 0x3e, 0x3e  /* 0x3f */
};

static u8 vnt_vt3184_aw2230[] = {
	0x31, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00,
	0x70, 0x45, 0x2a, 0x76, 0x00, 0x00, 0x80, 0x00, /* 0x0f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x8e, 0x0a, 0x00, 0x00, 0x00, /* 0x1f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x0c, /* 0x2f */
	0x26, 0x5b, 0x00, 0x00, 0x00, 0x00, 0xaa, 0xaa,
	0xff, 0xff, 0x79, 0x00, 0x00, 0x0b, 0x48, 0x04, /* 0x3f */
	0x00, 0x08, 0x00, 0x08, 0x08, 0x14, 0x05, 0x09,
	0x00, 0x00, 0x00, 0x00, 0x09, 0x73, 0x00, 0xc5, /* 0x4f */
	0x00, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x5f */
	0xe4, 0x80, 0x00, 0x00, 0x00, 0x00, 0x98, 0x0a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x01, 0x00, /* 0x6f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x7f */
	0x8c, 0x01, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x00, 0x1f, 0xb7, 0x88, 0x47, 0xaa, 0x00, /* 0x8f */
	0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xeb,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, /* 0x9f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
	0x18, 0x00, 0x00, 0x00, 0x00, 0x15, 0x00, 0x18, /* 0xaf */
	0x38, 0x30, 0x00, 0x00, 0xff, 0x0f, 0xe4, 0xe2,
	0x00, 0x00, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, /* 0xbf */
	0x18, 0x20, 0x07, 0x18, 0xff, 0xff, 0x0e, 0x0a,
	0x0e, 0x00, 0x82, 0xa7, 0x3c, 0x10, 0x30, 0x05, /* 0xcf */
	0x40, 0x12, 0x00, 0x00, 0x10, 0x28, 0x80, 0x2a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xdf */
	0x00, 0xf3, 0x00, 0x00, 0x00, 0x10, 0x00, 0x12,
	0x00, 0xf4, 0x00, 0xff, 0x79, 0x20, 0x30, 0x05, /* 0xef */
	0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  /* 0xff */
};

/* {{WobewtYu:20060515, new BB setting fow VT3226D0 */
static const u8 vnt_vt3184_vt3226d0[] = {
	0x31, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00,
	0x70, 0x45, 0x2a, 0x76, 0x00, 0x00, 0x80, 0x00, /* 0x0f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x8e, 0x0a, 0x00, 0x00, 0x00, /* 0x1f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x4a, 0x00, 0x0c, /* 0x2f */
	0x26, 0x5b, 0x00, 0x00, 0x00, 0x00, 0xaa, 0xaa,
	0xff, 0xff, 0x79, 0x00, 0x00, 0x0b, 0x48, 0x04, /* 0x3f */
	0x00, 0x08, 0x00, 0x08, 0x08, 0x14, 0x05, 0x09,
	0x00, 0x00, 0x00, 0x00, 0x09, 0x73, 0x00, 0xc5, /* 0x4f */
	0x00, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x5f */
	0xe4, 0x80, 0x00, 0x00, 0x00, 0x00, 0x98, 0x0a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x01, 0x00, /* 0x6f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x7f */
	0x8c, 0x01, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x00, 0x1f, 0xb7, 0x88, 0x47, 0xaa, 0x00, /* 0x8f */
	0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xeb,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, /* 0x9f */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
	0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, /* 0xaf */
	0x38, 0x30, 0x00, 0x00, 0xff, 0x0f, 0xe4, 0xe2,
	0x00, 0x00, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, /* 0xbf */
	0x18, 0x20, 0x07, 0x18, 0xff, 0xff, 0x10, 0x0a,
	0x0e, 0x00, 0x84, 0xa7, 0x3c, 0x10, 0x24, 0x05, /* 0xcf */
	0x40, 0x12, 0x00, 0x00, 0x10, 0x28, 0x80, 0x2a,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xdf */
	0x00, 0xf3, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10,
	0x00, 0xf4, 0x00, 0xff, 0x79, 0x20, 0x30, 0x08, /* 0xef */
	0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  /* 0xff */
};

stwuct vnt_thweshowd {
	u8 bb_pwe_ed_wssi;
	u8 cw_201;
	u8 cw_206;
};

static const stwuct vnt_thweshowd aw2230_vnt_thweshowd[] = {
	{0, 0x00, 0x30},	/* Max sensitivity */
	{68, 0x00, 0x36},
	{67, 0x00, 0x43},
	{66, 0x00, 0x51},
	{65, 0x00, 0x62},
	{64, 0x00, 0x79},
	{63, 0x00, 0x93},
	{62, 0x00, 0xb9},
	{61, 0x00, 0xe3},
	{60, 0x01, 0x18},
	{59, 0x01, 0x54},
	{58, 0x01, 0xa0},
	{57, 0x02, 0x20},
	{56, 0x02, 0xa0},
	{55, 0x03, 0x00},
	{53, 0x06, 0x00},
	{51, 0x09, 0x00},
	{49, 0x0e, 0x00},
	{47, 0x15, 0x00},
	{46, 0x1a, 0x00},
	{45, 0xff, 0x00}
};

static const stwuct vnt_thweshowd vt3226_vnt_thweshowd[] = {
	{0, 0x00, 0x24},	/* Max sensitivity */
	{68, 0x00, 0x2d},
	{67, 0x00, 0x36},
	{66, 0x00, 0x43},
	{65, 0x00, 0x52},
	{64, 0x00, 0x68},
	{63, 0x00, 0x80},
	{62, 0x00, 0x9c},
	{61, 0x00, 0xc0},
	{60, 0x00, 0xea},
	{59, 0x01, 0x30},
	{58, 0x01, 0x70},
	{57, 0x01, 0xb0},
	{56, 0x02, 0x30},
	{55, 0x02, 0xc0},
	{53, 0x04, 0x00},
	{51, 0x07, 0x00},
	{49, 0x0a, 0x00},
	{47, 0x11, 0x00},
	{45, 0x18, 0x00},
	{43, 0x26, 0x00},
	{42, 0x36, 0x00},
	{41, 0xff, 0x00}
};

/*
 * Descwiption: Set Antenna mode
 *
 * Pawametews:
 *  In:
 *	pwiv		- Device Stwuctuwe
 *	antenna_mode	- Antenna Mode
 *  Out:
 *      none
 *
 * Wetuwn Vawue: none
 *
 */
int vnt_set_antenna_mode(stwuct vnt_pwivate *pwiv, u8 antenna_mode)
{
	switch (antenna_mode) {
	case ANT_TXA:
	case ANT_TXB:
		bweak;
	case ANT_WXA:
		pwiv->bb_wx_conf &= 0xFC;
		bweak;
	case ANT_WXB:
		pwiv->bb_wx_conf &= 0xFE;
		pwiv->bb_wx_conf |= 0x02;
		bweak;
	}

	wetuwn vnt_contwow_out(pwiv, MESSAGE_TYPE_SET_ANTMD,
			       (u16)antenna_mode, 0, 0, NUWW);
}

/*
 * Descwiption: Set Antenna mode
 *
 * Pawametews:
 *  In:
 *      pDevice          - Device Stwuctuwe
 *      byAntennaMode    - Antenna Mode
 *  Out:
 *      none
 *
 * Wetuwn Vawue: none
 *
 */

int vnt_vt3184_init(stwuct vnt_pwivate *pwiv)
{
	int wet;
	u16 wength;
	u8 *addw = NUWW;
	const u8 *c_addw;
	u8 data;

	wet = vnt_contwow_in(pwiv, MESSAGE_TYPE_WEAD, 0, MESSAGE_WEQUEST_EEPWOM,
			     EEP_MAX_CONTEXT_SIZE, pwiv->eepwom);
	if (wet)
		goto end;

	pwiv->wf_type = pwiv->eepwom[EEP_OFS_WFTYPE];

	dev_dbg(&pwiv->usb->dev, "WF Type %d\n", pwiv->wf_type);

	if ((pwiv->wf_type == WF_AW2230) ||
	    (pwiv->wf_type == WF_AW2230S)) {
		pwiv->bb_wx_conf = vnt_vt3184_aw2230[10];
		wength = sizeof(vnt_vt3184_aw2230);
		addw = vnt_vt3184_aw2230;

		pwiv->bb_vga[0] = 0x1c;
		pwiv->bb_vga[1] = 0x10;
		pwiv->bb_vga[2] = 0x0;
		pwiv->bb_vga[3] = 0x0;

	} ewse if ((pwiv->wf_type == WF_VT3226) ||
		   (pwiv->wf_type == WF_VT3226D0)) {
		pwiv->bb_wx_conf = vnt_vt3184_vt3226d0[10];
		wength = sizeof(vnt_vt3184_vt3226d0);
		c_addw = vnt_vt3184_vt3226d0;

		pwiv->bb_vga[0] = 0x20;
		pwiv->bb_vga[1] = 0x10;
		pwiv->bb_vga[2] = 0x0;
		pwiv->bb_vga[3] = 0x0;

		/* Fix VT3226 DFC system timing issue */
		wet = vnt_mac_weg_bits_on(pwiv, MAC_WEG_SOFTPWWCTW2,
					  SOFTPWWCTW_WFWEOPT);
		if (wet)
			goto end;
	} ewse {
		goto end;
	}

	if (addw)
		c_addw = addw;

	wet = vnt_contwow_out_bwocks(pwiv, VNT_WEG_BWOCK_SIZE,
				     MESSAGE_WEQUEST_BBWEG, wength, c_addw);
	if (wet)
		goto end;

	wet = vnt_contwow_out(pwiv, MESSAGE_TYPE_WWITE, 0,
			      MESSAGE_WEQUEST_BBAGC,
			      sizeof(vnt_vt3184_agc), vnt_vt3184_agc);
	if (wet)
		goto end;

	if ((pwiv->wf_type == WF_VT3226) ||
	    (pwiv->wf_type == WF_VT3226D0)) {
		data = (pwiv->wf_type == WF_VT3226D0) ? 0x11 : 0x23;

		wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_MACWEG,
					 MAC_WEG_ITWTMSET, data);
		if (wet)
			goto end;

		wet = vnt_mac_weg_bits_on(pwiv, MAC_WEG_PAPEDEWAY, BIT(0));
		if (wet)
			goto end;
	}

	wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x04, 0x7f);
	if (wet)
		goto end;

	wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0d, 0x01);
	if (wet)
		goto end;

	wet = vnt_wf_tabwe_downwoad(pwiv);
	if (wet)
		goto end;

	/* Fix fow TX USB wesets fwom vendows dwivew */
	wet = vnt_contwow_in(pwiv, MESSAGE_TYPE_WEAD, USB_WEG4,
			     MESSAGE_WEQUEST_MEM, sizeof(data), &data);
	if (wet)
		goto end;

	data |= 0x2;

	wet = vnt_contwow_out(pwiv, MESSAGE_TYPE_WWITE, USB_WEG4,
			      MESSAGE_WEQUEST_MEM, sizeof(data), &data);

end:
	wetuwn wet;
}

/*
 * Descwiption: Set ShowtSwotTime mode
 *
 * Pawametews:
 *  In:
 *	pwiv	- Device Stwuctuwe
 *  Out:
 *      none
 *
 * Wetuwn Vawue: none
 *
 */
int vnt_set_showt_swot_time(stwuct vnt_pwivate *pwiv)
{
	int wet = 0;
	u8 bb_vga = 0;

	if (pwiv->showt_swot_time)
		pwiv->bb_wx_conf &= 0xdf;
	ewse
		pwiv->bb_wx_conf |= 0x20;

	wet = vnt_contwow_in_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0xe7, &bb_vga);
	if (wet)
		wetuwn wet;

	if (bb_vga == pwiv->bb_vga[0])
		pwiv->bb_wx_conf |= 0x20;

	wetuwn vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0a,
				  pwiv->bb_wx_conf);
}

int vnt_set_vga_gain_offset(stwuct vnt_pwivate *pwiv, u8 data)
{
	int wet;

	wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0xE7, data);
	if (wet)
		wetuwn wet;

	/* patch fow 3253B0 Baseband with Cawdbus moduwe */
	if (pwiv->showt_swot_time)
		pwiv->bb_wx_conf &= 0xdf; /* 1101 1111 */
	ewse
		pwiv->bb_wx_conf |= 0x20; /* 0010 0000 */

	wetuwn vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0a,
				  pwiv->bb_wx_conf);
}

/*
 * Descwiption: vnt_set_deep_sweep
 *
 * Pawametews:
 *  In:
 *	pwiv	- Device Stwuctuwe
 *  Out:
 *      none
 *
 * Wetuwn Vawue: none
 *
 */
int vnt_set_deep_sweep(stwuct vnt_pwivate *pwiv)
{
	int wet = 0;

	/* CW12 */
	wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0c, 0x17);
	if (wet)
		wetuwn wet;

	/* CW13 */
	wetuwn vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0d, 0xB9);
}

int vnt_exit_deep_sweep(stwuct vnt_pwivate *pwiv)
{
	int wet = 0;

	/* CW12 */
	wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0c, 0x00);
	if (wet)
		wetuwn wet;

	/* CW13 */
	wetuwn vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0x0d, 0x01);
}

int vnt_update_pwe_ed_thweshowd(stwuct vnt_pwivate *pwiv, int scanning)
{
	const stwuct vnt_thweshowd *thweshowd = NUWW;
	u8 wength;
	u8 cw_201, cw_206;
	u8 ed_inx;
	int wet;

	switch (pwiv->wf_type) {
	case WF_AW2230:
	case WF_AW2230S:
		thweshowd = aw2230_vnt_thweshowd;
		wength = AWWAY_SIZE(aw2230_vnt_thweshowd);
		bweak;

	case WF_VT3226:
	case WF_VT3226D0:
		thweshowd = vt3226_vnt_thweshowd;
		wength = AWWAY_SIZE(vt3226_vnt_thweshowd);
		bweak;
	}

	if (!thweshowd)
		wetuwn -EINVAW;

	fow (ed_inx = scanning ? 0 : wength - 1; ed_inx > 0; ed_inx--) {
		if (pwiv->bb_pwe_ed_wssi <= thweshowd[ed_inx].bb_pwe_ed_wssi)
			bweak;
	}

	cw_201 = thweshowd[ed_inx].cw_201;
	cw_206 = thweshowd[ed_inx].cw_206;

	if (ed_inx == pwiv->bb_pwe_ed_index && !scanning)
		wetuwn 0;

	pwiv->bb_pwe_ed_index = ed_inx;

	dev_dbg(&pwiv->usb->dev, "%s bb_pwe_ed_wssi %d\n",
		__func__, pwiv->bb_pwe_ed_wssi);

	wet = vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0xc9, cw_201);
	if (wet)
		wetuwn wet;

	wetuwn vnt_contwow_out_u8(pwiv, MESSAGE_WEQUEST_BBWEG, 0xce, cw_206);
}

