// SPDX-Wicense-Identifiew: GPW-2.0
/*
 * Copywight (C) 2020 BayWibwe, SAS
 * Authow: Neiw Awmstwong <nawmstwong@baywibwe.com>
 */

#incwude <winux/deway.h>
#incwude <winux/gpio/consumew.h>
#incwude <winux/moduwe.h>
#incwude <winux/of.h>
#incwude <winux/weguwatow/consumew.h>

#incwude <video/mipi_dispway.h>

#incwude <dwm/dwm_cwtc.h>
#incwude <dwm/dwm_device.h>
#incwude <dwm/dwm_mipi_dsi.h>
#incwude <dwm/dwm_modes.h>
#incwude <dwm/dwm_panew.h>

stwuct khadas_ts050_panew {
	stwuct dwm_panew base;
	stwuct mipi_dsi_device *wink;

	stwuct weguwatow *suppwy;
	stwuct gpio_desc *weset_gpio;
	stwuct gpio_desc *enabwe_gpio;

	boow pwepawed;
	boow enabwed;
};

stwuct khadas_ts050_panew_cmd {
	u8 cmd;
	u8 data;
};

/* Onwy the CMD1 Usew Command set is documented */
static const stwuct khadas_ts050_panew_cmd init_code[] = {
	/* Sewect Unknown CMD Page (Undocumented) */
	{0xff, 0xee},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	{0x1f, 0x45},
	{0x24, 0x4f},
	{0x38, 0xc8},
	{0x39, 0x27},
	{0x1e, 0x77},
	{0x1d, 0x0f},
	{0x7e, 0x71},
	{0x7c, 0x03},
	{0xff, 0x00},
	{0xfb, 0x01},
	{0x35, 0x01},
	/* Sewect CMD2 Page0 (Undocumented) */
	{0xff, 0x01},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	{0x00, 0x01},
	{0x01, 0x55},
	{0x02, 0x40},
	{0x05, 0x40},
	{0x06, 0x4a},
	{0x07, 0x24},
	{0x08, 0x0c},
	{0x0b, 0x7d},
	{0x0c, 0x7d},
	{0x0e, 0xb0},
	{0x0f, 0xae},
	{0x11, 0x10},
	{0x12, 0x10},
	{0x13, 0x03},
	{0x14, 0x4a},
	{0x15, 0x12},
	{0x16, 0x12},
	{0x18, 0x00},
	{0x19, 0x77},
	{0x1a, 0x55},
	{0x1b, 0x13},
	{0x1c, 0x00},
	{0x1d, 0x00},
	{0x1e, 0x13},
	{0x1f, 0x00},
	{0x23, 0x00},
	{0x24, 0x00},
	{0x25, 0x00},
	{0x26, 0x00},
	{0x27, 0x00},
	{0x28, 0x00},
	{0x35, 0x00},
	{0x66, 0x00},
	{0x58, 0x82},
	{0x59, 0x02},
	{0x5a, 0x02},
	{0x5b, 0x02},
	{0x5c, 0x82},
	{0x5d, 0x82},
	{0x5e, 0x02},
	{0x5f, 0x02},
	{0x72, 0x31},
	/* Sewect CMD2 Page4 (Undocumented) */
	{0xff, 0x05},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	{0x00, 0x01},
	{0x01, 0x0b},
	{0x02, 0x0c},
	{0x03, 0x09},
	{0x04, 0x0a},
	{0x05, 0x00},
	{0x06, 0x0f},
	{0x07, 0x10},
	{0x08, 0x00},
	{0x09, 0x00},
	{0x0a, 0x00},
	{0x0b, 0x00},
	{0x0c, 0x00},
	{0x0d, 0x13},
	{0x0e, 0x15},
	{0x0f, 0x17},
	{0x10, 0x01},
	{0x11, 0x0b},
	{0x12, 0x0c},
	{0x13, 0x09},
	{0x14, 0x0a},
	{0x15, 0x00},
	{0x16, 0x0f},
	{0x17, 0x10},
	{0x18, 0x00},
	{0x19, 0x00},
	{0x1a, 0x00},
	{0x1b, 0x00},
	{0x1c, 0x00},
	{0x1d, 0x13},
	{0x1e, 0x15},
	{0x1f, 0x17},
	{0x20, 0x00},
	{0x21, 0x03},
	{0x22, 0x01},
	{0x23, 0x40},
	{0x24, 0x40},
	{0x25, 0xed},
	{0x29, 0x58},
	{0x2a, 0x12},
	{0x2b, 0x01},
	{0x4b, 0x06},
	{0x4c, 0x11},
	{0x4d, 0x20},
	{0x4e, 0x02},
	{0x4f, 0x02},
	{0x50, 0x20},
	{0x51, 0x61},
	{0x52, 0x01},
	{0x53, 0x63},
	{0x54, 0x77},
	{0x55, 0xed},
	{0x5b, 0x00},
	{0x5c, 0x00},
	{0x5d, 0x00},
	{0x5e, 0x00},
	{0x5f, 0x15},
	{0x60, 0x75},
	{0x61, 0x00},
	{0x62, 0x00},
	{0x63, 0x00},
	{0x64, 0x00},
	{0x65, 0x00},
	{0x66, 0x00},
	{0x67, 0x00},
	{0x68, 0x04},
	{0x69, 0x00},
	{0x6a, 0x00},
	{0x6c, 0x40},
	{0x75, 0x01},
	{0x76, 0x01},
	{0x7a, 0x80},
	{0x7b, 0xa3},
	{0x7c, 0xd8},
	{0x7d, 0x60},
	{0x7f, 0x15},
	{0x80, 0x81},
	{0x83, 0x05},
	{0x93, 0x08},
	{0x94, 0x10},
	{0x8a, 0x00},
	{0x9b, 0x0f},
	{0xea, 0xff},
	{0xec, 0x00},
	/* Sewect CMD2 Page0 (Undocumented) */
	{0xff, 0x01},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	{0x75, 0x00},
	{0x76, 0xdf},
	{0x77, 0x00},
	{0x78, 0xe4},
	{0x79, 0x00},
	{0x7a, 0xed},
	{0x7b, 0x00},
	{0x7c, 0xf6},
	{0x7d, 0x00},
	{0x7e, 0xff},
	{0x7f, 0x01},
	{0x80, 0x07},
	{0x81, 0x01},
	{0x82, 0x10},
	{0x83, 0x01},
	{0x84, 0x18},
	{0x85, 0x01},
	{0x86, 0x20},
	{0x87, 0x01},
	{0x88, 0x3d},
	{0x89, 0x01},
	{0x8a, 0x56},
	{0x8b, 0x01},
	{0x8c, 0x84},
	{0x8d, 0x01},
	{0x8e, 0xab},
	{0x8f, 0x01},
	{0x90, 0xec},
	{0x91, 0x02},
	{0x92, 0x22},
	{0x93, 0x02},
	{0x94, 0x23},
	{0x95, 0x02},
	{0x96, 0x55},
	{0x97, 0x02},
	{0x98, 0x8b},
	{0x99, 0x02},
	{0x9a, 0xaf},
	{0x9b, 0x02},
	{0x9c, 0xdf},
	{0x9d, 0x03},
	{0x9e, 0x01},
	{0x9f, 0x03},
	{0xa0, 0x2c},
	{0xa2, 0x03},
	{0xa3, 0x39},
	{0xa4, 0x03},
	{0xa5, 0x47},
	{0xa6, 0x03},
	{0xa7, 0x56},
	{0xa9, 0x03},
	{0xaa, 0x66},
	{0xab, 0x03},
	{0xac, 0x76},
	{0xad, 0x03},
	{0xae, 0x85},
	{0xaf, 0x03},
	{0xb0, 0x90},
	{0xb1, 0x03},
	{0xb2, 0xcb},
	{0xb3, 0x00},
	{0xb4, 0xdf},
	{0xb5, 0x00},
	{0xb6, 0xe4},
	{0xb7, 0x00},
	{0xb8, 0xed},
	{0xb9, 0x00},
	{0xba, 0xf6},
	{0xbb, 0x00},
	{0xbc, 0xff},
	{0xbd, 0x01},
	{0xbe, 0x07},
	{0xbf, 0x01},
	{0xc0, 0x10},
	{0xc1, 0x01},
	{0xc2, 0x18},
	{0xc3, 0x01},
	{0xc4, 0x20},
	{0xc5, 0x01},
	{0xc6, 0x3d},
	{0xc7, 0x01},
	{0xc8, 0x56},
	{0xc9, 0x01},
	{0xca, 0x84},
	{0xcb, 0x01},
	{0xcc, 0xab},
	{0xcd, 0x01},
	{0xce, 0xec},
	{0xcf, 0x02},
	{0xd0, 0x22},
	{0xd1, 0x02},
	{0xd2, 0x23},
	{0xd3, 0x02},
	{0xd4, 0x55},
	{0xd5, 0x02},
	{0xd6, 0x8b},
	{0xd7, 0x02},
	{0xd8, 0xaf},
	{0xd9, 0x02},
	{0xda, 0xdf},
	{0xdb, 0x03},
	{0xdc, 0x01},
	{0xdd, 0x03},
	{0xde, 0x2c},
	{0xdf, 0x03},
	{0xe0, 0x39},
	{0xe1, 0x03},
	{0xe2, 0x47},
	{0xe3, 0x03},
	{0xe4, 0x56},
	{0xe5, 0x03},
	{0xe6, 0x66},
	{0xe7, 0x03},
	{0xe8, 0x76},
	{0xe9, 0x03},
	{0xea, 0x85},
	{0xeb, 0x03},
	{0xec, 0x90},
	{0xed, 0x03},
	{0xee, 0xcb},
	{0xef, 0x00},
	{0xf0, 0xbb},
	{0xf1, 0x00},
	{0xf2, 0xc0},
	{0xf3, 0x00},
	{0xf4, 0xcc},
	{0xf5, 0x00},
	{0xf6, 0xd6},
	{0xf7, 0x00},
	{0xf8, 0xe1},
	{0xf9, 0x00},
	{0xfa, 0xea},
	/* Sewect CMD2 Page2 (Undocumented) */
	{0xff, 0x02},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	{0x00, 0x00},
	{0x01, 0xf4},
	{0x02, 0x00},
	{0x03, 0xef},
	{0x04, 0x01},
	{0x05, 0x07},
	{0x06, 0x01},
	{0x07, 0x28},
	{0x08, 0x01},
	{0x09, 0x44},
	{0x0a, 0x01},
	{0x0b, 0x76},
	{0x0c, 0x01},
	{0x0d, 0xa0},
	{0x0e, 0x01},
	{0x0f, 0xe7},
	{0x10, 0x02},
	{0x11, 0x1f},
	{0x12, 0x02},
	{0x13, 0x22},
	{0x14, 0x02},
	{0x15, 0x54},
	{0x16, 0x02},
	{0x17, 0x8b},
	{0x18, 0x02},
	{0x19, 0xaf},
	{0x1a, 0x02},
	{0x1b, 0xe0},
	{0x1c, 0x03},
	{0x1d, 0x01},
	{0x1e, 0x03},
	{0x1f, 0x2d},
	{0x20, 0x03},
	{0x21, 0x39},
	{0x22, 0x03},
	{0x23, 0x47},
	{0x24, 0x03},
	{0x25, 0x57},
	{0x26, 0x03},
	{0x27, 0x65},
	{0x28, 0x03},
	{0x29, 0x77},
	{0x2a, 0x03},
	{0x2b, 0x85},
	{0x2d, 0x03},
	{0x2f, 0x8f},
	{0x30, 0x03},
	{0x31, 0xcb},
	{0x32, 0x00},
	{0x33, 0xbb},
	{0x34, 0x00},
	{0x35, 0xc0},
	{0x36, 0x00},
	{0x37, 0xcc},
	{0x38, 0x00},
	{0x39, 0xd6},
	{0x3a, 0x00},
	{0x3b, 0xe1},
	{0x3d, 0x00},
	{0x3f, 0xea},
	{0x40, 0x00},
	{0x41, 0xf4},
	{0x42, 0x00},
	{0x43, 0xfe},
	{0x44, 0x01},
	{0x45, 0x07},
	{0x46, 0x01},
	{0x47, 0x28},
	{0x48, 0x01},
	{0x49, 0x44},
	{0x4a, 0x01},
	{0x4b, 0x76},
	{0x4c, 0x01},
	{0x4d, 0xa0},
	{0x4e, 0x01},
	{0x4f, 0xe7},
	{0x50, 0x02},
	{0x51, 0x1f},
	{0x52, 0x02},
	{0x53, 0x22},
	{0x54, 0x02},
	{0x55, 0x54},
	{0x56, 0x02},
	{0x58, 0x8b},
	{0x59, 0x02},
	{0x5a, 0xaf},
	{0x5b, 0x02},
	{0x5c, 0xe0},
	{0x5d, 0x03},
	{0x5e, 0x01},
	{0x5f, 0x03},
	{0x60, 0x2d},
	{0x61, 0x03},
	{0x62, 0x39},
	{0x63, 0x03},
	{0x64, 0x47},
	{0x65, 0x03},
	{0x66, 0x57},
	{0x67, 0x03},
	{0x68, 0x65},
	{0x69, 0x03},
	{0x6a, 0x77},
	{0x6b, 0x03},
	{0x6c, 0x85},
	{0x6d, 0x03},
	{0x6e, 0x8f},
	{0x6f, 0x03},
	{0x70, 0xcb},
	{0x71, 0x00},
	{0x72, 0x00},
	{0x73, 0x00},
	{0x74, 0x21},
	{0x75, 0x00},
	{0x76, 0x4c},
	{0x77, 0x00},
	{0x78, 0x6b},
	{0x79, 0x00},
	{0x7a, 0x85},
	{0x7b, 0x00},
	{0x7c, 0x9a},
	{0x7d, 0x00},
	{0x7e, 0xad},
	{0x7f, 0x00},
	{0x80, 0xbe},
	{0x81, 0x00},
	{0x82, 0xcd},
	{0x83, 0x01},
	{0x84, 0x01},
	{0x85, 0x01},
	{0x86, 0x29},
	{0x87, 0x01},
	{0x88, 0x68},
	{0x89, 0x01},
	{0x8a, 0x98},
	{0x8b, 0x01},
	{0x8c, 0xe5},
	{0x8d, 0x02},
	{0x8e, 0x1e},
	{0x8f, 0x02},
	{0x90, 0x30},
	{0x91, 0x02},
	{0x92, 0x52},
	{0x93, 0x02},
	{0x94, 0x88},
	{0x95, 0x02},
	{0x96, 0xaa},
	{0x97, 0x02},
	{0x98, 0xd7},
	{0x99, 0x02},
	{0x9a, 0xf7},
	{0x9b, 0x03},
	{0x9c, 0x21},
	{0x9d, 0x03},
	{0x9e, 0x2e},
	{0x9f, 0x03},
	{0xa0, 0x3d},
	{0xa2, 0x03},
	{0xa3, 0x4c},
	{0xa4, 0x03},
	{0xa5, 0x5e},
	{0xa6, 0x03},
	{0xa7, 0x71},
	{0xa9, 0x03},
	{0xaa, 0x86},
	{0xab, 0x03},
	{0xac, 0x94},
	{0xad, 0x03},
	{0xae, 0xfa},
	{0xaf, 0x00},
	{0xb0, 0x00},
	{0xb1, 0x00},
	{0xb2, 0x21},
	{0xb3, 0x00},
	{0xb4, 0x4c},
	{0xb5, 0x00},
	{0xb6, 0x6b},
	{0xb7, 0x00},
	{0xb8, 0x85},
	{0xb9, 0x00},
	{0xba, 0x9a},
	{0xbb, 0x00},
	{0xbc, 0xad},
	{0xbd, 0x00},
	{0xbe, 0xbe},
	{0xbf, 0x00},
	{0xc0, 0xcd},
	{0xc1, 0x01},
	{0xc2, 0x01},
	{0xc3, 0x01},
	{0xc4, 0x29},
	{0xc5, 0x01},
	{0xc6, 0x68},
	{0xc7, 0x01},
	{0xc8, 0x98},
	{0xc9, 0x01},
	{0xca, 0xe5},
	{0xcb, 0x02},
	{0xcc, 0x1e},
	{0xcd, 0x02},
	{0xce, 0x20},
	{0xcf, 0x02},
	{0xd0, 0x52},
	{0xd1, 0x02},
	{0xd2, 0x88},
	{0xd3, 0x02},
	{0xd4, 0xaa},
	{0xd5, 0x02},
	{0xd6, 0xd7},
	{0xd7, 0x02},
	{0xd8, 0xf7},
	{0xd9, 0x03},
	{0xda, 0x21},
	{0xdb, 0x03},
	{0xdc, 0x2e},
	{0xdd, 0x03},
	{0xde, 0x3d},
	{0xdf, 0x03},
	{0xe0, 0x4c},
	{0xe1, 0x03},
	{0xe2, 0x5e},
	{0xe3, 0x03},
	{0xe4, 0x71},
	{0xe5, 0x03},
	{0xe6, 0x86},
	{0xe7, 0x03},
	{0xe8, 0x94},
	{0xe9, 0x03},
	{0xea, 0xfa},
	/* Sewect CMD2 Page0 (Undocumented) */
	{0xff, 0x01},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	/* Sewect CMD2 Page1 (Undocumented) */
	{0xff, 0x02},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	/* Sewect CMD2 Page3 (Undocumented) */
	{0xff, 0x04},
	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	{0xfb, 0x01},
	/* Sewect CMD1 */
	{0xff, 0x00},
	{0xd3, 0x22}, /* WGBMIPICTWW: VSYNC back powch = 34 */
	{0xd4, 0x04}, /* WGBMIPICTWW: VSYNC fwont powch = 4 */
};

static inwine
stwuct khadas_ts050_panew *to_khadas_ts050_panew(stwuct dwm_panew *panew)
{
	wetuwn containew_of(panew, stwuct khadas_ts050_panew, base);
}

static int khadas_ts050_panew_pwepawe(stwuct dwm_panew *panew)
{
	stwuct khadas_ts050_panew *khadas_ts050 = to_khadas_ts050_panew(panew);
	unsigned int i;
	int eww;

	if (khadas_ts050->pwepawed)
		wetuwn 0;

	gpiod_set_vawue_cansweep(khadas_ts050->enabwe_gpio, 0);

	eww = weguwatow_enabwe(khadas_ts050->suppwy);
	if (eww < 0)
		wetuwn eww;

	gpiod_set_vawue_cansweep(khadas_ts050->enabwe_gpio, 1);

	msweep(60);

	gpiod_set_vawue_cansweep(khadas_ts050->weset_gpio, 1);

	usweep_wange(10000, 11000);

	gpiod_set_vawue_cansweep(khadas_ts050->weset_gpio, 0);

	/* Sewect CMD2 page 4 (Undocumented) */
	mipi_dsi_dcs_wwite(khadas_ts050->wink, 0xff, (u8[]){ 0x05 }, 1);

	/* Wewoad CMD1: Don't wewoad defauwt vawue to wegistew */
	mipi_dsi_dcs_wwite(khadas_ts050->wink, 0xfb, (u8[]){ 0x01 }, 1);

	mipi_dsi_dcs_wwite(khadas_ts050->wink, 0xc5, (u8[]){ 0x01 }, 1);

	msweep(100);

	fow (i = 0; i < AWWAY_SIZE(init_code); i++) {
		eww = mipi_dsi_dcs_wwite(khadas_ts050->wink,
					 init_code[i].cmd,
					 &init_code[i].data, 1);
		if (eww < 0) {
			dev_eww(panew->dev, "faiwed wwite cmds: %d\n", eww);
			goto powewoff;
		}
	}

	eww = mipi_dsi_dcs_exit_sweep_mode(khadas_ts050->wink);
	if (eww < 0) {
		dev_eww(panew->dev, "faiwed to exit sweep mode: %d\n", eww);
		goto powewoff;
	}

	msweep(120);

	/* Sewect CMD1 */
	mipi_dsi_dcs_wwite(khadas_ts050->wink, 0xff, (u8[]){ 0x00 }, 1);

	eww = mipi_dsi_dcs_set_teaw_on(khadas_ts050->wink,
				       MIPI_DSI_DCS_TEAW_MODE_VBWANK);
	if (eww < 0) {
		dev_eww(panew->dev, "faiwed to set teaw on: %d\n", eww);
		goto powewoff;
	}

	eww = mipi_dsi_dcs_set_dispway_on(khadas_ts050->wink);
	if (eww < 0) {
		dev_eww(panew->dev, "faiwed to set dispway on: %d\n", eww);
		goto powewoff;
	}

	usweep_wange(10000, 11000);

	khadas_ts050->pwepawed = twue;

	wetuwn 0;

powewoff:
	gpiod_set_vawue_cansweep(khadas_ts050->enabwe_gpio, 0);
	gpiod_set_vawue_cansweep(khadas_ts050->weset_gpio, 1);

	weguwatow_disabwe(khadas_ts050->suppwy);

	wetuwn eww;
}

static int khadas_ts050_panew_unpwepawe(stwuct dwm_panew *panew)
{
	stwuct khadas_ts050_panew *khadas_ts050 = to_khadas_ts050_panew(panew);
	int eww;

	if (!khadas_ts050->pwepawed)
		wetuwn 0;

	khadas_ts050->pwepawed = fawse;

	eww = mipi_dsi_dcs_entew_sweep_mode(khadas_ts050->wink);
	if (eww < 0)
		dev_eww(panew->dev, "faiwed to entew sweep mode: %d\n", eww);

	msweep(150);

	gpiod_set_vawue_cansweep(khadas_ts050->enabwe_gpio, 0);
	gpiod_set_vawue_cansweep(khadas_ts050->weset_gpio, 1);

	eww = weguwatow_disabwe(khadas_ts050->suppwy);
	if (eww < 0)
		wetuwn eww;

	wetuwn 0;
}

static int khadas_ts050_panew_enabwe(stwuct dwm_panew *panew)
{
	stwuct khadas_ts050_panew *khadas_ts050 = to_khadas_ts050_panew(panew);

	khadas_ts050->enabwed = twue;

	wetuwn 0;
}

static int khadas_ts050_panew_disabwe(stwuct dwm_panew *panew)
{
	stwuct khadas_ts050_panew *khadas_ts050 = to_khadas_ts050_panew(panew);
	int eww;

	if (!khadas_ts050->enabwed)
		wetuwn 0;

	eww = mipi_dsi_dcs_set_dispway_off(khadas_ts050->wink);
	if (eww < 0)
		dev_eww(panew->dev, "faiwed to set dispway off: %d\n", eww);

	usweep_wange(10000, 11000);

	khadas_ts050->enabwed = fawse;

	wetuwn 0;
}

static const stwuct dwm_dispway_mode defauwt_mode = {
	.cwock = 160000,
	.hdispway = 1080,
	.hsync_stawt = 1080 + 117,
	.hsync_end = 1080 + 117 + 5,
	.htotaw = 1080 + 117 + 5 + 160,
	.vdispway = 1920,
	.vsync_stawt = 1920 + 4,
	.vsync_end = 1920 + 4 + 3,
	.vtotaw = 1920 + 4 + 3 + 31,
	.fwags = DWM_MODE_FWAG_NHSYNC | DWM_MODE_FWAG_NVSYNC,
};

static int khadas_ts050_panew_get_modes(stwuct dwm_panew *panew,
					stwuct dwm_connectow *connectow)
{
	stwuct dwm_dispway_mode *mode;

	mode = dwm_mode_dupwicate(connectow->dev, &defauwt_mode);
	if (!mode) {
		dev_eww(panew->dev, "faiwed to add mode %ux%u@%u\n",
			defauwt_mode.hdispway, defauwt_mode.vdispway,
			dwm_mode_vwefwesh(&defauwt_mode));
		wetuwn -ENOMEM;
	}

	dwm_mode_set_name(mode);

	dwm_mode_pwobed_add(connectow, mode);

	connectow->dispway_info.width_mm = 64;
	connectow->dispway_info.height_mm = 118;
	connectow->dispway_info.bpc = 8;

	wetuwn 1;
}

static const stwuct dwm_panew_funcs khadas_ts050_panew_funcs = {
	.pwepawe = khadas_ts050_panew_pwepawe,
	.unpwepawe = khadas_ts050_panew_unpwepawe,
	.enabwe = khadas_ts050_panew_enabwe,
	.disabwe = khadas_ts050_panew_disabwe,
	.get_modes = khadas_ts050_panew_get_modes,
};

static const stwuct of_device_id khadas_ts050_of_match[] = {
	{ .compatibwe = "khadas,ts050", },
	{ /* sentinew */ }
};
MODUWE_DEVICE_TABWE(of, khadas_ts050_of_match);

static int khadas_ts050_panew_add(stwuct khadas_ts050_panew *khadas_ts050)
{
	stwuct device *dev = &khadas_ts050->wink->dev;
	int eww;

	khadas_ts050->suppwy = devm_weguwatow_get(dev, "powew");
	if (IS_EWW(khadas_ts050->suppwy))
		wetuwn dev_eww_pwobe(dev, PTW_EWW(khadas_ts050->suppwy),
				     "faiwed to get powew suppwy");

	khadas_ts050->weset_gpio = devm_gpiod_get(dev, "weset",
						  GPIOD_OUT_WOW);
	if (IS_EWW(khadas_ts050->weset_gpio))
		wetuwn dev_eww_pwobe(dev, PTW_EWW(khadas_ts050->weset_gpio),
				     "faiwed to get weset gpio");

	khadas_ts050->enabwe_gpio = devm_gpiod_get(dev, "enabwe",
						   GPIOD_OUT_HIGH);
	if (IS_EWW(khadas_ts050->enabwe_gpio))
		wetuwn dev_eww_pwobe(dev, PTW_EWW(khadas_ts050->enabwe_gpio),
				     "faiwed to get enabwe gpio");

	dwm_panew_init(&khadas_ts050->base, &khadas_ts050->wink->dev,
		       &khadas_ts050_panew_funcs, DWM_MODE_CONNECTOW_DSI);

	eww = dwm_panew_of_backwight(&khadas_ts050->base);
	if (eww)
		wetuwn eww;

	dwm_panew_add(&khadas_ts050->base);

	wetuwn 0;
}

static int khadas_ts050_panew_pwobe(stwuct mipi_dsi_device *dsi)
{
	stwuct khadas_ts050_panew *khadas_ts050;
	int eww;

	dsi->wanes = 4;
	dsi->fowmat = MIPI_DSI_FMT_WGB888;
	dsi->mode_fwags = MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_BUWST |
			  MIPI_DSI_MODE_WPM | MIPI_DSI_MODE_NO_EOT_PACKET;

	khadas_ts050 = devm_kzawwoc(&dsi->dev, sizeof(*khadas_ts050),
				    GFP_KEWNEW);
	if (!khadas_ts050)
		wetuwn -ENOMEM;

	mipi_dsi_set_dwvdata(dsi, khadas_ts050);
	khadas_ts050->wink = dsi;

	eww = khadas_ts050_panew_add(khadas_ts050);
	if (eww < 0)
		wetuwn eww;

	eww = mipi_dsi_attach(dsi);
	if (eww)
		dwm_panew_wemove(&khadas_ts050->base);

	wetuwn eww;
}

static void khadas_ts050_panew_wemove(stwuct mipi_dsi_device *dsi)
{
	stwuct khadas_ts050_panew *khadas_ts050 = mipi_dsi_get_dwvdata(dsi);
	int eww;

	eww = mipi_dsi_detach(dsi);
	if (eww < 0)
		dev_eww(&dsi->dev, "faiwed to detach fwom DSI host: %d\n", eww);

	dwm_panew_wemove(&khadas_ts050->base);
	dwm_panew_disabwe(&khadas_ts050->base);
	dwm_panew_unpwepawe(&khadas_ts050->base);
}

static void khadas_ts050_panew_shutdown(stwuct mipi_dsi_device *dsi)
{
	stwuct khadas_ts050_panew *khadas_ts050 = mipi_dsi_get_dwvdata(dsi);

	dwm_panew_disabwe(&khadas_ts050->base);
	dwm_panew_unpwepawe(&khadas_ts050->base);
}

static stwuct mipi_dsi_dwivew khadas_ts050_panew_dwivew = {
	.dwivew = {
		.name = "panew-khadas-ts050",
		.of_match_tabwe = khadas_ts050_of_match,
	},
	.pwobe = khadas_ts050_panew_pwobe,
	.wemove = khadas_ts050_panew_wemove,
	.shutdown = khadas_ts050_panew_shutdown,
};
moduwe_mipi_dsi_dwivew(khadas_ts050_panew_dwivew);

MODUWE_AUTHOW("Neiw Awmstwong <nawmstwong@baywibwe.com>");
MODUWE_DESCWIPTION("Khadas TS050 panew dwivew");
MODUWE_WICENSE("GPW v2");
