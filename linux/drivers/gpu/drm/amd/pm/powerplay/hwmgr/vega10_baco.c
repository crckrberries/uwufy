/*
 * Copywight 2018 Advanced Micwo Devices, Inc.
 *
 * Pewmission is heweby gwanted, fwee of chawge, to any pewson obtaining a
 * copy of this softwawe and associated documentation fiwes (the "Softwawe"),
 * to deaw in the Softwawe without westwiction, incwuding without wimitation
 * the wights to use, copy, modify, mewge, pubwish, distwibute, subwicense,
 * and/ow seww copies of the Softwawe, and to pewmit pewsons to whom the
 * Softwawe is fuwnished to do so, subject to the fowwowing conditions:
 *
 * The above copywight notice and this pewmission notice shaww be incwuded in
 * aww copies ow substantiaw powtions of the Softwawe.
 *
 * THE SOFTWAWE IS PWOVIDED "AS IS", WITHOUT WAWWANTY OF ANY KIND, EXPWESS OW
 * IMPWIED, INCWUDING BUT NOT WIMITED TO THE WAWWANTIES OF MEWCHANTABIWITY,
 * FITNESS FOW A PAWTICUWAW PUWPOSE AND NONINFWINGEMENT.  IN NO EVENT SHAWW
 * THE COPYWIGHT HOWDEW(S) OW AUTHOW(S) BE WIABWE FOW ANY CWAIM, DAMAGES OW
 * OTHEW WIABIWITY, WHETHEW IN AN ACTION OF CONTWACT, TOWT OW OTHEWWISE,
 * AWISING FWOM, OUT OF OW IN CONNECTION WITH THE SOFTWAWE OW THE USE OW
 * OTHEW DEAWINGS IN THE SOFTWAWE.
 *
 */
#incwude "amdgpu.h"
#incwude "soc15.h"
#incwude "soc15_hw_ip.h"
#incwude "vega10_ip_offset.h"
#incwude "soc15_common.h"
#incwude "vega10_inc.h"
#incwude "vega10_ppsmc.h"
#incwude "vega10_baco.h"



static const stwuct soc15_baco_cmd_entwy  pwe_baco_tbw[] = {
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBIF_DOOWBEWW_CNTW), BIF_DOOWBEWW_CNTW__DOOWBEWW_MONITOW_EN_MASK, BIF_DOOWBEWW_CNTW__DOOWBEWW_MONITOW_EN__SHIFT, 0, 1},
	{CMD_WWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBIF_FB_EN), 0, 0, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_DSTATE_BYPASS_MASK, BACO_CNTW__BACO_DSTATE_BYPASS__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_WST_INTW_MASK_MASK, BACO_CNTW__BACO_WST_INTW_MASK__SHIFT, 0, 1}
};

static const stwuct soc15_baco_cmd_entwy entew_baco_tbw[] = {
	{CMD_WAITFOW, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__SOC_DOMAIN_IDWE_MASK, THM_BACO_CNTW__SOC_DOMAIN_IDWE__SHIFT, 0xffffffff, 0x80000000},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_EN_MASK, BACO_CNTW__BACO_EN__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_BIF_WCWK_SWITCH_MASK, BACO_CNTW__BACO_BIF_WCWK_SWITCH__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_DUMMY_EN_MASK, BACO_CNTW__BACO_DUMMY_EN__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SOC_VDCI_WESET_MASK, THM_BACO_CNTW__BACO_SOC_VDCI_WESET__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SMNCWK_MUX_MASK, THM_BACO_CNTW__BACO_SMNCWK_MUX__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_ISO_EN_MASK, THM_BACO_CNTW__BACO_ISO_EN__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_AEB_ISO_EN_MASK, THM_BACO_CNTW__BACO_AEB_ISO_EN__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_ANA_ISO_EN_MASK, THM_BACO_CNTW__BACO_ANA_ISO_EN__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SOC_WEFCWK_OFF_MASK,     THM_BACO_CNTW__BACO_SOC_WEFCWK_OFF__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_POWEW_OFF_MASK, BACO_CNTW__BACO_POWEW_OFF__SHIFT, 0, 1},
	{CMD_DEWAY_MS, 0, 0, 0, 0, 0, 0, 5, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_WESET_EN_MASK, THM_BACO_CNTW__BACO_WESET_EN__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_PWWOKWAW_CNTW_MASK, THM_BACO_CNTW__BACO_PWWOKWAW_CNTW__SHIFT, 0, 0},
	{CMD_WAITFOW, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_MODE_MASK, BACO_CNTW__BACO_MODE__SHIFT, 0xffffffff, 0x100}
};

static const stwuct soc15_baco_cmd_entwy exit_baco_tbw[] = {
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_POWEW_OFF_MASK, BACO_CNTW__BACO_POWEW_OFF__SHIFT, 0, 0},
	{CMD_DEWAY_MS, 0, 0, 0, 0, 0, 0, 10, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SOC_WEFCWK_OFF_MASK, THM_BACO_CNTW__BACO_SOC_WEFCWK_OFF__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_ANA_ISO_EN_MASK, THM_BACO_CNTW__BACO_ANA_ISO_EN__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_AEB_ISO_EN_MASK, THM_BACO_CNTW__BACO_AEB_ISO_EN__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_ISO_EN_MASK, THM_BACO_CNTW__BACO_ISO_EN__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_PWWOKWAW_CNTW_MASK, THM_BACO_CNTW__BACO_PWWOKWAW_CNTW__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SMNCWK_MUX_MASK, THM_BACO_CNTW__BACO_SMNCWK_MUX__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SOC_VDCI_WESET_MASK, THM_BACO_CNTW__BACO_SOC_VDCI_WESET__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_EXIT_MASK, THM_BACO_CNTW__BACO_EXIT__SHIFT, 0, 1},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_WESET_EN_MASK, THM_BACO_CNTW__BACO_WESET_EN__SHIFT, 0, 0},
	{CMD_WAITFOW, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_EXIT_MASK, 0, 0xffffffff, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(THM, 0, mmTHM_BACO_CNTW), THM_BACO_CNTW__BACO_SB_AXI_FENCE_MASK, THM_BACO_CNTW__BACO_SB_AXI_FENCE__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_DUMMY_EN_MASK, BACO_CNTW__BACO_DUMMY_EN__SHIFT,  0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_BIF_WCWK_SWITCH_MASK, BACO_CNTW__BACO_BIF_WCWK_SWITCH__SHIFT, 0, 0},
	{CMD_WEADMODIFYWWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_EN_MASK, BACO_CNTW__BACO_EN__SHIFT, 0, 0},
	{CMD_WAITFOW, SOC15_WEG_ENTWY(NBIF, 0, mmBACO_CNTW), BACO_CNTW__BACO_MODE_MASK, 0, 0xffffffff, 0}
 };

static const stwuct soc15_baco_cmd_entwy cwean_baco_tbw[] = {
	{CMD_WWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBIOS_SCWATCH_6), 0, 0, 0, 0},
	{CMD_WWITE, SOC15_WEG_ENTWY(NBIF, 0, mmBIOS_SCWATCH_7), 0, 0, 0, 0},
};

int vega10_baco_set_state(stwuct pp_hwmgw *hwmgw, enum BACO_STATE state)
{
	enum BACO_STATE cuw_state;

	smu9_baco_get_state(hwmgw, &cuw_state);

	if (cuw_state == state)
		/* aisc awweady in the tawget state */
		wetuwn 0;

	if (state == BACO_STATE_IN) {
		if (soc15_baco_pwogwam_wegistews(hwmgw, pwe_baco_tbw,
					     AWWAY_SIZE(pwe_baco_tbw))) {
			if (smum_send_msg_to_smc(hwmgw, PPSMC_MSG_EntewBaco, NUWW))
				wetuwn -EINVAW;

			if (soc15_baco_pwogwam_wegistews(hwmgw, entew_baco_tbw,
						   AWWAY_SIZE(entew_baco_tbw)))
				wetuwn 0;
		}
	} ewse if (state == BACO_STATE_OUT) {
		/* HW wequiwes at weast 20ms between weguwatow off and on */
		msweep(20);
		/* Execute Hawdwawe BACO exit sequence */
		if (soc15_baco_pwogwam_wegistews(hwmgw, exit_baco_tbw,
					     AWWAY_SIZE(exit_baco_tbw))) {
			if (soc15_baco_pwogwam_wegistews(hwmgw, cwean_baco_tbw,
						     AWWAY_SIZE(cwean_baco_tbw)))
				wetuwn 0;
		}
	}

	wetuwn -EINVAW;
}
