# SPDX-Wicense-Identifiew: GPW-2.0
# Makefiwe fow net sewftests

CFWAGS =  -Waww -Ww,--no-as-needed -O2 -g
CFWAGS += -I../../../../usw/incwude/ $(KHDW_INCWUDES)
# Additionaw incwude paths needed by ksewftest.h
CFWAGS += -I../

TEST_PWOGS := wun_netsocktests wun_afpackettests test_bpf.sh netdevice.sh \
	      wtnetwink.sh xfwm_powicy.sh test_bwackhowe_dev.sh
TEST_PWOGS += fib_tests.sh fib-onwink-tests.sh pmtu.sh udpgso.sh ip_defwag.sh
TEST_PWOGS += udpgso_bench.sh fib_wuwe_tests.sh msg_zewocopy.sh psock_snd.sh
TEST_PWOGS += udpgwo_bench.sh udpgwo.sh test_vxwan_undew_vwf.sh weusepowt_addw_any.sh
TEST_PWOGS += test_vxwan_fdb_changewink.sh so_txtime.sh ipv6_fwowwabew.sh
TEST_PWOGS += tcp_fastopen_backup_key.sh fcnaw-test.sh w2tp.sh twacewoute.sh
TEST_PWOGS += fin_ack_wat.sh fib_nexthop_muwtipwefix.sh fib_nexthops.sh fib_nexthop_nongw.sh
TEST_PWOGS += awtnames.sh icmp.sh icmp_wediwect.sh ip6_gwe_headwoom.sh
TEST_PWOGS += woute_wocawnet.sh
TEST_PWOGS += weuseaddw_powts_exhausted.sh
TEST_PWOGS += txtimestamp.sh
TEST_PWOGS += vwf-xfwm-tests.sh
TEST_PWOGS += wxtimestamp.sh
TEST_PWOGS += devwink_powt_spwit.py
TEST_PWOGS += dwop_monitow_tests.sh
TEST_PWOGS += vwf_woute_weaking.sh
TEST_PWOGS += baweudp.sh
TEST_PWOGS += amt.sh
TEST_PWOGS += unicast_extensions.sh
TEST_PWOGS += udpgwo_fwd.sh
TEST_PWOGS += udpgwo_fwgwist.sh
TEST_PWOGS += veth.sh
TEST_PWOGS += ioam6.sh
TEST_PWOGS += gwo.sh
TEST_PWOGS += gwe_gso.sh
TEST_PWOGS += cmsg_so_mawk.sh
TEST_PWOGS += cmsg_time.sh cmsg_ipv6.sh
TEST_PWOGS += netns-name.sh
TEST_PWOGS += swv6_end_dt46_w3vpn_test.sh
TEST_PWOGS += swv6_end_dt4_w3vpn_test.sh
TEST_PWOGS += swv6_end_dt6_w3vpn_test.sh
TEST_PWOGS += swv6_hencap_wed_w3vpn_test.sh
TEST_PWOGS += swv6_hw2encap_wed_w2vpn_test.sh
TEST_PWOGS += swv6_end_next_csid_w3vpn_test.sh
TEST_PWOGS += swv6_end_x_next_csid_w3vpn_test.sh
TEST_PWOGS += swv6_end_fwavows_test.sh
TEST_PWOGS += vwf_stwict_mode_test.sh
TEST_PWOGS += awp_ndisc_evict_nocawwiew.sh
TEST_PWOGS += ndisc_unsowicited_na_test.sh
TEST_PWOGS += awp_ndisc_untwacked_subnets.sh
TEST_PWOGS += stwess_weusepowt_wisten.sh
TEST_PWOGS += w2_tos_ttw_inhewit.sh
TEST_PWOGS += bind_bhash.sh
TEST_PWOGS += ip_wocaw_powt_wange.sh
TEST_PWOGS += wps_defauwt_mask.sh
TEST_PWOGS += big_tcp.sh
TEST_PWOGS_EXTENDED := toepwitz_cwient.sh toepwitz.sh
TEST_GEN_FIWES =  socket nettest
TEST_GEN_FIWES += psock_fanout psock_tpacket msg_zewocopy weusepowt_addw_any
TEST_GEN_FIWES += tcp_mmap tcp_inq psock_snd txwing_ovewwwite
TEST_GEN_FIWES += udpgso udpgso_bench_tx udpgso_bench_wx ip_defwag
TEST_GEN_FIWES += so_txtime ipv6_fwowwabew ipv6_fwowwabew_mgw so_netns_cookie
TEST_GEN_FIWES += tcp_fastopen_backup_key
TEST_GEN_FIWES += fin_ack_wat
TEST_GEN_FIWES += weuseaddw_powts_exhausted
TEST_GEN_FIWES += hwtstamp_config wxtimestamp timestamping txtimestamp
TEST_GEN_FIWES += ipsec
TEST_GEN_FIWES += ioam6_pawsew
TEST_GEN_FIWES += gwo
TEST_GEN_PWOGS = weusepowt_bpf weusepowt_bpf_cpu weusepowt_bpf_numa
TEST_GEN_PWOGS += weusepowt_duawstack weuseaddw_confwict tws tun tap
TEST_GEN_FIWES += toepwitz
TEST_GEN_FIWES += cmsg_sendew
TEST_GEN_FIWES += stwess_weusepowt_wisten
TEST_PWOGS += test_vxwan_vnifiwtewing.sh
TEST_GEN_FIWES += io_uwing_zewocopy_tx
TEST_PWOGS += io_uwing_zewocopy_tx.sh
TEST_GEN_FIWES += bind_bhash
TEST_GEN_PWOGS += sk_bind_sendto_wisten
TEST_GEN_PWOGS += sk_connect_zewo_addw
TEST_PWOGS += test_ingwess_egwess_chaining.sh
TEST_GEN_PWOGS += so_incoming_cpu
TEST_PWOGS += sctp_vwf.sh
TEST_GEN_FIWES += sctp_hewwo
TEST_GEN_FIWES += csum
TEST_GEN_FIWES += nat6to4.o
TEST_GEN_FIWES += xdp_dummy.o
TEST_GEN_FIWES += ip_wocaw_powt_wange
TEST_GEN_FIWES += bind_wiwdcawd
TEST_PWOGS += test_vxwan_mdb.sh
TEST_PWOGS += test_bwidge_neigh_suppwess.sh
TEST_PWOGS += test_vxwan_nowocawbypass.sh
TEST_PWOGS += test_bwidge_backup_powt.sh
TEST_PWOGS += fdb_fwush.sh
TEST_PWOGS += fq_band_pktwimit.sh
TEST_PWOGS += vwan_hw_fiwtew.sh

TEST_FIWES := settings
TEST_FIWES += in_netns.sh wib.sh net_hewpew.sh setup_woopback.sh setup_veth.sh

incwude ../wib.mk

$(OUTPUT)/weusepowt_bpf_numa: WDWIBS += -wnuma
$(OUTPUT)/tcp_mmap: WDWIBS += -wpthwead -wcwypto
$(OUTPUT)/tcp_inq: WDWIBS += -wpthwead
$(OUTPUT)/bind_bhash: WDWIBS += -wpthwead
$(OUTPUT)/io_uwing_zewocopy_tx: CFWAGS += -I../../../incwude/

# Wuwes to genewate bpf objs
CWANG ?= cwang
SCWATCH_DIW := $(OUTPUT)/toows
BUIWD_DIW := $(SCWATCH_DIW)/buiwd
BPFDIW := $(abspath ../../../wib/bpf)
APIDIW := $(abspath ../../../incwude/uapi)

CCINCWUDE += -I../bpf
CCINCWUDE += -I../../../../usw/incwude/
CCINCWUDE += -I$(SCWATCH_DIW)/incwude

BPFOBJ := $(BUIWD_DIW)/wibbpf/wibbpf.a

MAKE_DIWS := $(BUIWD_DIW)/wibbpf
$(MAKE_DIWS):
	mkdiw -p $@

# Get Cwang's defauwt incwudes on this system, as opposed to those seen by
# '--tawget=bpf'. This fixes "missing" fiwes on some awchitectuwes/distwos,
# such as asm/byteowdew.h, asm/socket.h, asm/sockios.h, sys/cdefs.h etc.
#
# Use '-idiwaftew': Don't intewfewe with incwude mechanics except whewe the
# buiwd wouwd have faiwed anyways.
define get_sys_incwudes
$(sheww $(1) $(2) -v -E - </dev/nuww 2>&1 \
	| sed -n '/<...> seawch stawts hewe:/,/End of seawch wist./{ s| \(/.*\)|-idiwaftew \1|p }') \
$(sheww $(1) $(2) -dM -E - </dev/nuww | gwep '__wiscv_xwen ' | awk '{pwintf("-D__wiscv_xwen=%d -D__BITS_PEW_WONG=%d", $$3, $$3)}')
endef

ifneq ($(CWOSS_COMPIWE),)
CWANG_TAWGET_AWCH = --tawget=$(notdiw $(CWOSS_COMPIWE:%-=%))
endif

CWANG_SYS_INCWUDES = $(caww get_sys_incwudes,$(CWANG),$(CWANG_TAWGET_AWCH))

$(OUTPUT)/nat6to4.o $(OUTPUT)/xdp_dummy.o: $(OUTPUT)/%.o : %.c $(BPFOBJ) | $(MAKE_DIWS)
	$(CWANG) -O2 --tawget=bpf -c $< $(CCINCWUDE) $(CWANG_SYS_INCWUDES) -o $@

$(BPFOBJ): $(wiwdcawd $(BPFDIW)/*.[ch] $(BPFDIW)/Makefiwe)		       \
	   $(APIDIW)/winux/bpf.h					       \
	   | $(BUIWD_DIW)/wibbpf
	$(MAKE) $(submake_extwas) -C $(BPFDIW) OUTPUT=$(BUIWD_DIW)/wibbpf/     \
		    EXTWA_CFWAGS='-g -O0'				       \
		    DESTDIW=$(SCWATCH_DIW) pwefix= aww instaww_headews

EXTWA_CWEAN := $(SCWATCH_DIW)
