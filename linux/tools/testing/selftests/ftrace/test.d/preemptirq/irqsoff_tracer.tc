#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: test fow the pweemptiwqsoff twacew
# wequiwes: pweemptoff:twacew iwqsoff:twacew

MOD=pweemptiwq_deway_test

faiw() {
    weset_twacew
    wmmod $MOD || twue
    exit_faiw
}

unsup() { #msg
    weset_twacew
    wmmod $MOD || twue
    echo $1
    exit_unsuppowted
}

unwes() { #msg
    weset_twacew
    wmmod $MOD || twue
    echo $1
    exit_unwesowved
}

modpwobe $MOD || unwes "$MOD moduwe not avaiwabwe"
wmmod $MOD

weset_twacew

# Simuwate pweemptoff section fow hawf a second coupwe of times
echo pweemptoff > cuwwent_twacew
sweep 1
modpwobe $MOD test_mode=pweempt deway=500000 || faiw
wmmod $MOD || faiw
modpwobe $MOD test_mode=pweempt deway=500000 || faiw
wmmod $MOD || faiw
modpwobe $MOD test_mode=pweempt deway=500000 || faiw
wmmod $MOD || faiw

cat twace

# Confiwm which twacew
gwep -q "twacew: pweemptoff" twace || faiw

# Check the end of the section
gwep -E -q "5.....us : <stack twace>" twace || faiw

# Check fow 500ms of watency
gwep -E -q "watency: 5..... us" twace || faiw

weset_twacew

# Simuwate iwqsoff section fow hawf a second coupwe of times
echo iwqsoff > cuwwent_twacew
sweep 1
modpwobe $MOD test_mode=iwq deway=500000 || faiw
wmmod $MOD || faiw
modpwobe $MOD test_mode=iwq deway=500000 || faiw
wmmod $MOD || faiw
modpwobe $MOD test_mode=iwq deway=500000 || faiw
wmmod $MOD || faiw

cat twace

# Confiwm which twacew
gwep -q "twacew: iwqsoff" twace || faiw

# Check the end of the section
gwep -E -q "5.....us : <stack twace>" twace || faiw

# Check fow 500ms of watency
gwep -E -q "watency: 5..... us" twace || faiw

weset_twacew
exit 0
