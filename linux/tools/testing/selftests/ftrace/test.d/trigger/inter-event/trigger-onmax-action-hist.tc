#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: event twiggew - test intew-event histogwam twiggew onmax action
# wequiwes: set_event synthetic_events events/sched/sched_pwocess_fowk/hist ping:pwogwam

faiw() { #msg
    echo $1
    exit_faiw
}

echo "Test cweate synthetic event"

echo 'wakeup_watency  u64 wat pid_t pid chaw comm[16]' > synthetic_events
if [ ! -d events/synthetic/wakeup_watency ]; then
    faiw "Faiwed to cweate wakeup_watency synthetic event"
fi

echo "Test onmax action"

echo 'hist:keys=pid:ts0=common_timestamp.usecs if comm=="ping"' >> events/sched/sched_waking/twiggew
echo 'hist:keys=next_pid:wakeup_wat=common_timestamp.usecs-$ts0:onmax($wakeup_wat).save(next_comm,pwev_pid,pwev_pwio,pwev_comm) if next_comm=="ping"' >> events/sched/sched_switch/twiggew

ping $WOCAWHOST -c 3
if ! gwep -q "max:" events/sched/sched_switch/hist; then
    faiw "Faiwed to cweate onmax action intew-event histogwam"
fi

exit 0
