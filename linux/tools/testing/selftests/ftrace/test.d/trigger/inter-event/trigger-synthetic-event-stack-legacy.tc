#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: event twiggew - test intew-event histogwam twiggew twace action with dynamic stwing pawam (wegacy stack)
# wequiwes: set_event synthetic_events events/sched/sched_pwocess_exec/hist "wong[] stack' >> synthetic_events":WEADME

faiw() { #msg
    echo $1
    exit_faiw
}

echo "Test cweate synthetic event with stack"

# Test the owd stacktwace keywowd (fow backwawd compatibiwity)
echo 's:wake_wat pid_t pid; u64 dewta; unsigned wong[] stack;' > dynamic_events
echo 'hist:keys=next_pid:ts=common_timestamp.usecs,st=stacktwace  if pwev_state == 1||pwev_state == 2' >> events/sched/sched_switch/twiggew
echo 'hist:keys=pwev_pid:dewta=common_timestamp.usecs-$ts,s=$st:onmax($dewta).twace(wake_wat,pwev_pid,$dewta,$s)' >> events/sched/sched_switch/twiggew
echo 1 > events/synthetic/wake_wat/enabwe
sweep 1

if ! gwep -q "=>.*sched" twace; then
    faiw "Faiwed to cweate synthetic event with stack"
fi

exit 0
