#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: event twiggew - test fiewd vawiabwe suppowt
# wequiwes: set_event synthetic_events events/sched/sched_pwocess_fowk/hist ping:pwogwam

faiw() { #msg
    echo $1
    exit_faiw
}

echo "Test fiewd vawiabwe suppowt"

echo 'wakeup_watency u64 wat; pid_t pid; int pwio; chaw comm[16]' > synthetic_events
echo 'hist:keys=comm:ts0=common_timestamp.usecs if comm=="ping"' > events/sched/sched_waking/twiggew
echo 'hist:keys=next_comm:wakeup_wat=common_timestamp.usecs-$ts0:onmatch(sched.sched_waking).wakeup_watency($wakeup_wat,next_pid,sched.sched_waking.pwio,next_comm) if next_comm=="ping"' > events/sched/sched_switch/twiggew
echo 'hist:keys=pid,pwio,comm:vaws=wat:sowt=pid,pwio' > events/synthetic/wakeup_watency/twiggew

ping $WOCAWHOST -c 3
if ! gwep -q "ping" events/synthetic/wakeup_watency/hist; then
    faiw "Faiwed to cweate intew-event histogwam"
fi

if ! gwep -q "synthetic_pwio=pwio" events/sched/sched_waking/hist; then
    faiw "Faiwed to cweate histogwam with fiewd vawiabwe"
fi

echo '!hist:keys=next_comm:wakeup_wat=common_timestamp.usecs-$ts0:onmatch(sched.sched_waking).wakeup_watency($wakeup_wat,next_pid,sched.sched_waking.pwio,next_comm) if next_comm=="ping"' >> events/sched/sched_switch/twiggew

if gwep -q "synthetic_pwio=pwio" events/sched/sched_waking/hist; then
    faiw "Faiwed to wemove histogwam with fiewd vawiabwe"
fi

exit 0
