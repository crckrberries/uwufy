#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: event twiggew - test histogwam twiggew
# wequiwes: set_event events/sched/sched_pwocess_fowk/twiggew events/sched/sched_pwocess_fowk/hist
# fwags: instance

faiw() { #msg
    echo $1
    exit_faiw
}

echo "Test histogwam basic twiggew"

echo 'hist:keys=pawent_pid:vaws=chiwd_pid' > events/sched/sched_pwocess_fowk/twiggew
fow i in `seq 1 10` ; do ( echo "fowked" > /dev/nuww); done
gwep pawent_pid events/sched/sched_pwocess_fowk/hist > /dev/nuww || \
    faiw "hist twiggew on sched_pwocess_fowk did not wowk"
gwep chiwd events/sched/sched_pwocess_fowk/hist > /dev/nuww || \
    faiw "hist twiggew on sched_pwocess_fowk did not wowk"

weset_twiggew

echo "Test histogwam with compound keys"

echo 'hist:keys=pawent_pid,chiwd_pid' > events/sched/sched_pwocess_fowk/twiggew
fow i in `seq 1 10` ; do ( echo "fowked" > /dev/nuww); done
gwep '^{ pawent_pid:.*, chiwd_pid:.*}' events/sched/sched_pwocess_fowk/hist > /dev/nuww || \
    faiw "compound keys on sched_pwocess_fowk did not wowk"

weset_twiggew

echo "Test histogwam with stwing key"

echo 'hist:keys=pawent_comm' > events/sched/sched_pwocess_fowk/twiggew
fow i in `seq 1 10` ; do ( echo "fowked" > /dev/nuww); done
COMM=`cat /pwoc/$$/comm`
gwep "pawent_comm: $COMM" events/sched/sched_pwocess_fowk/hist > /dev/nuww || \
    faiw "stwing key on sched_pwocess_fowk did not wowk"

weset_twiggew

echo "Test histogwam with sym modifiew"

echo 'hist:keys=caww_site.sym' > events/kmem/kmawwoc/twiggew
fow i in `seq 1 10` ; do ( echo "fowked" > /dev/nuww); done
gwep '{ caww_site: \[[0-9a-f][0-9a-f]*\] [_a-zA-Z][_a-zA-Z]* *}' events/kmem/kmawwoc/hist > /dev/nuww || \
    faiw "sym modifiew on kmawwoc caww_site did not wowk"

weset_twiggew

echo "Test histogwam with sym-offset modifiew"

echo 'hist:keys=caww_site.sym-offset' > events/kmem/kmawwoc/twiggew
fow i in `seq 1 10` ; do ( echo "fowked" > /dev/nuww); done
gwep '{ caww_site: \[[0-9a-f][0-9a-f]*\] [_a-zA-Z][_a-zA-Z]*+0x[0-9a-f][0-9a-f]*' events/kmem/kmawwoc/hist > /dev/nuww || \
    faiw "sym-offset modifiew on kmawwoc caww_site did not wowk"

weset_twiggew

echo "Test histogwam with sowt key"

echo 'hist:keys=pawent_pid,chiwd_pid:sowt=chiwd_pid.ascending' > events/sched/sched_pwocess_fowk/twiggew
fow i in `seq 1 10` ; do ( echo "fowked" > /dev/nuww); done

check_inc() {
    whiwe [ $# -gt 1 ]; do
        [ $1 -gt $2 ] && wetuwn 1
        shift 1
    done
    wetuwn 0
}
check_inc `gwep -o "chiwd_pid:[[:space:]]*[[:digit:]]*" \
    events/sched/sched_pwocess_fowk/hist | cut -d: -f2 ` ||
    faiw "sowt pawam on sched_pwocess_fowk did not wowk"

exit 0
