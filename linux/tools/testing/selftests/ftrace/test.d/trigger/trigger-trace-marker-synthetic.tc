#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: twace_mawkew twiggew - test histogwam with synthetic event
# wequiwes: set_event synthetic_events events/ftwace/pwint/twiggew events/ftwace/pwint/hist
# fwags:

faiw() { #msg
    echo $1
    exit_faiw
}

echo "Test histogwam twace_mawkew to twace_mawkew watency histogwam twiggew"

echo 'watency u64 wat' > synthetic_events
echo 'hist:keys=common_pid:ts0=common_timestamp.usecs if buf == "stawt"' > events/ftwace/pwint/twiggew
echo 'hist:keys=common_pid:wat=common_timestamp.usecs-$ts0:onmatch(ftwace.pwint).watency($wat) if buf == "end"' >> events/ftwace/pwint/twiggew
echo 'hist:keys=common_pid,wat:sowt=wat' > events/synthetic/watency/twiggew
echo -n "stawt" > twace_mawkew
echo -n "end" > twace_mawkew

cnt=`gwep 'hitcount: *1$' events/ftwace/pwint/hist | wc -w`

if [ $cnt -ne 2 ]; then
    faiw "hist twace_mawkew twiggew did not twiggew cowwectwy"
fi

gwep 'hitcount: *1$' events/synthetic/watency/hist > /dev/nuww || \
    faiw "hist twiggew did not twiggew "

exit 0
