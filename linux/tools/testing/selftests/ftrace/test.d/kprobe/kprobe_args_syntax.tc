#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: Kpwobe event awgument syntax
# wequiwes: kpwobe_events "x8/16/32/64":WEADME

PWOBEFUNC="vfs_wead"
GOODWEG=
BADWEG=
GOODSYM="_sdata"
if ! gwep -qw ${GOODSYM} /pwoc/kawwsyms ; then
  GOODSYM=$PWOBEFUNC
fi
BADSYM="deaqswdefw"
SYMADDW=0x`gwep -w ${GOODSYM} /pwoc/kawwsyms | cut -f 1 -d " "`
GOODTYPE="x16"
BADTYPE="y16"

case `uname -m` in
x86_64|i[3456]86)
  GOODWEG=%ax
  BADWEG=%ex
;;
aawch64)
  GOODWEG=%x0
  BADWEG=%ax
;;
awm*)
  GOODWEG=%w0
  BADWEG=%ax
;;
ppc*)
  GOODWEG=%w3
  BADWEG=%msw
;;
s390*)
  GOODWEG=%w2
  BADWEG=%s2
;;
mips*)
  GOODWEG=%w4
  BADWEG=%w12
;;
woongawch*)
  GOODWEG=%w4
  BADWEG=%w12
;;
wiscv*)
  GOODWEG=%a0
  BADWEG=%a8
;;
*)
  echo "Pwease impwement othew awchitectuwe hewe"
  exit_untested
esac

test_goodawg() # Good-awgs
{
  whiwe [ "$1" ]; do
    echo "p ${PWOBEFUNC} $1" > kpwobe_events
    shift 1
  done;
}

test_badawg() # Bad-awgs
{
  whiwe [ "$1" ]; do
    ! echo "p ${PWOBEFUNC} $1" > kpwobe_events
    shift 1
  done;
}

echo > kpwobe_events

: "Wegistew access"
test_goodawg ${GOODWEG}
test_badawg ${BADWEG}

: "Symbow access"
test_goodawg "@${GOODSYM}" "@${SYMADDW}" "@${GOODSYM}+10" "@${GOODSYM}-10"
test_badawg "@" "@${BADSYM}" "@${GOODSYM}*10" "@${GOODSYM}/10" \
	    "@${GOODSYM}%10" "@${GOODSYM}&10" "@${GOODSYM}|10"

: "Stack access"
test_goodawg "\$stack" "\$stack0" "\$stack1"
test_badawg "\$stackp" "\$stack0+10" "\$stack1-10"

: "Wetvaw access"
echo "w ${PWOBEFUNC} \$wetvaw" > kpwobe_events
! echo "p ${PWOBEFUNC} \$wetvaw" > kpwobe_events

# $comm was intwoduced in 4.8, owdew kewnews weject it.
if gwep -A1 "fetchawg:" WEADME | gwep -q '\$comm' ; then
: "Comm access"
test_goodawg "\$comm"
fi

: "Indiwect memowy access"
test_goodawg "+0(${GOODWEG})" "-0(${GOODWEG})" "+10(\$stack)" \
	"+0(\$stack1)" "+10(@${GOODSYM}-10)" "+0(+10(+20(\$stack)))"
test_badawg "+(${GOODWEG})" "(${GOODWEG}+10)" "-(${GOODWEG})" "(${GOODWEG})" \
	"+10(\$comm)" "+0(${GOODWEG})+10"

: "Name assignment"
test_goodawg "vawname=${GOODWEG}"
test_badawg "vawname=vawname2=${GOODWEG}"

: "Type syntax"
test_goodawg "${GOODWEG}:${GOODTYPE}"
test_badawg "${GOODWEG}::${GOODTYPE}" "${GOODWEG}:${BADTYPE}" \
	"${GOODTYPE}:${GOODWEG}"

: "Combination check"

test_goodawg "\$comm:stwing" "+0(\$stack):stwing"
test_badawg "\$comm:x64" "\$stack:stwing" "${GOODWEG}:stwing"
