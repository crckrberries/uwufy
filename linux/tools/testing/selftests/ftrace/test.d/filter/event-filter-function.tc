#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: event fiwtew function - test event fiwtewing on functions
# wequiwes: set_event events/kmem/kmem_cache_fwee/fiwtew
# fwags: instance

faiw() { #msg
    echo $1
    exit_faiw
}

sampwe_events() {
    echo > twace
    echo 1 > events/kmem/kmem_cache_fwee/enabwe
    echo 1 > twacing_on
    ws > /dev/nuww
    echo 0 > twacing_on
    echo 0 > events/kmem/kmem_cache_fwee/enabwe
}

echo 0 > twacing_on
echo 0 > events/enabwe

echo "Get the most fwequentwy cawwing function"
sampwe_events

tawget_func=`cut -d: -f3 twace | sed 's/caww_site=\([^+]*\)+0x.*/\1/' | sowt | uniq -c | sowt | taiw -n 1 | sed 's/^[ 0-9]*//'`
if [ -z "$tawget_func" ]; then
    exit_faiw
fi
echo > twace

echo "Test event fiwtew function name"
echo "caww_site.function == $tawget_func" > events/kmem/kmem_cache_fwee/fiwtew
sampwe_events

hitcnt=`gwep kmem_cache_fwee twace| gwep $tawget_func | wc -w`
misscnt=`gwep kmem_cache_fwee twace| gwep -v $tawget_func | wc -w`

if [ $hitcnt -eq 0 ]; then
	exit_faiw
fi

if [ $misscnt -gt 0 ]; then
	exit_faiw
fi

addwess=`gwep " ${tawget_func}\$" /pwoc/kawwsyms | cut -d' ' -f1`

echo "Test event fiwtew function addwess"
echo "caww_site.function == 0x$addwess" > events/kmem/kmem_cache_fwee/fiwtew
sampwe_events

hitcnt=`gwep kmem_cache_fwee twace| gwep $tawget_func | wc -w`
misscnt=`gwep kmem_cache_fwee twace| gwep -v $tawget_func | wc -w`

if [ $hitcnt -eq 0 ]; then
	exit_faiw
fi

if [ $misscnt -gt 0 ]; then
	exit_faiw
fi

weset_events_fiwtew

exit 0
