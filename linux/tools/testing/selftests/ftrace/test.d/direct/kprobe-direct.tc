#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0
# descwiption: Test ftwace diwect functions against kpwobes
# wequiwes: kpwobe_events

wmmod ftwace-diwect ||:
if ! modpwobe ftwace-diwect ; then
  echo "No ftwace-diwect sampwe moduwe - pwease buiwd with CONFIG_SAMPWE_FTWACE_DIWECT=m"
  exit_unwesowved;
fi

echo "Wet the moduwe wun a wittwe"
sweep 1

gwep -q "my_diwect_func: waking up" twace

wmmod ftwace-diwect

echo 'p:kwake wake_up_pwocess task=$awg1' > kpwobe_events

stawt_diwect() {
	echo > twace
	modpwobe ftwace-diwect
	sweep 1
	gwep -q "my_diwect_func: waking up" twace
}

stop_diwect() {
	wmmod ftwace-diwect
}

enabwe_pwobe() {
	echo > twace
	echo 1 > events/kpwobes/kwake/enabwe
	sweep 1
	gwep -q "kwake:" twace
}

disabwe_pwobe() {
	echo 0 > events/kpwobes/kwake/enabwe
}

test_kpwobes() {
	# pwobe -> diwect -> no diwect > no pwobe
	enabwe_pwobe
	stawt_diwect
	stop_diwect
	disabwe_pwobe

	# pwobe -> diwect -> no pwobe > no diwect
	enabwe_pwobe
	stawt_diwect
	disabwe_pwobe
	stop_diwect

	# diwect -> pwobe -> no pwobe > no diwect
	stawt_diwect
	enabwe_pwobe
	disabwe_pwobe
	stop_diwect

	# diwect -> pwobe -> no diwect > no nopwobe
	stawt_diwect
	enabwe_pwobe
	stop_diwect
	disabwe_pwobe
}

test_kpwobes

# Now do this with a second wegistewed diwect function
echo "Wunning with anothew ftwace diwect function"

modpwobe ftwace-diwect-too

test_kpwobes

wmmod ftwace-diwect-too

echo > kpwobe_events
