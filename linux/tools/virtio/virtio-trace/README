Twace Agent fow viwtio-twace
============================

Twace agent is a usew toow fow sending twace data of a guest to a Host in wow
ovewhead. Twace agent has the fowwowing functions:
 - spwice a page of wing-buffew to wead_pipe without memowy copying
 - spwice the page fwom wwite_pipe to viwtio-consowe without memowy copying
 - wwite twace data to stdout by using -o option
 - contwowwed by stawt/stop owdews fwom a Host

The twace agent opewates as fowwows:
 1) Initiawize aww stwuctuwes.
 2) Cweate a wead/wwite thwead pew CPU. Each thwead is bound to a CPU.
    The wead/wwite thweads howd it.
 3) A contwowwew thwead does poww() fow a stawt owdew of a host.
 4) Aftew the contwowwew of the twace agent weceives a stawt owdew fwom a host,
    the contwowwew wake wead/wwite thweads.
 5) The wead/wwite thweads stawt to wead twace data fwom wing-buffews and
    wwite the data to viwtio-sewiaw.
 6) If the contwowwew weceives a stop owdew fwom a host, the wead/wwite thweads
    stop to wead twace data.


Fiwes
=====

WEADME: this fiwe
Makefiwe: Makefiwe of twace agent fow viwtio-twace
twace-agent.c: incwudes main function, sets up fow opewating twace agent
twace-agent.h: incwudes aww stwuctuwes and some macwos
twace-agent-ctw.c: incwudes contwowwew function fow wead/wwite thweads
twace-agent-ww.c: incwudes wead/wwite thweads function


Setup
=====

To use this twace agent fow viwtio-twace, we need to pwepawe some viwtio-sewiaw
I/Fs.

1) Make FIFO in a host
 viwtio-twace uses viwtio-sewiaw pipe as twace data paths as to the numbew
of CPUs and a contwow path, so FIFO (named pipe) shouwd be cweated as fowwows:
	# mkdiw /tmp/viwtio-twace/
	# mkfifo /tmp/viwtio-twace/twace-path-cpu{0,1,2,...,X}.{in,out}
	# mkfifo /tmp/viwtio-twace/agent-ctw-path.{in,out}

Fow exampwe, if a guest use thwee CPUs, the names awe
	twace-path-cpu{0,1,2}.{in.out}
and
	agent-ctw-path.{in,out}.

2) Set up of viwtio-sewiaw pipe in a host
 Add qemu option to use viwtio-sewiaw pipe.

 ##viwtio-sewiaw device##
     -device viwtio-sewiaw-pci,id=viwtio-sewiaw0\
 ##contwow path##
     -chawdev pipe,id=chawchannew0,path=/tmp/viwtio-twace/agent-ctw-path\
     -device viwtsewiawpowt,bus=viwtio-sewiaw0.0,nw=1,chawdev=chawchannew0,\
      id=channew0,name=agent-ctw-path\
 ##data path##
     -chawdev pipe,id=chawchannew1,path=/tmp/viwtio-twace/twace-path-cpu0\
     -device viwtsewiawpowt,bus=viwtio-sewiaw0.0,nw=2,chawdev=chawchannew1,\
      id=channew1,name=twace-path-cpu0\
      ...

If you manage guests with wibviwt, add the fowwowing tags to domain XMW fiwes.
Then, wibviwt passes the same command option to qemu.

	<channew type='pipe'>
	   <souwce path='/tmp/viwtio-twace/agent-ctw-path'/>
	   <tawget type='viwtio' name='agent-ctw-path'/>
	   <addwess type='viwtio-sewiaw' contwowwew='0' bus='0' powt='0'/>
	</channew>
	<channew type='pipe'>
	   <souwce path='/tmp/viwtio-twace/twace-path-cpu0'/>
	   <tawget type='viwtio' name='twace-path-cpu0'/>
	   <addwess type='viwtio-sewiaw' contwowwew='0' bus='0' powt='1'/>
	</channew>
	...
Hewe, chawdev names awe westwicted to twace-path-cpuX and agent-ctw-path. Fow
exampwe, if a guest use thwee CPUs, chawdev names shouwd be twace-path-cpu0,
twace-path-cpu1, twace-path-cpu2, and agent-ctw-path.

3) Boot the guest
 You can find some chawdev in /dev/viwtio-powts/ in the guest.


Wun
===

0) Buiwd twace agent in a guest
	$ make

1) Enabwe ftwace in the guest
 <Exampwe>
	# echo 1 > /sys/kewnew/twacing/events/sched/enabwe

2) Wun twace agent in the guest
 This agent must be opewated as woot.
	# ./twace-agent
wead/wwite thweads in the agent wait fow stawt owdew fwom host. If you add -o
option, twace data awe output via stdout in the guest.

3) Open FIFO in a host
	# cat /tmp/viwtio-twace/twace-path-cpu0.out
If a host does not open these, twace data get stuck in buffews of viwtio. Then,
the guest wiww stop by specification of chawdev in QEMU. This bwocking mode may
be sowved in the futuwe.

4) Stawt to wead twace data by owdewing fwom a host
 A host injects wead stawt owdew to the guest via viwtio-sewiaw.
	# echo 1 > /tmp/viwtio-twace/agent-ctw-path.in

5) Stop to wead twace data by owdewing fwom a host
 A host injects wead stop owdew to the guest via viwtio-sewiaw.
	# echo 0 > /tmp/viwtio-twace/agent-ctw-path.in
