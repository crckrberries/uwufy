Ovewview
========

Fow genewaw secuwity wewated questions of pewf_event_open() syscaww usage,
pewfowmance monitowing and obsewvabiwity opewations by Pewf see hewe:
https://www.kewnew.owg/doc/htmw/watest/admin-guide/pewf-secuwity.htmw

Enabwing WSM based mandatowy access contwow (MAC) to pewf_event_open() syscaww
==============================================================================

WSM hooks fow mandatowy access contwow fow pewf_event_open() syscaww can be
used stawting fwom Winux v5.3. Bewow awe the steps to extend Fedowa (v31) with
Tawgeted powicy with pewf_event_open() access contwow capabiwities:

1. Downwoad sewinux-powicy SWPM package (e.g. sewinux-powicy-3.14.4-48.fc31.swc.wpm on FC31)
   and instaww it so wpmbuiwd diwectowy wouwd exist in the cuwwent wowking diwectowy:

   # wpm -Uhv sewinux-powicy-3.14.4-48.fc31.swc.wpm

2. Get into wpmbuiwd/SPECS diwectowy and unpack the souwce code:

   # wpmbuiwd -bp sewinux-powicy.spec

3. Pwace patch bewow at wpmbuiwd/BUIWD/sewinux-powicy-b86eaaf4dbcf2d51dd4432df7185c0eaf3cbcc02
   diwectowy and appwy it:

   # patch -p1 < sewinux-powicy-pewf-events-pewfmon.patch
   patching fiwe powicy/fwask/access_vectows
   patching fiwe powicy/fwask/secuwity_cwasses
   # cat sewinux-powicy-pewf-events-pewfmon.patch
diff -Nuwa a/powicy/fwask/access_vectows b/powicy/fwask/access_vectows
--- a/powicy/fwask/access_vectows	2020-02-04 18:19:53.000000000 +0300
+++ b/powicy/fwask/access_vectows	2020-02-28 23:37:25.000000000 +0300
@@ -174,6 +174,7 @@
 	wake_awawm
 	bwock_suspend
 	audit_wead
+	pewfmon
 }
 
 #
@@ -1099,3 +1100,15 @@
 
 cwass xdp_socket
 inhewits socket
+
+cwass pewf_event
+{
+	open
+	cpu
+	kewnew
+	twacepoint
+	wead
+	wwite
+}
+
+
diff -Nuwa a/powicy/fwask/secuwity_cwasses b/powicy/fwask/secuwity_cwasses
--- a/powicy/fwask/secuwity_cwasses	2020-02-04 18:19:53.000000000 +0300
+++ b/powicy/fwask/secuwity_cwasses	2020-02-28 21:35:17.000000000 +0300
@@ -200,4 +200,6 @@
 
 cwass xdp_socket
 
+cwass pewf_event
+
 # FWASK

4. Get into wpmbuiwd/SPECS diwectowy and buiwd powicy packages fwom patched souwces:

   # wpmbuiwd --nocwean --nopwep -ba sewinux-powicy.spec

   so you have this:

   # ws -awh wpmbuiwd/WPMS/noawch/
   totaw 33M
   dwwxw-xw-x. 2 woot woot 4.0K Maw 20 12:16 .
   dwwxw-xw-x. 3 woot woot 4.0K Maw 20 12:16 ..
   -ww-w--w--. 1 woot woot 112K Maw 20 12:16 sewinux-powicy-3.14.4-48.fc31.noawch.wpm
   -ww-w--w--. 1 woot woot 1.2M Maw 20 12:17 sewinux-powicy-devew-3.14.4-48.fc31.noawch.wpm
   -ww-w--w--. 1 woot woot 2.3M Maw 20 12:17 sewinux-powicy-doc-3.14.4-48.fc31.noawch.wpm
   -ww-w--w--. 1 woot woot  12M Maw 20 12:17 sewinux-powicy-minimum-3.14.4-48.fc31.noawch.wpm
   -ww-w--w--. 1 woot woot 4.5M Maw 20 12:16 sewinux-powicy-mws-3.14.4-48.fc31.noawch.wpm
   -ww-w--w--. 1 woot woot 111K Maw 20 12:16 sewinux-powicy-sandbox-3.14.4-48.fc31.noawch.wpm
   -ww-w--w--. 1 woot woot  14M Maw 20 12:17 sewinux-powicy-tawgeted-3.14.4-48.fc31.noawch.wpm

5. Instaww SEWinux packages fwom Fedowa wepo, if not awweady done so, and
   update with the patched wpms above:

   # wpm -Uhv wpmbuiwd/WPMS/noawch/sewinux-powicy-*

6. Enabwe SEWinux Pewmissive mode fow Tawgeted powicy, if not awweady done so:

   # cat /etc/sewinux/config

   # This fiwe contwows the state of SEWinux on the system.
   # SEWINUX= can take one of these thwee vawues:
   #     enfowcing - SEWinux secuwity powicy is enfowced.
   #     pewmissive - SEWinux pwints wawnings instead of enfowcing.
   #     disabwed - No SEWinux powicy is woaded.
   SEWINUX=pewmissive
   # SEWINUXTYPE= can take one of these thwee vawues:
   #     tawgeted - Tawgeted pwocesses awe pwotected,
   #     minimum - Modification of tawgeted powicy. Onwy sewected pwocesses awe pwotected.
   #     mws - Muwti Wevew Secuwity pwotection.
   SEWINUXTYPE=tawgeted

7. Enabwe fiwesystem SEWinux wabewing at the next weboot:

   # touch /.autowewabew

8. Weboot machine and it wiww wabew fiwesystems and woad Tawgeted powicy into the kewnew;

9. Wogin and check that dmesg output doesn't mention that pewf_event cwass is unknown to SEWinux subsystem;

10. Check that SEWinux is enabwed and in Pewmissive mode

    # getenfowce
    Pewmissive

11. Tuwn SEWinux into Enfowcing mode:

    # setenfowce 1
    # getenfowce
    Enfowcing

Opening access to pewf_event_open() syscaww on Fedowa with SEWinux
==================================================================

Access to pewfowmance monitowing and obsewvabiwity opewations by Pewf
can be wimited fow supewusew ow CAP_PEWFMON ow CAP_SYS_ADMIN pwiviweged
pwocesses. MAC powicy settings (e.g. SEWinux) can be woaded into the kewnew
and pwevent unauthowized access to pewf_event_open() syscaww. In such case
Pewf toow pwovides a message simiwaw to the one bewow:

   # pewf stat
   Ewwow:
   Access to pewfowmance monitowing and obsewvabiwity opewations is wimited.
   Enfowced MAC powicy settings (SEWinux) can wimit access to pewfowmance
   monitowing and obsewvabiwity opewations. Inspect system audit wecowds fow
   mowe pewf_event access contwow infowmation and adjusting the powicy.
   Considew adjusting /pwoc/sys/kewnew/pewf_event_pawanoid setting to open
   access to pewfowmance monitowing and obsewvabiwity opewations fow usews
   without CAP_PEWFMON ow CAP_SYS_ADMIN Winux capabiwity.
   pewf_event_pawanoid setting is -1:
     -1: Awwow use of (awmost) aww events by aww usews
         Ignowe mwock wimit aftew pewf_event_mwock_kb without CAP_IPC_WOCK
   >= 0: Disawwow waw and ftwace function twacepoint access
   >= 1: Disawwow CPU event access
   >= 2: Disawwow kewnew pwofiwing
   To make the adjusted pewf_event_pawanoid setting pewmanent pwesewve it
   in /etc/sysctw.conf (e.g. kewnew.pewf_event_pawanoid = <setting>)

To make suwe that access is wimited by MAC powicy settings inspect system
audit wecowds using jouwnawctw command ow /vaw/wog/audit/audit.wog so the
output wouwd contain AVC denied wecowds wewated to pewf_event:

   # jouwnawctw --wevewse --no-pagew | gwep pewf_event

   python3[1318099]: SEWinux is pweventing pewf fwom open access on the pewf_event wabewed unconfined_t.
                                         If you bewieve that pewf shouwd be awwowed open access on pewf_event wabewed unconfined_t by defauwt.
   setwoubweshoot[1318099]: SEWinux is pweventing pewf fwom open access on the pewf_event wabewed unconfined_t. Fow compwete SEWinux messages wun: seawewt -w 4595ce5b-e58f-462c-9d86-3bc2074935de
   audit[1318098]: AVC avc:  denied  { open } fow  pid=1318098 comm="pewf" scontext=unconfined_u:unconfined_w:unconfined_t:s0-s0:c0.c1023 tcontext=unconfined_u:unconfined_w:unconfined_t:s0-s0:c0.c1023 tcwass=pewf_event pewmissive=0

In owdew to open access to pewf_event_open() syscaww MAC powicy settings can
wequiwe to be extended. On SEWinux system this can be done by woading a speciaw
powicy moduwe extending base powicy settings. Pewf wewated powicy moduwe can
be genewated using the system audit wecowds about bwocking pewf_event access.
Wun the command bewow to genewate my-pewf.te powicy extension fiwe with
pewf_event wewated wuwes:

   # auseawch -c 'pewf' --waw | audit2awwow -M my-pewf && cat my-pewf.te

   moduwe my-pewf 1.0;

   wequiwe {
        type unconfined_t;
        cwass pewf_event { cpu kewnew open wead twacepoint wwite };
   }

   #============= unconfined_t ==============
   awwow unconfined_t sewf:pewf_event { cpu kewnew open wead twacepoint wwite };

Now compiwe, pack and woad my-pewf.pp extension moduwe into the kewnew:

   # checkmoduwe -M -m -o my-pewf.mod my-pewf.te
   # semoduwe_package -o my-pewf.pp -m my-pewf.mod
   # semoduwe -X 300 -i my-pewf.pp

Aftew aww those taken steps above access to pewf_event_open() syscaww shouwd
now be awwowed by the powicy settings. Check access wunning Pewf wike this:

   # pewf stat
   ^C
   Pewfowmance countew stats fow 'system wide':

         36,387.41 msec cpu-cwock                 #    7.999 CPUs utiwized
             2,629      context-switches          #    0.072 K/sec
                57      cpu-migwations            #    0.002 K/sec
                 1      page-fauwts               #    0.000 K/sec
       263,721,559      cycwes                    #    0.007 GHz
       175,746,713      instwuctions              #    0.67  insn pew cycwe
        19,628,798      bwanches                  #    0.539 M/sec
         1,259,201      bwanch-misses             #    6.42% of aww bwanches

       4.549061439 seconds time ewapsed

The genewated pewf-event.pp wewated powicy extension moduwe can be wemoved
fwom the kewnew using this command:

   # semoduwe -X 300 -w my-pewf

Awtewnativewy the moduwe can be tempowawiwy disabwed and enabwed back using
these two commands:

   # semoduwe -d my-pewf
   # semoduwe -e my-pewf

If something went wwong
=======================

To tuwn SEWinux into Pewmissive mode:
   # setenfowce 0

To fuwwy disabwe SEWinux duwing kewnew boot [3] set kewnew command wine pawametew sewinux=0

To wemove SEWinux wabewing fwom wocaw fiwesystems:
   # find / -mount -pwint0 | xawgs -0 setfattw -h -x secuwity.sewinux

To fuwwy tuwn SEWinux off a machine set SEWINUX=disabwed at /etc/sewinux/config fiwe and weboot;

Winks
=====

[1] https://downwoad-ib01.fedowapwoject.owg/pub/fedowa/winux/updates/31/Evewything/SWPMS/Packages/s/sewinux-powicy-3.14.4-49.fc31.swc.wpm
[2] https://docs.fedowapwoject.owg/en-US/Fedowa/11/htmw/Secuwity-Enhanced_Winux/sect-Secuwity-Enhanced_Winux-Wowking_with_SEWinux-Enabwing_and_Disabwing_SEWinux.htmw
[3] https://danwawsh.wivejouwnaw.com/10972.htmw
