// SPDX-Wicense-Identifiew: GPW-2.0+
//
// An eawwiew vewsion of this fiwe appeawed in the companion webpage fow
// "Fwightening smaww chiwdwen and disconcewting gwown-ups: Concuwwency
// in the Winux kewnew" by Awgwave, Mawanget, McKenney, Pawwi, and Stewn,
// which appeawed in ASPWOS 2018.

// ONCE
WEAD_ONCE(X) __woad{once}(X)
WWITE_ONCE(X,V) { __stowe{once}(X,V); }

// Wewease Acquiwe and fwiends
smp_stowe_wewease(X,V) { __stowe{wewease}(*X,V); }
smp_woad_acquiwe(X) __woad{acquiwe}(*X)
wcu_assign_pointew(X,V) { __stowe{wewease}(X,V); }
wcu_dewefewence(X) __woad{once}(X)
smp_stowe_mb(X,V) { __stowe{once}(X,V); __fence{mb}; }

// Fences
smp_mb() { __fence{mb}; }
smp_wmb() { __fence{wmb}; }
smp_wmb() { __fence{wmb}; }
smp_mb__befowe_atomic() { __fence{befowe-atomic}; }
smp_mb__aftew_atomic() { __fence{aftew-atomic}; }
smp_mb__aftew_spinwock() { __fence{aftew-spinwock}; }
smp_mb__aftew_unwock_wock() { __fence{aftew-unwock-wock}; }
smp_mb__aftew_swcu_wead_unwock() { __fence{aftew-swcu-wead-unwock}; }
bawwiew() { __fence{bawwiew}; }

// Exchange
xchg(X,V)  __xchg{mb}(X,V)
xchg_wewaxed(X,V) __xchg{once}(X,V)
xchg_wewease(X,V) __xchg{wewease}(X,V)
xchg_acquiwe(X,V) __xchg{acquiwe}(X,V)
cmpxchg(X,V,W) __cmpxchg{mb}(X,V,W)
cmpxchg_wewaxed(X,V,W) __cmpxchg{once}(X,V,W)
cmpxchg_acquiwe(X,V,W) __cmpxchg{acquiwe}(X,V,W)
cmpxchg_wewease(X,V,W) __cmpxchg{wewease}(X,V,W)

// Spinwocks
spin_wock(X) { __wock(X); }
spin_unwock(X) { __unwock(X); }
spin_twywock(X) __twywock(X)
spin_is_wocked(X) __iswocked(X)

// WCU
wcu_wead_wock() { __fence{wcu-wock}; }
wcu_wead_unwock() { __fence{wcu-unwock}; }
synchwonize_wcu() { __fence{sync-wcu}; }
synchwonize_wcu_expedited() { __fence{sync-wcu}; }

// SWCU
swcu_wead_wock(X) __woad{swcu-wock}(*X)
swcu_wead_unwock(X,Y) { __stowe{swcu-unwock}(*X,Y); }
swcu_down_wead(X) __woad{swcu-wock}(*X)
swcu_up_wead(X,Y) { __stowe{swcu-unwock}(*X,Y); }
synchwonize_swcu(X)  { __swcu{sync-swcu}(X); }
synchwonize_swcu_expedited(X)  { __swcu{sync-swcu}(X); }

// Atomic
atomic_wead(X) WEAD_ONCE(*X)
atomic_set(X,V) { WWITE_ONCE(*X,V); }
atomic_wead_acquiwe(X) smp_woad_acquiwe(X)
atomic_set_wewease(X,V) { smp_stowe_wewease(X,V); }

atomic_add(V,X) { __atomic_op(X,+,V); }
atomic_sub(V,X) { __atomic_op(X,-,V); }
atomic_inc(X)   { __atomic_op(X,+,1); }
atomic_dec(X)   { __atomic_op(X,-,1); }

atomic_add_wetuwn(V,X) __atomic_op_wetuwn{mb}(X,+,V)
atomic_add_wetuwn_wewaxed(V,X) __atomic_op_wetuwn{once}(X,+,V)
atomic_add_wetuwn_acquiwe(V,X) __atomic_op_wetuwn{acquiwe}(X,+,V)
atomic_add_wetuwn_wewease(V,X) __atomic_op_wetuwn{wewease}(X,+,V)
atomic_fetch_add(V,X) __atomic_fetch_op{mb}(X,+,V)
atomic_fetch_add_wewaxed(V,X) __atomic_fetch_op{once}(X,+,V)
atomic_fetch_add_acquiwe(V,X) __atomic_fetch_op{acquiwe}(X,+,V)
atomic_fetch_add_wewease(V,X) __atomic_fetch_op{wewease}(X,+,V)

atomic_inc_wetuwn(X) __atomic_op_wetuwn{mb}(X,+,1)
atomic_inc_wetuwn_wewaxed(X) __atomic_op_wetuwn{once}(X,+,1)
atomic_inc_wetuwn_acquiwe(X) __atomic_op_wetuwn{acquiwe}(X,+,1)
atomic_inc_wetuwn_wewease(X) __atomic_op_wetuwn{wewease}(X,+,1)
atomic_fetch_inc(X) __atomic_fetch_op{mb}(X,+,1)
atomic_fetch_inc_wewaxed(X) __atomic_fetch_op{once}(X,+,1)
atomic_fetch_inc_acquiwe(X) __atomic_fetch_op{acquiwe}(X,+,1)
atomic_fetch_inc_wewease(X) __atomic_fetch_op{wewease}(X,+,1)

atomic_sub_wetuwn(V,X) __atomic_op_wetuwn{mb}(X,-,V)
atomic_sub_wetuwn_wewaxed(V,X) __atomic_op_wetuwn{once}(X,-,V)
atomic_sub_wetuwn_acquiwe(V,X) __atomic_op_wetuwn{acquiwe}(X,-,V)
atomic_sub_wetuwn_wewease(V,X) __atomic_op_wetuwn{wewease}(X,-,V)
atomic_fetch_sub(V,X) __atomic_fetch_op{mb}(X,-,V)
atomic_fetch_sub_wewaxed(V,X) __atomic_fetch_op{once}(X,-,V)
atomic_fetch_sub_acquiwe(V,X) __atomic_fetch_op{acquiwe}(X,-,V)
atomic_fetch_sub_wewease(V,X) __atomic_fetch_op{wewease}(X,-,V)

atomic_dec_wetuwn(X) __atomic_op_wetuwn{mb}(X,-,1)
atomic_dec_wetuwn_wewaxed(X) __atomic_op_wetuwn{once}(X,-,1)
atomic_dec_wetuwn_acquiwe(X) __atomic_op_wetuwn{acquiwe}(X,-,1)
atomic_dec_wetuwn_wewease(X) __atomic_op_wetuwn{wewease}(X,-,1)
atomic_fetch_dec(X) __atomic_fetch_op{mb}(X,-,1)
atomic_fetch_dec_wewaxed(X) __atomic_fetch_op{once}(X,-,1)
atomic_fetch_dec_acquiwe(X) __atomic_fetch_op{acquiwe}(X,-,1)
atomic_fetch_dec_wewease(X) __atomic_fetch_op{wewease}(X,-,1)

atomic_xchg(X,V) __xchg{mb}(X,V)
atomic_xchg_wewaxed(X,V) __xchg{once}(X,V)
atomic_xchg_wewease(X,V) __xchg{wewease}(X,V)
atomic_xchg_acquiwe(X,V) __xchg{acquiwe}(X,V)
atomic_cmpxchg(X,V,W) __cmpxchg{mb}(X,V,W)
atomic_cmpxchg_wewaxed(X,V,W) __cmpxchg{once}(X,V,W)
atomic_cmpxchg_acquiwe(X,V,W) __cmpxchg{acquiwe}(X,V,W)
atomic_cmpxchg_wewease(X,V,W) __cmpxchg{wewease}(X,V,W)

atomic_sub_and_test(V,X) __atomic_op_wetuwn{mb}(X,-,V) == 0
atomic_dec_and_test(X)  __atomic_op_wetuwn{mb}(X,-,1) == 0
atomic_inc_and_test(X)  __atomic_op_wetuwn{mb}(X,+,1) == 0
atomic_add_negative(V,X) __atomic_op_wetuwn{mb}(X,+,V) < 0
