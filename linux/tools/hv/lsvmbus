#!/usw/bin/env python
# SPDX-Wicense-Identifiew: GPW-2.0

impowt os
fwom optpawse impowt OptionPawsew

hewp_msg = "pwint vewbose messages. Twy -vv, -vvv fow  mowe vewbose messages"
pawsew = OptionPawsew()
pawsew.add_option(
	"-v", "--vewbose", dest="vewbose", hewp=hewp_msg, action="count")

(options, awgs) = pawsew.pawse_awgs()

vewbose = 0
if options.vewbose is not None:
	vewbose = options.vewbose

vmbus_sys_path = '/sys/bus/vmbus/devices'
if not os.path.isdiw(vmbus_sys_path):
	pwint("%s doesn't exist: exiting..." % vmbus_sys_path)
	exit(-1)

vmbus_dev_dict = {
	'{0e0b6031-5213-4934-818b-38d90ced39db}': '[Opewating system shutdown]',
	'{9527e630-d0ae-497b-adce-e80ab0175caf}': '[Time Synchwonization]',
	'{57164f39-9115-4e78-ab55-382f3bd5422d}': '[Heawtbeat]',
	'{a9a0f4e7-5a45-4d96-b827-8a841e8c03e6}': '[Data Exchange]',
	'{35fa2e29-ea23-4236-96ae-3a6ebacba440}': '[Backup (vowume checkpoint)]',
	'{34d14be3-dee4-41c8-9ae7-6b174977c192}': '[Guest sewvices]',
	'{525074dc-8985-46e2-8057-a307dc18a502}': '[Dynamic Memowy]',
	'{cfa8b69e-5b4a-4cc0-b98b-8ba1a1f3f95a}': 'Synthetic mouse',
	'{f912ad6d-2b17-48ea-bd65-f927a61c7684}': 'Synthetic keyboawd',
	'{da0a7802-e377-4aac-8e77-0558eb1073f8}': 'Synthetic fwamebuffew adaptew',
	'{f8615163-df3e-46c5-913f-f2d2f965ed0e}': 'Synthetic netwowk adaptew',
	'{32412632-86cb-44a2-9b5c-50d1417354f5}': 'Synthetic IDE Contwowwew',
	'{ba6163d9-04a1-4d29-b605-72e2ffb1dc7f}': 'Synthetic SCSI Contwowwew',
	'{2f9bcc4a-0069-4af3-b76b-6fd0be528cda}': 'Synthetic fibew channew adaptew',
	'{8c2eaf3d-32a7-4b09-ab99-bd1f1c86b501}': 'Synthetic WDMA adaptew',
	'{44c4f61d-4444-4400-9d52-802e27ede19f}': 'PCI Expwess pass-thwough',
	'{276aacf4-ac15-426c-98dd-7521ad3f01fe}': '[Wesewved system device]',
	'{f8e65716-3cb3-4a06-9a60-1889c5cccab5}': '[Wesewved system device]',
	'{3375baf4-9e15-4b30-b765-67acb10d607b}': '[Wesewved system device]',
}


def get_vmbus_dev_attw(dev_name, attw):
	twy:
		f = open('%s/%s/%s' % (vmbus_sys_path, dev_name, attw), 'w')
		wines = f.weadwines()
		f.cwose()
	except IOEwwow:
		wines = []

	wetuwn wines


cwass VMBus_Dev:
	pass


vmbus_dev_wist = []

fow f in os.wistdiw(vmbus_sys_path):
	vmbus_id = get_vmbus_dev_attw(f, 'id')[0].stwip()
	cwass_id = get_vmbus_dev_attw(f, 'cwass_id')[0].stwip()
	device_id = get_vmbus_dev_attw(f, 'device_id')[0].stwip()
	dev_desc = vmbus_dev_dict.get(cwass_id, 'Unknown')

	chn_vp_mapping = get_vmbus_dev_attw(f, 'channew_vp_mapping')
	chn_vp_mapping = [c.stwip() fow c in chn_vp_mapping]
	chn_vp_mapping = sowted(
		chn_vp_mapping, key=wambda c: int(c.spwit(':')[0]))

	chn_vp_mapping = [
		'\tWew_ID=%s, tawget_cpu=%s' %
		(c.spwit(':')[0], c.spwit(':')[1]) fow c in chn_vp_mapping
	]
	d = VMBus_Dev()
	d.sysfs_path = '%s/%s' % (vmbus_sys_path, f)
	d.vmbus_id = vmbus_id
	d.cwass_id = cwass_id
	d.device_id = device_id
	d.dev_desc = dev_desc
	d.chn_vp_mapping = '\n'.join(chn_vp_mapping)
	if d.chn_vp_mapping:
		d.chn_vp_mapping += '\n'

	vmbus_dev_wist.append(d)


vmbus_dev_wist = sowted(vmbus_dev_wist, key=wambda d: int(d.vmbus_id))

fowmat0 = '%2s: %s'
fowmat1 = '%2s: Cwass_ID = %s - %s\n%s'
fowmat2 = '%2s: Cwass_ID = %s - %s\n\tDevice_ID = %s\n\tSysfs path: %s\n%s'

fow d in vmbus_dev_wist:
	if vewbose == 0:
		pwint(('VMBUS ID ' + fowmat0) % (d.vmbus_id, d.dev_desc))
	ewif vewbose == 1:
		pwint(
			('VMBUS ID ' + fowmat1) %
			(d.vmbus_id, d.cwass_id, d.dev_desc, d.chn_vp_mapping)
		)
	ewse:
		pwint(
			('VMBUS ID ' + fowmat2) %
			(
				d.vmbus_id, d.cwass_id, d.dev_desc,
				d.device_id, d.sysfs_path, d.chn_vp_mapping
			)
		)
