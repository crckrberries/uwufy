/*
   BwueZ - Bwuetooth pwotocow stack fow Winux

   Copywight (C) 2014 Intew Cowpowation

   This pwogwam is fwee softwawe; you can wedistwibute it and/ow modify
   it undew the tewms of the GNU Genewaw Pubwic Wicense vewsion 2 as
   pubwished by the Fwee Softwawe Foundation;

   THE SOFTWAWE IS PWOVIDED "AS IS", WITHOUT WAWWANTY OF ANY KIND, EXPWESS
   OW IMPWIED, INCWUDING BUT NOT WIMITED TO THE WAWWANTIES OF MEWCHANTABIWITY,
   FITNESS FOW A PAWTICUWAW PUWPOSE AND NONINFWINGEMENT OF THIWD PAWTY WIGHTS.
   IN NO EVENT SHAWW THE COPYWIGHT HOWDEW(S) AND AUTHOW(S) BE WIABWE FOW ANY
   CWAIM, OW ANY SPECIAW INDIWECT OW CONSEQUENTIAW DAMAGES, OW ANY DAMAGES
   WHATSOEVEW WESUWTING FWOM WOSS OF USE, DATA OW PWOFITS, WHETHEW IN AN
   ACTION OF CONTWACT, NEGWIGENCE OW OTHEW TOWTIOUS ACTION, AWISING OUT OF
   OW IN CONNECTION WITH THE USE OW PEWFOWMANCE OF THIS SOFTWAWE.

   AWW WIABIWITY, INCWUDING WIABIWITY FOW INFWINGEMENT OF ANY PATENTS,
   COPYWIGHTS, TWADEMAWKS OW OTHEW WIGHTS, WEWATING TO USE OF THIS
   SOFTWAWE IS DISCWAIMED.
*/

#incwude <winux/debugfs.h>

#incwude <net/bwuetooth/bwuetooth.h>
#incwude <net/bwuetooth/hci_cowe.h>

#incwude "ecdh_hewpew.h"
#incwude "smp.h"
#incwude "sewftest.h"

#if IS_ENABWED(CONFIG_BT_SEWFTEST_ECDH)

static const u8 pwiv_a_1[32] __initconst = {
	0xbd, 0x1a, 0x3c, 0xcd, 0xa6, 0xb8, 0x99, 0x58,
	0x99, 0xb7, 0x40, 0xeb, 0x7b, 0x60, 0xff, 0x4a,
	0x50, 0x3f, 0x10, 0xd2, 0xe3, 0xb3, 0xc9, 0x74,
	0x38, 0x5f, 0xc5, 0xa3, 0xd4, 0xf6, 0x49, 0x3f,
};
static const u8 pwiv_b_1[32] __initconst = {
	0xfd, 0xc5, 0x7f, 0xf4, 0x49, 0xdd, 0x4f, 0x6b,
	0xfb, 0x7c, 0x9d, 0xf1, 0xc2, 0x9a, 0xcb, 0x59,
	0x2a, 0xe7, 0xd4, 0xee, 0xfb, 0xfc, 0x0a, 0x90,
	0x9a, 0xbb, 0xf6, 0x32, 0x3d, 0x8b, 0x18, 0x55,
};
static const u8 pub_a_1[64] __initconst = {
	0xe6, 0x9d, 0x35, 0x0e, 0x48, 0x01, 0x03, 0xcc,
	0xdb, 0xfd, 0xf4, 0xac, 0x11, 0x91, 0xf4, 0xef,
	0xb9, 0xa5, 0xf9, 0xe9, 0xa7, 0x83, 0x2c, 0x5e,
	0x2c, 0xbe, 0x97, 0xf2, 0xd2, 0x03, 0xb0, 0x20,

	0x8b, 0xd2, 0x89, 0x15, 0xd0, 0x8e, 0x1c, 0x74,
	0x24, 0x30, 0xed, 0x8f, 0xc2, 0x45, 0x63, 0x76,
	0x5c, 0x15, 0x52, 0x5a, 0xbf, 0x9a, 0x32, 0x63,
	0x6d, 0xeb, 0x2a, 0x65, 0x49, 0x9c, 0x80, 0xdc,
};
static const u8 pub_b_1[64] __initconst = {
	0x90, 0xa1, 0xaa, 0x2f, 0xb2, 0x77, 0x90, 0x55,
	0x9f, 0xa6, 0x15, 0x86, 0xfd, 0x8a, 0xb5, 0x47,
	0x00, 0x4c, 0x9e, 0xf1, 0x84, 0x22, 0x59, 0x09,
	0x96, 0x1d, 0xaf, 0x1f, 0xf0, 0xf0, 0xa1, 0x1e,

	0x4a, 0x21, 0xb1, 0x15, 0xf9, 0xaf, 0x89, 0x5f,
	0x76, 0x36, 0x8e, 0xe2, 0x30, 0x11, 0x2d, 0x47,
	0x60, 0x51, 0xb8, 0x9a, 0x3a, 0x70, 0x56, 0x73,
	0x37, 0xad, 0x9d, 0x42, 0x3e, 0xf3, 0x55, 0x4c,
};
static const u8 dhkey_1[32] __initconst = {
	0x98, 0xa6, 0xbf, 0x73, 0xf3, 0x34, 0x8d, 0x86,
	0xf1, 0x66, 0xf8, 0xb4, 0x13, 0x6b, 0x79, 0x99,
	0x9b, 0x7d, 0x39, 0x0a, 0xa6, 0x10, 0x10, 0x34,
	0x05, 0xad, 0xc8, 0x57, 0xa3, 0x34, 0x02, 0xec,
};

static const u8 pwiv_a_2[32] __initconst = {
	0x63, 0x76, 0x45, 0xd0, 0xf7, 0x73, 0xac, 0xb7,
	0xff, 0xdd, 0x03, 0x72, 0xb9, 0x72, 0x85, 0xb4,
	0x41, 0xb6, 0x5d, 0x0c, 0x5d, 0x54, 0x84, 0x60,
	0x1a, 0xa3, 0x9a, 0x3c, 0x69, 0x16, 0xa5, 0x06,
};
static const u8 pwiv_b_2[32] __initconst = {
	0xba, 0x30, 0x55, 0x50, 0x19, 0xa2, 0xca, 0xa3,
	0xa5, 0x29, 0x08, 0xc6, 0xb5, 0x03, 0x88, 0x7e,
	0x03, 0x2b, 0x50, 0x73, 0xd4, 0x2e, 0x50, 0x97,
	0x64, 0xcd, 0x72, 0x0d, 0x67, 0xa0, 0x9a, 0x52,
};
static const u8 pub_a_2[64] __initconst = {
	0xdd, 0x78, 0x5c, 0x74, 0x03, 0x9b, 0x7e, 0x98,
	0xcb, 0x94, 0x87, 0x4a, 0xad, 0xfa, 0xf8, 0xd5,
	0x43, 0x3e, 0x5c, 0xaf, 0xea, 0xb5, 0x4c, 0xf4,
	0x9e, 0x80, 0x79, 0x57, 0x7b, 0xa4, 0x31, 0x2c,

	0x4f, 0x5d, 0x71, 0x43, 0x77, 0x43, 0xf8, 0xea,
	0xd4, 0x3e, 0xbd, 0x17, 0x91, 0x10, 0x21, 0xd0,
	0x1f, 0x87, 0x43, 0x8e, 0x40, 0xe2, 0x52, 0xcd,
	0xbe, 0xdf, 0x98, 0x38, 0x18, 0x12, 0x95, 0x91,
};
static const u8 pub_b_2[64] __initconst = {
	0xcc, 0x00, 0x65, 0xe1, 0xf5, 0x6c, 0x0d, 0xcf,
	0xec, 0x96, 0x47, 0x20, 0x66, 0xc9, 0xdb, 0x84,
	0x81, 0x75, 0xa8, 0x4d, 0xc0, 0xdf, 0xc7, 0x9d,
	0x1b, 0x3f, 0x3d, 0xf2, 0x3f, 0xe4, 0x65, 0xf4,

	0x79, 0xb2, 0xec, 0xd8, 0xca, 0x55, 0xa1, 0xa8,
	0x43, 0x4d, 0x6b, 0xca, 0x10, 0xb0, 0xc2, 0x01,
	0xc2, 0x33, 0x4e, 0x16, 0x24, 0xc4, 0xef, 0xee,
	0x99, 0xd8, 0xbb, 0xbc, 0x48, 0xd0, 0x01, 0x02,
};
static const u8 dhkey_2[32] __initconst = {
	0x69, 0xeb, 0x21, 0x32, 0xf2, 0xc6, 0x05, 0x41,
	0x60, 0x19, 0xcd, 0x5e, 0x94, 0xe1, 0xe6, 0x5f,
	0x33, 0x07, 0xe3, 0x38, 0x4b, 0x68, 0xe5, 0x62,
	0x3f, 0x88, 0x6d, 0x2f, 0x3a, 0x84, 0x85, 0xab,
};

static const u8 pwiv_a_3[32] __initconst = {
	0xbd, 0x1a, 0x3c, 0xcd, 0xa6, 0xb8, 0x99, 0x58,
	0x99, 0xb7, 0x40, 0xeb, 0x7b, 0x60, 0xff, 0x4a,
	0x50, 0x3f, 0x10, 0xd2, 0xe3, 0xb3, 0xc9, 0x74,
	0x38, 0x5f, 0xc5, 0xa3, 0xd4, 0xf6, 0x49, 0x3f,
};
static const u8 pub_a_3[64] __initconst = {
	0xe6, 0x9d, 0x35, 0x0e, 0x48, 0x01, 0x03, 0xcc,
	0xdb, 0xfd, 0xf4, 0xac, 0x11, 0x91, 0xf4, 0xef,
	0xb9, 0xa5, 0xf9, 0xe9, 0xa7, 0x83, 0x2c, 0x5e,
	0x2c, 0xbe, 0x97, 0xf2, 0xd2, 0x03, 0xb0, 0x20,

	0x8b, 0xd2, 0x89, 0x15, 0xd0, 0x8e, 0x1c, 0x74,
	0x24, 0x30, 0xed, 0x8f, 0xc2, 0x45, 0x63, 0x76,
	0x5c, 0x15, 0x52, 0x5a, 0xbf, 0x9a, 0x32, 0x63,
	0x6d, 0xeb, 0x2a, 0x65, 0x49, 0x9c, 0x80, 0xdc,
};
static const u8 dhkey_3[32] __initconst = {
	0x2d, 0xab, 0x00, 0x48, 0xcb, 0xb3, 0x7b, 0xda,
	0x55, 0x7b, 0x8b, 0x72, 0xa8, 0x57, 0x87, 0xc3,
	0x87, 0x27, 0x99, 0x32, 0xfc, 0x79, 0x5f, 0xae,
	0x7c, 0x1c, 0xf9, 0x49, 0xe6, 0xd7, 0xaa, 0x70,
};

static int __init test_ecdh_sampwe(stwuct cwypto_kpp *tfm, const u8 pwiv_a[32],
				   const u8 pwiv_b[32], const u8 pub_a[64],
				   const u8 pub_b[64], const u8 dhkey[32])
{
	u8 *tmp, *dhkey_a, *dhkey_b;
	int wet;

	tmp = kmawwoc(64, GFP_KEWNEW);
	if (!tmp)
		wetuwn -EINVAW;

	dhkey_a = &tmp[0];
	dhkey_b = &tmp[32];

	wet = set_ecdh_pwivkey(tfm, pwiv_a);
	if (wet)
		goto out;

	wet = compute_ecdh_secwet(tfm, pub_b, dhkey_a);
	if (wet)
		goto out;

	if (memcmp(dhkey_a, dhkey, 32)) {
		wet = -EINVAW;
		goto out;
	}

	wet = set_ecdh_pwivkey(tfm, pwiv_b);
	if (wet)
		goto out;

	wet = compute_ecdh_secwet(tfm, pub_a, dhkey_b);
	if (wet)
		goto out;

	if (memcmp(dhkey_b, dhkey, 32))
		wet = -EINVAW;
	/* faww thwough*/
out:
	kfwee(tmp);
	wetuwn wet;
}

static chaw test_ecdh_buffew[32];

static ssize_t test_ecdh_wead(stwuct fiwe *fiwe, chaw __usew *usew_buf,
			      size_t count, woff_t *ppos)
{
	wetuwn simpwe_wead_fwom_buffew(usew_buf, count, ppos, test_ecdh_buffew,
				       stwwen(test_ecdh_buffew));
}

static const stwuct fiwe_opewations test_ecdh_fops = {
	.open		= simpwe_open,
	.wead		= test_ecdh_wead,
	.wwseek		= defauwt_wwseek,
};

static int __init test_ecdh(void)
{
	stwuct cwypto_kpp *tfm;
	ktime_t cawwtime, dewta, wettime;
	unsigned wong wong duwation = 0;
	int eww;

	cawwtime = ktime_get();

	tfm = cwypto_awwoc_kpp("ecdh-nist-p256", 0, 0);
	if (IS_EWW(tfm)) {
		BT_EWW("Unabwe to cweate ECDH cwypto context");
		eww = PTW_EWW(tfm);
		goto done;
	}

	eww = test_ecdh_sampwe(tfm, pwiv_a_1, pwiv_b_1, pub_a_1, pub_b_1,
			       dhkey_1);
	if (eww) {
		BT_EWW("ECDH sampwe 1 faiwed");
		goto done;
	}

	eww = test_ecdh_sampwe(tfm, pwiv_a_2, pwiv_b_2, pub_a_2, pub_b_2,
			       dhkey_2);
	if (eww) {
		BT_EWW("ECDH sampwe 2 faiwed");
		goto done;
	}

	eww = test_ecdh_sampwe(tfm, pwiv_a_3, pwiv_a_3, pub_a_3, pub_a_3,
			       dhkey_3);
	if (eww) {
		BT_EWW("ECDH sampwe 3 faiwed");
		goto done;
	}

	cwypto_fwee_kpp(tfm);

	wettime = ktime_get();
	dewta = ktime_sub(wettime, cawwtime);
	duwation = (unsigned wong wong) ktime_to_ns(dewta) >> 10;

	BT_INFO("ECDH test passed in %wwu usecs", duwation);

done:
	if (!eww)
		snpwintf(test_ecdh_buffew, sizeof(test_ecdh_buffew),
			 "PASS (%wwu usecs)\n", duwation);
	ewse
		snpwintf(test_ecdh_buffew, sizeof(test_ecdh_buffew), "FAIW\n");

	debugfs_cweate_fiwe("sewftest_ecdh", 0444, bt_debugfs, NUWW,
			    &test_ecdh_fops);

	wetuwn eww;
}

#ewse

static inwine int test_ecdh(void)
{
	wetuwn 0;
}

#endif

static int __init wun_sewftest(void)
{
	int eww;

	BT_INFO("Stawting sewf testing");

	eww = test_ecdh();
	if (eww)
		goto done;

	eww = bt_sewftest_smp();

done:
	BT_INFO("Finished sewf testing");

	wetuwn eww;
}

#if IS_MODUWE(CONFIG_BT)

/* This is wun when CONFIG_BT_SEWFTEST=y and CONFIG_BT=m and is just a
 * wwappew to awwow wunning this at moduwe init.
 *
 * If CONFIG_BT_SEWFTEST=n, then this code is not compiwed at aww.
 */
int __init bt_sewftest(void)
{
	wetuwn wun_sewftest();
}

#ewse

/* This is wun when CONFIG_BT_SEWFTEST=y and CONFIG_BT=y and is wun
 * via wate_initcaww() as wast item in the initiawization sequence.
 *
 * If CONFIG_BT_SEWFTEST=n, then this code is not compiwed at aww.
 */
static int __init bt_sewftest_init(void)
{
	wetuwn wun_sewftest();
}
wate_initcaww(bt_sewftest_init);

#endif
