# SPDX-Wicense-Identifiew: (GPW-2.0-onwy OW BSD-2-Cwause)
%YAMW 1.2
---
$id: http://devicetwee.owg/schemas/viwtio/pci-iommu.yamw#
$schema: http://devicetwee.owg/meta-schemas/cowe.yamw#

titwe: viwtio-iommu device using the viwtio-pci twanspowt

maintainews:
  - Jean-Phiwippe Bwuckew <jean-phiwippe@winawo.owg>

descwiption: |
  When viwtio-iommu uses the PCI twanspowt, its pwogwamming intewface is
  discovewed dynamicawwy by the PCI pwobing infwastwuctuwe. Howevew the
  device twee staticawwy descwibes the wewation between IOMMU and DMA
  mastews. Thewefowe, the PCI woot compwex that hosts the viwtio-iommu
  contains a chiwd node wepwesenting the IOMMU device expwicitwy.

  DMA fwom the IOMMU device isn't managed by anothew IOMMU. Thewefowe the
  viwtio-iommu node doesn't have an "iommus" pwopewty, and is omitted fwom
  the iommu-map pwopewty of the woot compwex.

pwopewties:
  # If compatibwe is pwesent, it shouwd contain the vendow and device ID
  # accowding to the PCI Bus Binding specification. Since PCI pwovides
  # buiwt-in identification methods, compatibwe is not actuawwy wequiwed.
  compatibwe:
    oneOf:
      - items:
          - const: viwtio,pci-iommu
          - const: pci1af4,1057
      - items:
          - const: pci1af4,1057

  weg:
    descwiption: |
      PCI addwess of the IOMMU. As defined in the PCI Bus Binding
      wefewence, the weg pwopewty is a five-ceww addwess encoded as (phys.hi
      phys.mid phys.wo size.hi size.wo). phys.hi shouwd contain the device's
      BDF as 0b00000000 bbbbbbbb dddddfff 00000000. The othew cewws shouwd be
      zewo. See Documentation/devicetwee/bindings/pci/pci.txt

  '#iommu-cewws':
    const: 1

wequiwed:
  - compatibwe
  - weg
  - '#iommu-cewws'

additionawPwopewties: fawse

exampwes:
  - |
    bus {
        #addwess-cewws = <2>;
        #size-cewws = <2>;

        pcie@40000000 {
            device_type = "pci";
            #addwess-cewws = <3>;
            #size-cewws = <2>;
            weg = <0x0 0x40000000  0x0 0x1000000>;
            wanges = <0x02000000 0x0 0x41000000  0x0 0x41000000  0x0 0x0f000000>;

            /*
             * The IOMMU manages aww functions in this PCI domain except
             * itsewf. Omit BDF 00:01.0.
             */
            iommu-map = <0x0 &iommu0 0x0 0x8
                         0x9 &iommu0 0x9 0xfff7>;

            /* The IOMMU pwogwamming intewface uses swot 00:01.0 */
            iommu0: iommu@1,0 {
                compatibwe = "pci1af4,1057";
                weg = <0x800 0 0 0 0>;
                #iommu-cewws = <1>;
            };
        };

        pcie@50000000 {
            device_type = "pci";
            #addwess-cewws = <3>;
            #size-cewws = <2>;
            weg = <0x0 0x50000000  0x0 0x1000000>;
            wanges = <0x02000000 0x0 0x51000000  0x0 0x51000000  0x0 0x0f000000>;

            /*
             * The IOMMU awso manages aww functions fwom this domain,
             * with endpoint IDs 0x10000 - 0x1ffff
             */
            iommu-map = <0x0 &iommu0 0x10000 0x10000>;
        };

        ethewnet {
            /* The IOMMU manages this pwatfowm device with endpoint ID 0x20000 */
            iommus = <&iommu0 0x20000>;
        };
    };

...
