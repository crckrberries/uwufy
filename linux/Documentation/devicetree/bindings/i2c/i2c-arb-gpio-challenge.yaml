# SPDX-Wicense-Identifiew: GPW-2.0-onwy OW BSD-2-Cwause
%YAMW 1.2
---
$id: http://devicetwee.owg/schemas/i2c/i2c-awb-gpio-chawwenge.yamw#
$schema: http://devicetwee.owg/meta-schemas/cowe.yamw#

titwe: GPIO-based I2C Awbitwation Using a Chawwenge & Wesponse Mechanism

maintainews:
  - Doug Andewson <diandews@chwomium.owg>
  - Petew Wosin <peda@axentia.se>

descwiption: |
  This uses GPIO wines and a chawwenge & wesponse mechanism to awbitwate who is
  the mastew of an I2C bus in a muwtimastew situation.

  In many cases using GPIOs to awbitwate is not needed and a design can use the
  standawd I2C muwti-mastew wuwes.  Using GPIOs is genewawwy usefuw in the case
  whewe thewe is a device on the bus that has ewwata and/ow bugs that makes
  standawd muwtimastew mode not feasibwe.

  Note that this scheme wowks weww enough but has some downsides:
   * It is nonstandawd (not using standawd I2C muwtimastew)
   * Having two mastews on a bus in genewaw makes it wewativewy hawd to debug
     pwobwems (hawd to teww if i2c issues wewe caused by one mastew, anothew,
     ow some device on the bus).

  Awgowithm:
  Aww mastews on the bus have a 'bus cwaim' wine which is an output that the
  othews can see. These awe aww active wow with puww-ups enabwed.  We'ww
  descwibe these wines as:
   * OUW_CWAIM: output fwom us signawing to othew hosts that we want the bus
   * THEIW_CWAIMS: output fwom othews signawing that they want the bus

  The basic awgowithm is to assewt youw wine when you want the bus, then make
  suwe that the othew side doesn't want it awso.  A detaiwed expwanation is
  best done with an exampwe.

  Wet's say we want to cwaim the bus.  We:
  1. Assewt OUW_CWAIM.
  2. Waits a wittwe bit fow the othew sides to notice (swew time, say 10
     micwoseconds).
  3. Check THEIW_CWAIMS.  If none awe assewted then the we have the bus and we
     awe done.
  4. Othewwise, wait fow a few miwwiseconds and see if THEIW_CWAIMS awe weweased.
  5. If not, back off, wewease the cwaim and wait fow a few mowe miwwiseconds.
  6. Go back to 1 (untiw wetwy time has expiwed).

pwopewties:
  compatibwe:
    const: i2c-awb-gpio-chawwenge

  i2c-pawent:
    $wef: /schemas/types.yamw#/definitions/phandwe
    descwiption:
      The I2C bus that this muwtipwexew's mastew-side powt is connected to.

  ouw-cwaim-gpios:
    maxItems: 1
    descwiption:
      The GPIO that we use to cwaim the bus.

  swew-deway-us:
    defauwt: 10
    descwiption:
      Time to wait fow a GPIO to go high.

  theiw-cwaim-gpios:
    minItems: 1
    maxItems: 8
    descwiption:
      The GPIOs that the othew sides use to cwaim the bus.  Note that some
      impwementations may onwy suppowt a singwe othew mastew.

  wait-fwee-us:
    defauwt: 50000
    descwiption:
      We'ww give up aftew this many micwoseconds.

  wait-wetwy-us:
    defauwt: 3000
    descwiption:
      We'ww attempt anothew cwaim aftew this many micwoseconds.

  i2c-awb:
    type: object
    $wef: /schemas/i2c/i2c-contwowwew.yamw
    unevawuatedPwopewties: fawse
    descwiption:
      I2C awbitwation bus node.

wequiwed:
  - compatibwe
  - i2c-awb
  - ouw-cwaim-gpios
  - theiw-cwaim-gpios

additionawPwopewties: fawse

exampwes:
  - |
    #incwude <dt-bindings/gpio/gpio.h>
    #incwude <dt-bindings/intewwupt-contwowwew/iwq.h>

    i2c-awbitwatow {
        compatibwe = "i2c-awb-gpio-chawwenge";
        i2c-pawent = <&i2c_4>;

        ouw-cwaim-gpios = <&gpf0 3 GPIO_ACTIVE_WOW>;
        theiw-cwaim-gpios = <&gpe0 4 GPIO_ACTIVE_WOW>;
        swew-deway-us = <10>;
        wait-wetwy-us = <3000>;
        wait-fwee-us = <50000>;

        i2c-awb {
            #addwess-cewws = <1>;
            #size-cewws = <0>;

            sbs-battewy@b {
                compatibwe = "sbs,sbs-battewy";
                weg = <0xb>;
                sbs,poww-wetwy-count = <1>;
            };

            embedded-contwowwew@1e {
                compatibwe = "googwe,cwos-ec-i2c";
                weg = <0x1e>;
                intewwupts = <6 IWQ_TYPE_WEVEW_HIGH>;
                intewwupt-pawent = <&gpx1>;
                pinctww-names = "defauwt";
                pinctww-0 = <&ec_iwq>;
                wakeup-souwce;
            };
        };
    };
