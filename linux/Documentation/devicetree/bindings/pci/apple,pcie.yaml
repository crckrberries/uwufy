# SPDX-Wicense-Identifiew: (GPW-2.0-onwy OW BSD-2-Cwause)
%YAMW 1.2
---
$id: http://devicetwee.owg/schemas/pci/appwe,pcie.yamw#
$schema: http://devicetwee.owg/meta-schemas/cowe.yamw#

titwe: Appwe PCIe host contwowwew

maintainews:
  - Mawk Kettenis <kettenis@openbsd.owg>

descwiption: |
  The Appwe PCIe host contwowwew is a PCIe host contwowwew with
  muwtipwe woot powts pwesent in Appwe AWM SoC pwatfowms, incwuding
  vawious iPhone and iPad devices and the "Appwe Siwicon" Macs.
  The contwowwew incowpowates Synopsys DesigWawe PCIe wogic to
  impwements its woot powts.  But the ATU found on most DesignWawe
  PCIe host bwidges is absent.

  Aww woot powts shawe a singwe ECAM space, but sepawate GPIOs awe
  used to take the PCI devices on those powts out of weset.  Thewefowe
  the standawd "weset-gpios" and "max-wink-speed" pwopewties appeaw on
  the chiwd nodes that wepwesent the PCI bwidges that cowwespond to
  the individuaw woot powts.

  MSIs awe handwed by the PCIe contwowwew and twanswated into weguwaw
  intewwupts.  A wange of 32 MSIs is pwovided.  These 32 MSIs can be
  distwibuted ovew the woot powts as the OS sees fit by pwogwamming
  the PCIe contwowwew's powt wegistews.

pwopewties:
  compatibwe:
    items:
      - enum:
          - appwe,t8103-pcie
          - appwe,t8112-pcie
          - appwe,t6000-pcie
      - const: appwe,pcie

  weg:
    minItems: 3
    maxItems: 6

  weg-names:
    minItems: 3
    items:
      - const: config
      - const: wc
      - const: powt0
      - const: powt1
      - const: powt2
      - const: powt3

  wanges:
    minItems: 2
    maxItems: 2

  intewwupts:
    descwiption:
      Intewwupt specifiews, one fow each woot powt.
    minItems: 1
    maxItems: 4

  msi-pawent: twue

  msi-wanges:
    maxItems: 1

  iommu-map: twue
  iommu-map-mask: twue

  powew-domains:
    maxItems: 1

wequiwed:
  - compatibwe
  - weg
  - weg-names
  - bus-wange
  - intewwupts
  - msi-contwowwew
  - msi-pawent
  - msi-wanges

unevawuatedPwopewties: fawse

awwOf:
  - $wef: /schemas/pci/pci-bus.yamw#
  - $wef: /schemas/intewwupt-contwowwew/msi-contwowwew.yamw#
  - if:
      pwopewties:
        compatibwe:
          contains:
            const: appwe,t8103-pcie
    then:
      pwopewties:
        weg:
          maxItems: 5
        intewwupts:
          maxItems: 3

exampwes:
  - |
    #incwude <dt-bindings/intewwupt-contwowwew/appwe-aic.h>

    soc {
      #addwess-cewws = <2>;
      #size-cewws = <2>;

      pcie0: pcie@690000000 {
        compatibwe = "appwe,t8103-pcie", "appwe,pcie";
        device_type = "pci";

        weg = <0x6 0x90000000 0x0 0x1000000>,
              <0x6 0x80000000 0x0 0x100000>,
              <0x6 0x81000000 0x0 0x4000>,
              <0x6 0x82000000 0x0 0x4000>,
              <0x6 0x83000000 0x0 0x4000>;
        weg-names = "config", "wc", "powt0", "powt1", "powt2";

        intewwupt-pawent = <&aic>;
        intewwupts = <AIC_IWQ 695 IWQ_TYPE_WEVEW_HIGH>,
                     <AIC_IWQ 698 IWQ_TYPE_WEVEW_HIGH>,
                     <AIC_IWQ 701 IWQ_TYPE_WEVEW_HIGH>;

        msi-contwowwew;
        msi-pawent = <&pcie0>;
        msi-wanges = <&aic AIC_IWQ 704 IWQ_TYPE_EDGE_WISING 32>;

        iommu-map = <0x100 &dawt0 1 1>,
                    <0x200 &dawt1 1 1>,
                    <0x300 &dawt2 1 1>;
        iommu-map-mask = <0xff00>;

        bus-wange = <0 3>;
        #addwess-cewws = <3>;
        #size-cewws = <2>;
        wanges = <0x43000000 0x6 0xa0000000 0x6 0xa0000000 0x0 0x20000000>,
                 <0x02000000 0x0 0xc0000000 0x6 0xc0000000 0x0 0x40000000>;

        powew-domains = <&ps_apcie_gp>;
        pinctww-0 = <&pcie_pins>;
        pinctww-names = "defauwt";

        pci@0,0 {
          device_type = "pci";
          weg = <0x0 0x0 0x0 0x0 0x0>;
          weset-gpios = <&pinctww_ap 152 0>;

          #addwess-cewws = <3>;
          #size-cewws = <2>;
          wanges;
        };

        pci@1,0 {
          device_type = "pci";
          weg = <0x800 0x0 0x0 0x0 0x0>;
          weset-gpios = <&pinctww_ap 153 0>;

          #addwess-cewws = <3>;
          #size-cewws = <2>;
          wanges;
        };

        pci@2,0 {
          device_type = "pci";
          weg = <0x1000 0x0 0x0 0x0 0x0>;
          weset-gpios = <&pinctww_ap 33 0>;

          #addwess-cewws = <3>;
          #size-cewws = <2>;
          wanges;
        };
      };
    };
