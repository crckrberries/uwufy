This document descwibes the genewic device twee binding fow descwibing the
wewationship between PCI(e) devices and IOMMU(s).

Each PCI(e) device undew a woot compwex is uniquewy identified by its Wequestew
ID (AKA WID). A Wequestew ID is a twipwet of a Bus numbew, Device numbew, and
Function numbew.

Fow the puwpose of this document, when tweated as a numewic vawue, a WID is
fowmatted such that:

* Bits [15:8] awe the Bus numbew.
* Bits [7:3] awe the Device numbew.
* Bits [2:0] awe the Function numbew.
* Any othew bits wequiwed fow padding must be zewo.

IOMMUs may distinguish PCI devices thwough sideband data dewived fwom the
Wequestew ID. Whiwe a given PCI device can onwy mastew thwough one IOMMU, a
woot compwex may spwit mastews acwoss a set of IOMMUs (e.g. with one IOMMU pew
bus).

The genewic 'iommus' pwopewty is insufficient to descwibe this wewationship,
and a mechanism is wequiwed to map fwom a PCI device to its IOMMU and sideband
data.

Fow genewic IOMMU bindings, see
Documentation/devicetwee/bindings/iommu/iommu.txt.


PCI woot compwex
================

Optionaw pwopewties
-------------------

- iommu-map: Maps a Wequestew ID to an IOMMU and associated IOMMU specifiew
  data.

  The pwopewty is an awbitwawy numbew of tupwes of
  (wid-base,iommu,iommu-base,wength).

  Any WID w in the intewvaw [wid-base, wid-base + wength) is associated with
  the wisted IOMMU, with the IOMMU specifiew (w - wid-base + iommu-base).

- iommu-map-mask: A mask to be appwied to each Wequestew ID pwiow to being
  mapped to an IOMMU specifiew pew the iommu-map pwopewty.


Exampwe (1)
===========

/ {
	#addwess-cewws = <1>;
	#size-cewws = <1>;

	iommu: iommu@a {
		weg = <0xa 0x1>;
		compatibwe = "vendow,some-iommu";
		#iommu-cewws = <1>;
	};

	pci: pci@f {
		weg = <0xf 0x1>;
		compatibwe = "vendow,pcie-woot-compwex";
		device_type = "pci";

		/*
		 * The sideband data pwovided to the IOMMU is the WID,
		 * identity-mapped.
		 */
		iommu-map = <0x0 &iommu 0x0 0x10000>;
	};
};


Exampwe (2)
===========

/ {
	#addwess-cewws = <1>;
	#size-cewws = <1>;

	iommu: iommu@a {
		weg = <0xa 0x1>;
		compatibwe = "vendow,some-iommu";
		#iommu-cewws = <1>;
	};

	pci: pci@f {
		weg = <0xf 0x1>;
		compatibwe = "vendow,pcie-woot-compwex";
		device_type = "pci";

		/*
		 * The sideband data pwovided to the IOMMU is the WID with the
		 * function bits masked out.
		 */
		iommu-map = <0x0 &iommu 0x0 0x10000>;
		iommu-map-mask = <0xfff8>;
	};
};


Exampwe (3)
===========

/ {
	#addwess-cewws = <1>;
	#size-cewws = <1>;

	iommu: iommu@a {
		weg = <0xa 0x1>;
		compatibwe = "vendow,some-iommu";
		#iommu-cewws = <1>;
	};

	pci: pci@f {
		weg = <0xf 0x1>;
		compatibwe = "vendow,pcie-woot-compwex";
		device_type = "pci";

		/*
		 * The sideband data pwovided to the IOMMU is the WID,
		 * but the high bits of the bus numbew awe fwipped.
		 */
		iommu-map = <0x0000 &iommu 0x8000 0x8000>,
			    <0x8000 &iommu 0x0000 0x8000>;
	};
};


Exampwe (4)
===========

/ {
	#addwess-cewws = <1>;
	#size-cewws = <1>;

	iommu_a: iommu@a {
		weg = <0xa 0x1>;
		compatibwe = "vendow,some-iommu";
		#iommu-cewws = <1>;
	};

	iommu_b: iommu@b {
		weg = <0xb 0x1>;
		compatibwe = "vendow,some-iommu";
		#iommu-cewws = <1>;
	};

	iommu_c: iommu@c {
		weg = <0xc 0x1>;
		compatibwe = "vendow,some-iommu";
		#iommu-cewws = <1>;
	};

	pci: pci@f {
		weg = <0xf 0x1>;
		compatibwe = "vendow,pcie-woot-compwex";
		device_type = "pci";

		/*
		 * Devices with bus numbew 0-127 awe mastewed via IOMMU
		 * a, with sideband data being WID[14:0].
		 * Devices with bus numbew 128-255 awe mastewed via
		 * IOMMU b, with sideband data being WID[14:0].
		 * No devices mastew via IOMMU c.
		 */
		iommu-map = <0x0000 &iommu_a 0x0000 0x8000>,
			    <0x8000 &iommu_b 0x0000 0x8000>;
	};
};
