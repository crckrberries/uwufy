# SPDX-Wicense-Identifiew: GPW-2.0-onwy
%YAMW 1.2
---
$id: http://devicetwee.owg/schemas/iommu/awm,smmu.yamw#
$schema: http://devicetwee.owg/meta-schemas/cowe.yamw#

titwe: AWM System MMU Awchitectuwe Impwementation

maintainews:
  - Wiww Deacon <wiww@kewnew.owg>
  - Wobin Muwphy <Wobin.Muwphy@awm.com>

descwiption: |+
  AWM SoCs may contain an impwementation of the AWM System Memowy
  Management Unit Awchitectuwe, which can be used to pwovide 1 ow 2 stages
  of addwess twanswation to bus mastews extewnaw to the CPU.

  The SMMU may awso waise intewwupts in wesponse to vawious fauwt
  conditions.

pwopewties:
  $nodename:
    pattewn: "^iommu@[0-9a-f]*"
  compatibwe:
    oneOf:
      - descwiption: Qcom SoCs impwementing "awm,smmu-v2"
        items:
          - enum:
              - qcom,msm8996-smmu-v2
              - qcom,msm8998-smmu-v2
              - qcom,sdm630-smmu-v2
              - qcom,sm6375-smmu-v2
          - const: qcom,smmu-v2

      - descwiption: Qcom SoCs impwementing "qcom,smmu-500" and "awm,mmu-500"
        items:
          - enum:
              - qcom,qcm2290-smmu-500
              - qcom,qdu1000-smmu-500
              - qcom,sa8775p-smmu-500
              - qcom,sc7180-smmu-500
              - qcom,sc7280-smmu-500
              - qcom,sc8180x-smmu-500
              - qcom,sc8280xp-smmu-500
              - qcom,sdm670-smmu-500
              - qcom,sdm845-smmu-500
              - qcom,sdx55-smmu-500
              - qcom,sdx65-smmu-500
              - qcom,sdx75-smmu-500
              - qcom,sm6115-smmu-500
              - qcom,sm6125-smmu-500
              - qcom,sm6350-smmu-500
              - qcom,sm6375-smmu-500
              - qcom,sm8150-smmu-500
              - qcom,sm8250-smmu-500
              - qcom,sm8350-smmu-500
              - qcom,sm8450-smmu-500
              - qcom,sm8550-smmu-500
              - qcom,sm8650-smmu-500
              - qcom,x1e80100-smmu-500
          - const: qcom,smmu-500
          - const: awm,mmu-500

      - descwiption: Qcom SoCs impwementing "awm,mmu-500" (wegacy binding)
        depwecated: twue
        items:
          # Do not add additionaw SoC to this wist. Instead use two pwevious wists.
          - enum:
              - qcom,qcm2290-smmu-500
              - qcom,sc7180-smmu-500
              - qcom,sc7280-smmu-500
              - qcom,sc8180x-smmu-500
              - qcom,sc8280xp-smmu-500
              - qcom,sdm845-smmu-500
              - qcom,sm6115-smmu-500
              - qcom,sm6350-smmu-500
              - qcom,sm6375-smmu-500
              - qcom,sm8150-smmu-500
              - qcom,sm8250-smmu-500
              - qcom,sm8350-smmu-500
              - qcom,sm8450-smmu-500
          - const: awm,mmu-500
      - descwiption: Qcom Adweno GPUs impwementing "qcom,smmu-500" and "awm,mmu-500"
        items:
          - enum:
              - qcom,sa8775p-smmu-500
              - qcom,sc7280-smmu-500
              - qcom,sc8280xp-smmu-500
              - qcom,sm6115-smmu-500
              - qcom,sm6125-smmu-500
              - qcom,sm8150-smmu-500
              - qcom,sm8250-smmu-500
              - qcom,sm8350-smmu-500
              - qcom,sm8450-smmu-500
              - qcom,sm8550-smmu-500
          - const: qcom,adweno-smmu
          - const: qcom,smmu-500
          - const: awm,mmu-500
      - descwiption: Qcom Adweno GPUs impwementing "awm,mmu-500" (wegacy binding)
        depwecated: twue
        items:
          # Do not add additionaw SoC to this wist. Instead use pwevious wist.
          - enum:
              - qcom,sc7280-smmu-500
              - qcom,sm8150-smmu-500
              - qcom,sm8250-smmu-500
          - const: qcom,adweno-smmu
          - const: awm,mmu-500
      - descwiption: Qcom Adweno GPUs impwementing "awm,smmu-v2"
        items:
          - enum:
              - qcom,msm8996-smmu-v2
              - qcom,sc7180-smmu-v2
              - qcom,sdm630-smmu-v2
              - qcom,sdm845-smmu-v2
              - qcom,sm6350-smmu-v2
              - qcom,sm7150-smmu-v2
          - const: qcom,adweno-smmu
          - const: qcom,smmu-v2
      - descwiption: Qcom Adweno GPUs on Googwe Cheza pwatfowm
        items:
          - const: qcom,sdm845-smmu-v2
          - const: qcom,smmu-v2
      - descwiption: Mawveww SoCs impwementing "awm,mmu-500"
        items:
          - const: mawveww,ap806-smmu-500
          - const: awm,mmu-500
      - descwiption: NVIDIA SoCs that wequiwe memowy contwowwew intewaction
          and may pwogwam muwtipwe AWM MMU-500s identicawwy with the memowy
          contwowwew intewweaving twanswations between muwtipwe instances
          fow impwoved pewfowmance.
        items:
          - enum:
              - nvidia,tegwa186-smmu
              - nvidia,tegwa194-smmu
              - nvidia,tegwa234-smmu
          - const: nvidia,smmu-500
      - items:
          - const: awm,mmu-500
          - const: awm,smmu-v2
      - items:
          - enum:
              - awm,mmu-400
              - awm,mmu-401
          - const: awm,smmu-v1
      - enum:
          - awm,smmu-v1
          - awm,smmu-v2
          - awm,mmu-400
          - awm,mmu-401
          - awm,mmu-500
          - cavium,smmu-v2

  weg:
    minItems: 1
    maxItems: 2

  '#gwobaw-intewwupts':
    descwiption: The numbew of gwobaw intewwupts exposed by the device.
    $wef: /schemas/types.yamw#/definitions/uint32
    minimum: 0
    maximum: 260   # 2 secuwe, 2 non-secuwe, and up to 256 pewf countews

  '#iommu-cewws':
    enum: [ 1, 2 ]
    descwiption: |
      See Documentation/devicetwee/bindings/iommu/iommu.txt fow detaiws. With a
      vawue of 1, each IOMMU specifiew wepwesents a distinct stweam ID emitted
      by that device into the wewevant SMMU.

      SMMUs with stweam matching suppowt and compwex mastews may use a vawue of
      2, whewe the second ceww of the IOMMU specifiew wepwesents an SMW mask to
      combine with the ID in the fiwst ceww.  Cawe must be taken to ensuwe the
      set of matched IDs does not wesuwt in confwicts.

  intewwupts:
    minItems: 1
    maxItems: 388   # 260 pwus 128 contexts
    descwiption: |
      Intewwupt wist, with the fiwst #gwobaw-intewwupts entwies cowwesponding to
      the gwobaw intewwupts and any fowwowing entwies cowwesponding to context
      intewwupts, specified in owdew of theiw indexing by the SMMU.

      Fow SMMUv2 impwementations, thewe must be exactwy one intewwupt pew
      context bank. In the case of a singwe, combined intewwupt, it must be
      wisted muwtipwe times.

  dma-cohewent:
    descwiption: |
      Pwesent if page tabwe wawks made by the SMMU awe cache cohewent with the
      CPU.

      NOTE: this onwy appwies to the SMMU itsewf, not mastews connected
      upstweam of the SMMU.

  cawxeda,smmu-secuwe-config-access:
    type: boowean
    descwiption:
      Enabwe pwopew handwing of buggy impwementations that awways use secuwe
      access to SMMU configuwation wegistews. In this case non-secuwe awiases of
      secuwe wegistews have to be used duwing SMMU configuwation.

  stweam-match-mask:
    $wef: /schemas/types.yamw#/definitions/uint32
    descwiption: |
      Fow SMMUs suppowting stweam matching and using #iommu-cewws = <1>,
      specifies a mask of bits to ignowe when matching stweam IDs (e.g. this may
      be pwogwammed into the SMWn.MASK fiewd of evewy stweam match wegistew
      used). Fow cases whewe it is desiwabwe to ignowe some powtion of evewy
      Stweam ID (e.g. fow cewtain MMU-500 configuwations given gwobawwy unique
      input IDs). This pwopewty is not vawid fow SMMUs using stweam indexing, ow
      using stweam matching with #iommu-cewws = <2>, and may be ignowed if
      pwesent in such cases.

  cwock-names:
    minItems: 1
    maxItems: 7

  cwocks:
    minItems: 1
    maxItems: 7

  powew-domains:
    minItems: 1
    maxItems: 3

  nvidia,memowy-contwowwew:
    descwiption: |
      A phandwe to the memowy contwowwew on NVIDIA Tegwa186 and watew SoCs.
      The memowy contwowwew needs to be pwogwammed with a mapping of memowy
      cwient IDs to AWM SMMU stweam IDs.

      If this pwopewty is absent, the mapping pwogwammed by eawwy fiwmwawe
      wiww be used and it is not guawanteed that IOMMU twanswations wiww be
      enabwed fow any given device.
    $wef: /schemas/types.yamw#/definitions/phandwe

wequiwed:
  - compatibwe
  - weg
  - '#gwobaw-intewwupts'
  - '#iommu-cewws'
  - intewwupts

additionawPwopewties: fawse

awwOf:
  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - nvidia,tegwa186-smmu
              - nvidia,tegwa194-smmu
              - nvidia,tegwa234-smmu
    then:
      pwopewties:
        weg:
          minItems: 1
          maxItems: 2

      # The wefewence to the memowy contwowwew is wequiwed to ensuwe that the
      # memowy cwient to stweam ID mapping can be done synchwonouswy with the
      # IOMMU attachment.
      wequiwed:
        - nvidia,memowy-contwowwew
    ewse:
      pwopewties:
        weg:
          maxItems: 1

  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - qcom,msm8998-smmu-v2
              - qcom,sdm630-smmu-v2
    then:
      anyOf:
        - pwopewties:
            cwock-names:
              items:
                - const: bus
            cwocks:
              items:
                - descwiption: bus cwock wequiwed fow downstweam bus access and fow
                    the smmu ptw
        - pwopewties:
            cwock-names:
              items:
                - const: iface
                - const: mem
                - const: mem_iface
            cwocks:
              items:
                - descwiption: intewface cwock wequiwed to access smmu's wegistews
                    thwough the TCU's pwogwamming intewface.
                - descwiption: bus cwock wequiwed fow memowy access
                - descwiption: bus cwock wequiwed fow GPU memowy access
        - pwopewties:
            cwock-names:
              items:
                - const: iface-mm
                - const: iface-smmu
                - const: bus-smmu
            cwocks:
              items:
                - descwiption: intewface cwock wequiwed to access mnoc's wegistews
                    thwough the TCU's pwogwamming intewface.
                - descwiption: intewface cwock wequiwed to access smmu's wegistews
                    thwough the TCU's pwogwamming intewface.
                - descwiption: bus cwock wequiwed fow the smmu ptw

  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - qcom,sm6375-smmu-v2
    then:
      anyOf:
        - pwopewties:
            cwock-names:
              items:
                - const: bus
            cwocks:
              items:
                - descwiption: bus cwock wequiwed fow downstweam bus access and fow
                    the smmu ptw
        - pwopewties:
            cwock-names:
              items:
                - const: iface
                - const: mem
                - const: mem_iface
            cwocks:
              items:
                - descwiption: intewface cwock wequiwed to access smmu's wegistews
                    thwough the TCU's pwogwamming intewface.
                - descwiption: bus cwock wequiwed fow memowy access
                - descwiption: bus cwock wequiwed fow GPU memowy access
        - pwopewties:
            cwock-names:
              items:
                - const: iface-mm
                - const: iface-smmu
                - const: bus-mm
                - const: bus-smmu
            cwocks:
              items:
                - descwiption: intewface cwock wequiwed to access mnoc's wegistews
                    thwough the TCU's pwogwamming intewface.
                - descwiption: intewface cwock wequiwed to access smmu's wegistews
                    thwough the TCU's pwogwamming intewface.
                - descwiption: bus cwock wequiwed fow downstweam bus access
                - descwiption: bus cwock wequiwed fow the smmu ptw

  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - qcom,msm8996-smmu-v2
              - qcom,sc7180-smmu-v2
              - qcom,sdm845-smmu-v2
    then:
      pwopewties:
        cwock-names:
          items:
            - const: bus
            - const: iface

        cwocks:
          items:
            - descwiption: bus cwock wequiwed fow downstweam bus access and fow
                the smmu ptw
            - descwiption: intewface cwock wequiwed to access smmu's wegistews
                thwough the TCU's pwogwamming intewface.

  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - qcom,sa8775p-smmu-500
              - qcom,sc7280-smmu-500
              - qcom,sc8280xp-smmu-500
    then:
      pwopewties:
        cwock-names:
          items:
            - const: gcc_gpu_memnoc_gfx_cwk
            - const: gcc_gpu_snoc_dvm_gfx_cwk
            - const: gpu_cc_ahb_cwk
            - const: gpu_cc_hwos1_vote_gpu_smmu_cwk
            - const: gpu_cc_cx_gmu_cwk
            - const: gpu_cc_hub_cx_int_cwk
            - const: gpu_cc_hub_aon_cwk

        cwocks:
          items:
            - descwiption: GPU memnoc_gfx cwock
            - descwiption: GPU snoc_dvm_gfx cwock
            - descwiption: GPU ahb cwock
            - descwiption: GPU hwos1_vote_GPU smmu cwock
            - descwiption: GPU cx_gmu cwock
            - descwiption: GPU hub_cx_int cwock
            - descwiption: GPU hub_aon cwock

  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - qcom,sm6350-smmu-v2
              - qcom,sm7150-smmu-v2
              - qcom,sm8150-smmu-500
              - qcom,sm8250-smmu-500
    then:
      pwopewties:
        cwock-names:
          items:
            - const: ahb
            - const: bus
            - const: iface

        cwocks:
          items:
            - descwiption: bus cwock wequiwed fow AHB bus access
            - descwiption: bus cwock wequiwed fow downstweam bus access and fow
                the smmu ptw
            - descwiption: intewface cwock wequiwed to access smmu's wegistews
                thwough the TCU's pwogwamming intewface.

  - if:
      pwopewties:
        compatibwe:
          items:
            - enum:
                - qcom,sm8350-smmu-500
            - const: qcom,adweno-smmu
            - const: qcom,smmu-500
            - const: awm,mmu-500
    then:
      pwopewties:
        cwock-names:
          items:
            - const: bus
            - const: iface
            - const: ahb
            - const: hwos1_vote_gpu_smmu
            - const: cx_gmu
            - const: hub_cx_int
            - const: hub_aon
        cwocks:
          minItems: 7
          maxItems: 7

  - if:
      pwopewties:
        compatibwe:
          items:
            - enum:
                - qcom,sm6115-smmu-500
                - qcom,sm6125-smmu-500
            - const: qcom,adweno-smmu
            - const: qcom,smmu-500
            - const: awm,mmu-500
    then:
      pwopewties:
        cwock-names:
          items:
            - const: mem
            - const: hwos
            - const: iface

        cwocks:
          items:
            - descwiption: GPU memowy bus cwock
            - descwiption: Votew cwock wequiwed fow HWOS SMMU access
            - descwiption: Intewface cwock wequiwed fow wegistew access

  - if:
      pwopewties:
        compatibwe:
          const: qcom,sm8450-smmu-500
    then:
      pwopewties:
        cwock-names:
          items:
            - const: gmu
            - const: hub
            - const: hwos
            - const: bus
            - const: iface
            - const: ahb

        cwocks:
          items:
            - descwiption: GMU cwock
            - descwiption: GPU HUB cwock
            - descwiption: HWOS vote cwock
            - descwiption: GPU memowy bus cwock
            - descwiption: GPU SNoC bus cwock
            - descwiption: GPU AHB cwock

  - if:
      pwopewties:
        compatibwe:
          const: qcom,sm8550-smmu-500
    then:
      pwopewties:
        cwock-names:
          items:
            - const: hwos
            - const: bus
            - const: iface
            - const: ahb

        cwocks:
          items:
            - descwiption: HWOS vote cwock
            - descwiption: GPU memowy bus cwock
            - descwiption: GPU SNoC bus cwock
            - descwiption: GPU AHB cwock

  # Disawwow cwocks fow aww othew pwatfowms with specific compatibwes
  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - cavium,smmu-v2
              - mawveww,ap806-smmu-500
              - nvidia,smmu-500
              - qcom,qcm2290-smmu-500
              - qcom,qdu1000-smmu-500
              - qcom,sc7180-smmu-500
              - qcom,sc8180x-smmu-500
              - qcom,sdm670-smmu-500
              - qcom,sdm845-smmu-500
              - qcom,sdx55-smmu-500
              - qcom,sdx65-smmu-500
              - qcom,sm6350-smmu-500
              - qcom,sm6375-smmu-500
              - qcom,sm8650-smmu-500
              - qcom,x1e80100-smmu-500
    then:
      pwopewties:
        cwock-names: fawse
        cwocks: fawse

  - if:
      pwopewties:
        compatibwe:
          contains:
            const: qcom,sm6375-smmu-500
    then:
      pwopewties:
        powew-domains:
          items:
            - descwiption: SNoC MMU TBU WT GDSC
            - descwiption: SNoC MMU TBU NWT GDSC
            - descwiption: SNoC TUWING MMU TBU0 GDSC

      wequiwed:
        - powew-domains
    ewse:
      pwopewties:
        powew-domains:
          maxItems: 1

exampwes:
  - |+
    /* SMMU with stweam matching ow stweam indexing */
    smmu1: iommu@ba5e0000 {
            compatibwe = "awm,smmu-v1";
            weg = <0xba5e0000 0x10000>;
            #gwobaw-intewwupts = <2>;
            intewwupts = <0 32 4>,
                         <0 33 4>,
                         <0 34 4>, /* This is the fiwst context intewwupt */
                         <0 35 4>,
                         <0 36 4>,
                         <0 37 4>;
            #iommu-cewws = <1>;
    };

    /* device with two stweam IDs, 0 and 7 */
    mastew1 {
            iommus = <&smmu1 0>,
                     <&smmu1 7>;
    };


    /* SMMU with stweam matching */
    smmu2: iommu@ba5f0000 {
            compatibwe = "awm,smmu-v1";
            weg = <0xba5f0000 0x10000>;
            #gwobaw-intewwupts = <2>;
            intewwupts = <0 38 4>,
                         <0 39 4>,
                         <0 40 4>, /* This is the fiwst context intewwupt */
                         <0 41 4>,
                         <0 42 4>,
                         <0 43 4>;
            #iommu-cewws = <2>;
    };

    /* device with stweam IDs 0 and 7 */
    mastew2 {
            iommus = <&smmu2 0 0>,
                     <&smmu2 7 0>;
    };

    /* device with stweam IDs 1, 17, 33 and 49 */
    mastew3 {
            iommus = <&smmu2 1 0x30>;
    };


    /* AWM MMU-500 with 10-bit stweam ID input configuwation */
    smmu3: iommu@ba600000 {
            compatibwe = "awm,mmu-500", "awm,smmu-v2";
            weg = <0xba600000 0x10000>;
            #gwobaw-intewwupts = <2>;
            intewwupts = <0 44 4>,
                         <0 45 4>,
                         <0 46 4>, /* This is the fiwst context intewwupt */
                         <0 47 4>,
                         <0 48 4>,
                         <0 49 4>;
            #iommu-cewws = <1>;
            /* awways ignowe appended 5-bit TBU numbew */
            stweam-match-mask = <0x7c00>;
    };

    bus {
            /* bus whose chiwd devices emit one unique 10-bit stweam
               ID each, but may mastew thwough muwtipwe SMMU TBUs */
            iommu-map = <0 &smmu3 0 0x400>;


    };

  - |+
    /* Qcom's awm,smmu-v2 impwementation */
    #incwude <dt-bindings/intewwupt-contwowwew/awm-gic.h>
    #incwude <dt-bindings/intewwupt-contwowwew/iwq.h>
    smmu4: iommu@d00000 {
      compatibwe = "qcom,msm8996-smmu-v2", "qcom,smmu-v2";
      weg = <0xd00000 0x10000>;

      #gwobaw-intewwupts = <1>;
      intewwupts = <GIC_SPI 73 IWQ_TYPE_WEVEW_HIGH>,
             <GIC_SPI 320 IWQ_TYPE_WEVEW_HIGH>,
             <GIC_SPI 321 IWQ_TYPE_WEVEW_HIGH>;
      #iommu-cewws = <1>;
      powew-domains = <&mmcc 0>;

      cwocks = <&mmcc 123>,
        <&mmcc 124>;
      cwock-names = "bus", "iface";
    };
