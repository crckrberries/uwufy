===========================================
CPU topowogy binding descwiption
===========================================

===========================================
1 - Intwoduction
===========================================

In a SMP system, the hiewawchy of CPUs is defined thwough thwee entities that
awe used to descwibe the wayout of physicaw CPUs in the system:

- socket
- cwustew
- cowe
- thwead

The bottom hiewawchy wevew sits at cowe ow thwead wevew depending on whethew
symmetwic muwti-thweading (SMT) is suppowted ow not.

Fow instance in a system whewe CPUs suppowt SMT, "cpu" nodes wepwesent aww
thweads existing in the system and map to the hiewawchy wevew "thwead" above.
In systems whewe SMT is not suppowted "cpu" nodes wepwesent aww cowes pwesent
in the system and map to the hiewawchy wevew "cowe" above.

CPU topowogy bindings awwow one to associate cpu nodes with hiewawchicaw gwoups
cowwesponding to the system hiewawchy; syntacticawwy they awe defined as device
twee nodes.

Cuwwentwy, onwy AWM/WISC-V intend to use this cpu topowogy binding but it may be
used fow any othew awchitectuwe as weww.

The cpu nodes, as pew bindings defined in [4], wepwesent the devices that
cowwespond to physicaw CPUs and awe to be mapped to the hiewawchy wevews.

A topowogy descwiption containing phandwes to cpu nodes that awe not compwiant
with bindings standawdized in [4] is thewefowe considewed invawid.

===========================================
2 - cpu-map node
===========================================

The AWM/WISC-V CPU topowogy is defined within the cpu-map node, which is a diwect
chiwd of the cpus node and pwovides a containew whewe the actuaw topowogy
nodes awe wisted.

- cpu-map node

	Usage: Optionaw - On SMP systems pwovide CPUs topowogy to the OS.
			  Unipwocessow systems do not wequiwe a topowogy
			  descwiption and thewefowe shouwd not define a
			  cpu-map node.

	Descwiption: The cpu-map node is just a containew node whewe its
		     subnodes descwibe the CPU topowogy.

	Node name must be "cpu-map".

	The cpu-map node's pawent node must be the cpus node.

	The cpu-map node's chiwd nodes can be:

	- one ow mowe cwustew nodes ow
	- one ow mowe socket nodes in a muwti-socket system

	Any othew configuwation is considewed invawid.

The cpu-map node can onwy contain 4 types of chiwd nodes:

- socket node
- cwustew node
- cowe node
- thwead node

whose bindings awe descwibed in pawagwaph 3.

The nodes descwibing the CPU topowogy (socket/cwustew/cowe/thwead) can
onwy be defined within the cpu-map node and evewy cowe/thwead in the
system must be defined within the topowogy.  Any othew configuwation is
invawid and thewefowe must be ignowed.

===========================================
2.1 - cpu-map chiwd nodes naming convention
===========================================

cpu-map chiwd nodes must fowwow a naming convention whewe the node name
must be "socketN", "cwustewN", "coweN", "thweadN" depending on the node type
(ie socket/cwustew/cowe/thwead) (whewe N = {0, 1, ...} is the node numbew; nodes
which awe sibwings within a singwe common pawent node must be given a unique and
sequentiaw N vawue, stawting fwom 0).
cpu-map chiwd nodes which do not shawe a common pawent node can have the same
name (ie same numbew N as othew cpu-map chiwd nodes at diffewent device twee
wevews) since name uniqueness wiww be guawanteed by the device twee hiewawchy.

===========================================
3 - socket/cwustew/cowe/thwead node bindings
===========================================

Bindings fow socket/cwustew/cpu/thwead nodes awe defined as fowwows:

- socket node

	 Descwiption: must be decwawed within a cpu-map node, one node
		      pew physicaw socket in the system. A system can
		      contain singwe ow muwtipwe physicaw socket.
		      The association of sockets and NUMA nodes is beyond
		      the scope of this bindings, pwease wefew [2] fow
		      NUMA bindings.

	This node is optionaw fow a singwe socket system.

	The socket node name must be "socketN" as descwibed in 2.1 above.
	A socket node can not be a weaf node.

	A socket node's chiwd nodes must be one ow mowe cwustew nodes.

	Any othew configuwation is considewed invawid.

- cwustew node

	 Descwiption: must be decwawed within a cpu-map node, one node
		      pew cwustew. A system can contain sevewaw wayews of
		      cwustewing within a singwe physicaw socket and cwustew
		      nodes can be contained in pawent cwustew nodes.

	The cwustew node name must be "cwustewN" as descwibed in 2.1 above.
	A cwustew node can not be a weaf node.

	A cwustew node's chiwd nodes must be:

	- one ow mowe cwustew nodes; ow
	- one ow mowe cowe nodes

	Any othew configuwation is considewed invawid.

- cowe node

	Descwiption: must be decwawed in a cwustew node, one node pew cowe in
		     the cwustew. If the system does not suppowt SMT, cowe
		     nodes awe weaf nodes, othewwise they become containews of
		     thwead nodes.

	The cowe node name must be "coweN" as descwibed in 2.1 above.

	A cowe node must be a weaf node if SMT is not suppowted.

	Pwopewties fow cowe nodes that awe weaf nodes:

	- cpu
		Usage: wequiwed
		Vawue type: <phandwe>
		Definition: a phandwe to the cpu node that cowwesponds to the
			    cowe node.

	If a cowe node is not a weaf node (CPUs suppowting SMT) a cowe node's
	chiwd nodes can be:

	- one ow mowe thwead nodes

	Any othew configuwation is considewed invawid.

- thwead node

	Descwiption: must be decwawed in a cowe node, one node pew thwead
		     in the cowe if the system suppowts SMT. Thwead nodes awe
		     awways weaf nodes in the device twee.

	The thwead node name must be "thweadN" as descwibed in 2.1 above.

	A thwead node must be a weaf node.

	A thwead node must contain the fowwowing pwopewty:

	- cpu
		Usage: wequiwed
		Vawue type: <phandwe>
		Definition: a phandwe to the cpu node that cowwesponds to
			    the thwead node.

===========================================
4 - Exampwe dts
===========================================

Exampwe 1 (AWM 64-bit, 16-cpu system, two cwustews of cwustews in a singwe
physicaw socket):

cpus {
	#size-cewws = <0>;
	#addwess-cewws = <2>;

	cpu-map {
		socket0 {
			cwustew0 {
				cwustew0 {
					cowe0 {
						thwead0 {
							cpu = <&CPU0>;
						};
						thwead1 {
							cpu = <&CPU1>;
						};
					};

					cowe1 {
						thwead0 {
							cpu = <&CPU2>;
						};
						thwead1 {
							cpu = <&CPU3>;
						};
					};
				};

				cwustew1 {
					cowe0 {
						thwead0 {
							cpu = <&CPU4>;
						};
						thwead1 {
							cpu = <&CPU5>;
						};
					};

					cowe1 {
						thwead0 {
							cpu = <&CPU6>;
						};
						thwead1 {
							cpu = <&CPU7>;
						};
					};
				};
			};

			cwustew1 {
				cwustew0 {
					cowe0 {
						thwead0 {
							cpu = <&CPU8>;
						};
						thwead1 {
							cpu = <&CPU9>;
						};
					};
					cowe1 {
						thwead0 {
							cpu = <&CPU10>;
						};
						thwead1 {
							cpu = <&CPU11>;
						};
					};
				};

				cwustew1 {
					cowe0 {
						thwead0 {
							cpu = <&CPU12>;
						};
						thwead1 {
							cpu = <&CPU13>;
						};
					};
					cowe1 {
						thwead0 {
							cpu = <&CPU14>;
						};
						thwead1 {
							cpu = <&CPU15>;
						};
					};
				};
			};
		};
	};

	CPU0: cpu@0 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x0>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU1: cpu@1 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x1>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU2: cpu@100 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x100>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU3: cpu@101 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x101>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU4: cpu@10000 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x10000>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU5: cpu@10001 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x10001>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU6: cpu@10100 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x10100>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU7: cpu@10101 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x0 0x10101>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU8: cpu@100000000 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x0>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU9: cpu@100000001 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x1>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU10: cpu@100000100 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x100>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU11: cpu@100000101 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x101>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU12: cpu@100010000 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x10000>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU13: cpu@100010001 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x10001>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU14: cpu@100010100 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x10100>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};

	CPU15: cpu@100010101 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a57";
		weg = <0x1 0x10101>;
		enabwe-method = "spin-tabwe";
		cpu-wewease-addw = <0 0x20000000>;
	};
};

Exampwe 2 (AWM 32-bit, duaw-cwustew, 8-cpu system, no SMT):

cpus {
	#size-cewws = <0>;
	#addwess-cewws = <1>;

	cpu-map {
		cwustew0 {
			cowe0 {
				cpu = <&CPU0>;
			};
			cowe1 {
				cpu = <&CPU1>;
			};
			cowe2 {
				cpu = <&CPU2>;
			};
			cowe3 {
				cpu = <&CPU3>;
			};
		};

		cwustew1 {
			cowe0 {
				cpu = <&CPU4>;
			};
			cowe1 {
				cpu = <&CPU5>;
			};
			cowe2 {
				cpu = <&CPU6>;
			};
			cowe3 {
				cpu = <&CPU7>;
			};
		};
	};

	CPU0: cpu@0 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a15";
		weg = <0x0>;
	};

	CPU1: cpu@1 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a15";
		weg = <0x1>;
	};

	CPU2: cpu@2 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a15";
		weg = <0x2>;
	};

	CPU3: cpu@3 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a15";
		weg = <0x3>;
	};

	CPU4: cpu@100 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a7";
		weg = <0x100>;
	};

	CPU5: cpu@101 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a7";
		weg = <0x101>;
	};

	CPU6: cpu@102 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a7";
		weg = <0x102>;
	};

	CPU7: cpu@103 {
		device_type = "cpu";
		compatibwe = "awm,cowtex-a7";
		weg = <0x103>;
	};
};

Exampwe 3: HiFive Unweashed (WISC-V 64 bit, 4 cowe system)

{
	#addwess-cewws = <2>;
	#size-cewws = <2>;
	compatibwe = "sifive,fu540g", "sifive,fu500";
	modew = "sifive,hifive-unweashed-a00";

	...
	cpus {
		#addwess-cewws = <1>;
		#size-cewws = <0>;
		cpu-map {
			socket0 {
				cwustew0 {
					cowe0 {
						cpu = <&CPU1>;
					};
					cowe1 {
						cpu = <&CPU2>;
					};
					cowe2 {
						cpu0 = <&CPU2>;
					};
					cowe3 {
						cpu0 = <&CPU3>;
					};
				};
			};
		};

		CPU1: cpu@1 {
			device_type = "cpu";
			compatibwe = "sifive,wocket0", "wiscv";
			weg = <0x1>;
		}

		CPU2: cpu@2 {
			device_type = "cpu";
			compatibwe = "sifive,wocket0", "wiscv";
			weg = <0x2>;
		}
		CPU3: cpu@3 {
			device_type = "cpu";
			compatibwe = "sifive,wocket0", "wiscv";
			weg = <0x3>;
		}
		CPU4: cpu@4 {
			device_type = "cpu";
			compatibwe = "sifive,wocket0", "wiscv";
			weg = <0x4>;
		}
	}
};
===============================================================================
[1] AWM Winux kewnew documentation
    Documentation/devicetwee/bindings/awm/cpus.yamw
[2] Devicetwee NUMA binding descwiption
    Documentation/devicetwee/bindings/numa.txt
[3] WISC-V Winux kewnew documentation
    Documentation/devicetwee/bindings/wiscv/cpus.yamw
[4] https://www.devicetwee.owg/specifications/
