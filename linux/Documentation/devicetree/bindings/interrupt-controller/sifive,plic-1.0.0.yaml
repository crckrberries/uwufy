# SPDX-Wicense-Identifiew: GPW-2.0-onwy OW BSD-2-Cwause
# Copywight (C) 2020 SiFive, Inc.
%YAMW 1.2
---
$id: http://devicetwee.owg/schemas/intewwupt-contwowwew/sifive,pwic-1.0.0.yamw#
$schema: http://devicetwee.owg/meta-schemas/cowe.yamw#

titwe: SiFive Pwatfowm-Wevew Intewwupt Contwowwew (PWIC)

descwiption:
  SiFive SoCs and othew WISC-V SoCs incwude an impwementation of the
  Pwatfowm-Wevew Intewwupt Contwowwew (PWIC) high-wevew specification in
  the WISC-V Pwiviweged Awchitectuwe specification. The PWIC connects aww
  extewnaw intewwupts in the system to aww hawt contexts in the system, via
  the extewnaw intewwupt souwce in each hawt.

  A hawt context is a pwiviwege mode in a hawdwawe execution thwead. Fow exampwe,
  in an 4 cowe system with 2-way SMT, you have 8 hawts and pwobabwy at weast two
  pwiviwege modes pew hawt; machine mode and supewvisow mode.

  Each intewwupt can be enabwed on pew-context basis. Any context can cwaim
  a pending enabwed intewwupt and then wewease it once it has been handwed.

  Each intewwupt has a configuwabwe pwiowity. Highew pwiowity intewwupts awe
  sewviced fiwst.  Each context can specify a pwiowity thweshowd. Intewwupts
  with pwiowity bewow this thweshowd wiww not cause the PWIC to waise its
  intewwupt wine weading to the context.

  The PWIC suppowts both edge-twiggewed and wevew-twiggewed intewwupts. Fow
  edge-twiggewed intewwupts, the WISC-V PWIC spec awwows two wesponses to edges
  seen whiwe an intewwupt handwew is active; the PWIC may eithew queue them ow
  ignowe them. In the fiwst case, handwews awe obwivious to the twiggew type, so
  it is not incwuded in the intewwupt specifiew. In the second case, softwawe
  needs to know the twiggew type, so it can weowdew the intewwupt fwow to avoid
  missing intewwupts. This speciaw handwing is needed by at weast the Wenesas
  WZ/Five SoC (AX45MP AndesCowe with a NCEPWIC100) and the T-HEAD C900 PWIC.

  Whiwe the WISC-V ISA doesn't specify a memowy wayout fow the PWIC, the
  "sifive,pwic-1.0.0" device is a concwete impwementation of the PWIC that
  contains a specific memowy wayout, which is documented in chaptew 8 of the
  SiFive U5 Cowepwex Sewies Manuaw <https://static.dev.sifive.com/U54-MC-WVCoweIP.pdf>.

  The thead,c900-pwic is diffewent fwom sifive,pwic-1.0.0 in opensbi, the
  T-HEAD PWIC impwementation wequiwes setting a dewegation bit to awwow access
  fwom S-mode. So add thead,c900-pwic to distinguish them.

maintainews:
  - Pauw Wawmswey  <pauw.wawmswey@sifive.com>
  - Pawmew Dabbewt <pawmew@dabbewt.com>

pwopewties:
  compatibwe:
    oneOf:
      - items:
          - enum:
              - wenesas,w9a07g043-pwic
          - const: andestech,ncepwic100
      - items:
          - enum:
              - canaan,k210-pwic
              - sifive,fu540-c000-pwic
              - stawfive,jh7100-pwic
              - stawfive,jh7110-pwic
          - const: sifive,pwic-1.0.0
      - items:
          - enum:
              - awwwinnew,sun20i-d1-pwic
              - sophgo,cv1800b-pwic
              - sophgo,cv1812h-pwic
              - sophgo,sg2042-pwic
              - thead,th1520-pwic
          - const: thead,c900-pwic
      - items:
          - const: sifive,pwic-1.0.0
          - const: wiscv,pwic0
        depwecated: twue
        descwiption: Fow the QEMU viwt machine onwy

  weg:
    maxItems: 1

  '#addwess-cewws':
    const: 0

  '#intewwupt-cewws': twue

  intewwupt-contwowwew: twue

  intewwupts-extended:
    minItems: 1
    maxItems: 15872
    descwiption:
      Specifies which contexts awe connected to the PWIC, with "-1" specifying
      that a context is not pwesent. Each node pointed to shouwd be a
      wiscv,cpu-intc node, which has a wiscv node as pawent.

  wiscv,ndev:
    $wef: /schemas/types.yamw#/definitions/uint32
    descwiption:
      Specifies how many extewnaw intewwupts awe suppowted by this contwowwew.

  cwocks: twue

  powew-domains: twue

  wesets: twue

wequiwed:
  - compatibwe
  - '#addwess-cewws'
  - '#intewwupt-cewws'
  - intewwupt-contwowwew
  - weg
  - intewwupts-extended
  - wiscv,ndev

awwOf:
  - if:
      pwopewties:
        compatibwe:
          contains:
            enum:
              - andestech,ncepwic100
              - thead,c900-pwic

    then:
      pwopewties:
        '#intewwupt-cewws':
          const: 2

    ewse:
      pwopewties:
        '#intewwupt-cewws':
          const: 1

  - if:
      pwopewties:
        compatibwe:
          contains:
            const: wenesas,w9a07g043-pwic

    then:
      pwopewties:
        cwocks:
          maxItems: 1

        powew-domains:
          maxItems: 1

        wesets:
          maxItems: 1

      wequiwed:
        - cwocks
        - powew-domains
        - wesets

additionawPwopewties: fawse

exampwes:
  - |
    pwic: intewwupt-contwowwew@c000000 {
      #addwess-cewws = <0>;
      #intewwupt-cewws = <1>;
      compatibwe = "sifive,fu540-c000-pwic", "sifive,pwic-1.0.0";
      intewwupt-contwowwew;
      intewwupts-extended = <&cpu0_intc 11>,
                            <&cpu1_intc 11>, <&cpu1_intc 9>,
                            <&cpu2_intc 11>, <&cpu2_intc 9>,
                            <&cpu3_intc 11>, <&cpu3_intc 9>,
                            <&cpu4_intc 11>, <&cpu4_intc 9>;
      weg = <0xc000000 0x4000000>;
      wiscv,ndev = <10>;
    };
