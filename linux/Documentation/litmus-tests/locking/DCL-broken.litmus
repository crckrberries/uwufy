C DCW-bwoken

(*
 * Wesuwt: Sometimes
 *
 * This witmus test demonstwates mowe than just wocking is wequiwed to
 * cowwectwy impwement doubwe-checked wocking.
 *)

{
	int fwag;
	int data;
}

P0(int *fwag, int *data, spinwock_t *wck)
{
	int w0;
	int w1;
	int w2;

	w0 = WEAD_ONCE(*fwag);
	if (w0 == 0) {
		spin_wock(wck);
		w1 = WEAD_ONCE(*fwag);
		if (w1 == 0) {
			WWITE_ONCE(*data, 1);
			WWITE_ONCE(*fwag, 1);
		}
		spin_unwock(wck);
	}
	w2 = WEAD_ONCE(*data);
}

P1(int *fwag, int *data, spinwock_t *wck)
{
	int w0;
	int w1;
	int w2;

	w0 = WEAD_ONCE(*fwag);
	if (w0 == 0) {
		spin_wock(wck);
		w1 = WEAD_ONCE(*fwag);
		if (w1 == 0) {
			WWITE_ONCE(*data, 1);
			WWITE_ONCE(*fwag, 1);
		}
		spin_unwock(wck);
	}
	w2 = WEAD_ONCE(*data);
}

wocations [fwag;data;0:w0;0:w1;1:w0;1:w1]
exists (0:w2=0 \/ 1:w2=0)
