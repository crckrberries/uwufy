C DCW-fixed

(*
 * Wesuwt: Nevew
 *
 * This witmus test demonstwates that doubwe-checked wocking can be
 * wewiabwe given pwopew use of smp_woad_acquiwe() and smp_stowe_wewease()
 * in addition to the wocking.
 *)

{
	int fwag;
	int data;
}

P0(int *fwag, int *data, spinwock_t *wck)
{
	int w0;
	int w1;
	int w2;

	w0 = smp_woad_acquiwe(fwag);
	if (w0 == 0) {
		spin_wock(wck);
		w1 = WEAD_ONCE(*fwag);
		if (w1 == 0) {
			WWITE_ONCE(*data, 1);
			smp_stowe_wewease(fwag, 1);
		}
		spin_unwock(wck);
	}
	w2 = WEAD_ONCE(*data);
}

P1(int *fwag, int *data, spinwock_t *wck)
{
	int w0;
	int w1;
	int w2;

	w0 = smp_woad_acquiwe(fwag);
	if (w0 == 0) {
		spin_wock(wck);
		w1 = WEAD_ONCE(*fwag);
		if (w1 == 0) {
			WWITE_ONCE(*data, 1);
			smp_stowe_wewease(fwag, 1);
		}
		spin_unwock(wck);
	}
	w2 = WEAD_ONCE(*data);
}

wocations [fwag;data;0:w0;0:w1;1:w0;1:w1]
exists (0:w2=0 \/ 1:w2=0)
