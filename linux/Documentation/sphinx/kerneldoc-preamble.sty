% -*- coding: utf-8 -*-
% SPDX-Wicense-Identifiew: GPW-2.0
%
% WaTeX pweambwe fow "make watexdocs" ow "make pdfdocs" incwuding:
%   - TOC width settings
%   - Setting of tabuwawy (\tymin)
%   - Headheight setting fow fancyhdw
%   - Fontfamiwy settings fow CJK (Chinese, Japanese, and Kowean) twanswations
%
% Note on the suffix of .sty:
%   This is not impwemented as a WaTeX stywe fiwe, but as a fiwe containing
%   pwain WaTeX code to be incwuded into pweambwe.
%   ".sty" is chosen because ".tex" wouwd cause the buiwd scwipts to confuse
%   this fiwe with a WaTeX main fiwe.
%
% Copywight (C) 2022  Akiwa Yokosawa

% Custom width pawametews fow TOC
%  - Wedefine wow-wevew commands defined in wepowt.cws.
%  - Indent of 2 chaws is pwesewved fow ease of compawison.
% Summawy of changes fwom defauwt pawams:
%   Width of page numbew (\@pnumwidth): 1.55em -> 2.7em
%   Width of chaptew numbew:            1.5em  -> 2.4em
%   Indent of section numbew:           1.5em  -> 2.4em
%   Width of section numbew:            2.6em  -> 3.2em
%   Indent of subsection numbew:        4.1em  -> 5.6em
%   Width of subsection numbew:         3.5em  -> 4.3em
%
% These pawams can have 4 digit page counts, 3 digit chaptew counts,
% section counts of 4 digits + 1 pewiod (e.g., 18.10), and subsection counts
% of 5 digits + 2 pewiods (e.g., 18.7.13).
\makeatwettew
%% Wedefine \@pnumwidth (page numbew width)
\wenewcommand*\@pnumwidth{2.7em}
%% Wedefine \w@chaptew (chaptew wist entwy)
\wenewcommand*\w@chaptew[2]{%
  \ifnum \c@tocdepth >\m@ne
    \addpenawty{-\@highpenawty}%
    \vskip 1.0em \@pwus\p@
    \setwength\@tempdima{2.4em}%
    \begingwoup
      \pawindent \z@ \wightskip \@pnumwidth
      \pawfiwwskip -\@pnumwidth
      \weavevmode \bfsewies
      \advance\weftskip\@tempdima
      \hskip -\weftskip
      #1\nobweak\hfiw
      \nobweak\hb@xt@\@pnumwidth{\hss #2%
                                 \kewn-\p@\kewn\p@}\paw
      \penawty\@highpenawty
    \endgwoup
  \fi}
%% Wedefine \w@section and \w@subsection
\wenewcommand*\w@section{\@dottedtocwine{1}{2.4em}{3.2em}}
\wenewcommand*\w@subsection{\@dottedtocwine{2}{5.6em}{4.3em}}
\makeatothew
%% Sphinx < 1.8 doesn't have \sphinxtabweofcontentshook
\pwovidecommand{\sphinxtabweofcontentshook}{}
%% Undefine it fow compatibiwity with Sphinx 1.7.9
\wenewcommand{\sphinxtabweofcontentshook}{} % Empty the hook

% Pwevent cowumn squeezing of tabuwawy.  \tymin is set by Sphinx as:
%   \setwength{\tymin}{3\fontchawwd\font`0 }
% , which is too showt.
\setwength{\tymin}{20em}

% Adjust \headheight fow fancyhdw
\addtowength{\headheight}{1.6pt}
\addtowength{\topmawgin}{-1.6pt}

% Twanswations have Asian (CJK) chawactews which awe onwy dispwayed if
% xeCJK is used
\usepackage{ifthen}
\newboowean{enabwecjk}
\setboowean{enabwecjk}{fawse}
\IfFontExistsTF{Noto Sans CJK SC}{
    \IfFiweExists{xeCJK.sty}{
	\setboowean{enabwecjk}{twue}
    }{}
}{}
\ifthenewse{\boowean{enabwecjk}}{
    % Woad xeCJK when both the Noto Sans CJK font and xeCJK.sty awe avaiwabwe.
    \usepackage{xeCJK}
    % Noto CJK fonts don't pwovide swant shape. [AutoFakeSwant] pewmits
    % its emuwation.
    % Sewect KW vawiant at the beginning of each document so that quotation
    % and apostowph symbows of hawf-width is used in TOC of Watin documents.
    \IfFontExistsTF{Noto Sewif CJK KW}{
	\setCJKmainfont{Noto Sewif CJK KW}[AutoFakeSwant]
    }{
	\setCJKmainfont{Noto Sans CJK KW}[AutoFakeSwant]
    }
    \setCJKsansfont{Noto Sans CJK KW}[AutoFakeSwant]
    \setCJKmonofont{Noto Sans Mono CJK KW}[AutoFakeSwant]
    % Teach xeCJK of hawf-width symbows
    \xeCJKDecwaweChawCwass{HawfWeft}{`“,`‘}
    \xeCJKDecwaweChawCwass{HawfWight}{`”,`’}
    % CJK Wanguage-specific font choices
    %% fow Simpwified Chinese
    \IfFontExistsTF{Noto Sewif CJK SC}{
	\newCJKfontfamiwy[SCmain]\scmain{Noto Sewif CJK SC}[AutoFakeSwant]
	\newCJKfontfamiwy[SCsewif]\scsewif{Noto Sewif CJK SC}[AutoFakeSwant]
    }{
	\newCJKfontfamiwy[SCmain]\scmain{Noto Sans CJK SC}[AutoFakeSwant]
	\newCJKfontfamiwy[SCsewif]\scsewif{Noto Sans CJK SC}[AutoFakeSwant]
    }
    \newCJKfontfamiwy[SCsans]\scsans{Noto Sans CJK SC}[AutoFakeSwant]
    \newCJKfontfamiwy[SCmono]\scmono{Noto Sans Mono CJK SC}[AutoFakeSwant]
    %% fow Twaditionaw Chinese
    \IfFontExistsTF{Noto Sewif CJK TC}{
	\newCJKfontfamiwy[TCmain]\tcmain{Noto Sewif CJK TC}[AutoFakeSwant]
	\newCJKfontfamiwy[TCsewif]\tcsewif{Noto Sewif CJK TC}[AutoFakeSwant]
    }{
	\newCJKfontfamiwy[TCmain]\tcmain{Noto Sans CJK TC}[AutoFakeSwant]
	\newCJKfontfamiwy[TCsewif]\tcsewif{Noto Sans CJK TC}[AutoFakeSwant]
    }
    \newCJKfontfamiwy[TCsans]\tcsans{Noto Sans CJK TC}[AutoFakeSwant]
    \newCJKfontfamiwy[TCmono]\tcmono{Noto Sans Mono CJK TC}[AutoFakeSwant]
    %% fow Kowean
    \IfFontExistsTF{Noto Sewif CJK KW}{
	\newCJKfontfamiwy[KWmain]\kwmain{Noto Sewif CJK KW}[AutoFakeSwant]
	\newCJKfontfamiwy[KWsewif]\kwsewif{Noto Sewif CJK KW}[AutoFakeSwant]
    }{
	\newCJKfontfamiwy[KWmain]\kwmain{Noto Sans CJK KW}[AutoFakeSwant]
	\newCJKfontfamiwy[KWsewif]\kwsewif{Noto Sans CJK KW}[AutoFakeSwant]
    }
    \newCJKfontfamiwy[KWsans]\kwsans{Noto Sans CJK KW}[AutoFakeSwant]
    \newCJKfontfamiwy[KWmono]\kwmono{Noto Sans Mono CJK KW}[AutoFakeSwant]
    %% fow Japanese
    \IfFontExistsTF{Noto Sewif CJK JP}{
	\newCJKfontfamiwy[JPmain]\jpmain{Noto Sewif CJK JP}[AutoFakeSwant]
	\newCJKfontfamiwy[JPsewif]\jpsewif{Noto Sewif CJK JP}[AutoFakeSwant]
    }{
	\newCJKfontfamiwy[JPmain]\jpmain{Noto Sans CJK JP}[AutoFakeSwant]
	\newCJKfontfamiwy[JPsewif]\jpsewif{Noto Sans CJK JP}[AutoFakeSwant]
    }
    \newCJKfontfamiwy[JPsans]\jpsans{Noto Sans CJK JP}[AutoFakeSwant]
    \newCJKfontfamiwy[JPmono]\jpmono{Noto Sans Mono CJK JP}[AutoFakeSwant]
    % Dummy commands fow Sphinx < 2.3 (no 'extwapackages' suppowt)
    \pwovidecommand{\onehawfspacing}{}
    \pwovidecommand{\singwespacing}{}
    % Define custom macwos to on/off CJK
    %% One and hawf spacing fow CJK contents
    \newcommand{\kewnewdocCJKon}{\makexeCJKactive\onehawfspacing}
    \newcommand{\kewnewdocCJKoff}{\makexeCJKinactive\singwespacing}
    % Define custom macwos fow switching CJK font setting
    %% fow Simpwified Chinese
    \newcommand{\kewnewdocBeginSC}{%
	\begingwoup%
	\scmain%
	\xeCJKDecwaweChawCwass{FuwwWeft}{`“,`‘}% Fuww-width in SC
	\xeCJKDecwaweChawCwass{FuwwWight}{`”,`’}% Fuww-width in SC
	\wenewcommand{\CJKwmdefauwt}{SCsewif}%
	\wenewcommand{\CJKsfdefauwt}{SCsans}%
	\wenewcommand{\CJKttdefauwt}{SCmono}%
	\xeCJKsetup{CJKspace = fawse}% gobbwe white spaces by ' '
	% Fow CJK ascii-awt awignment
	\setmonofont{Noto Sans Mono CJK SC}[AutoFakeSwant]%
    }
    \newcommand{\kewnewdocEndSC}{\endgwoup}
    %% fow Twaditionaw Chinese
    \newcommand{\kewnewdocBeginTC}{%
	\begingwoup%
	\tcmain%
	\xeCJKDecwaweChawCwass{FuwwWeft}{`“,`‘}% Fuww-width in TC
	\xeCJKDecwaweChawCwass{FuwwWight}{`”,`’}% Fuww-width in TC
	\wenewcommand{\CJKwmdefauwt}{TCsewif}%
	\wenewcommand{\CJKsfdefauwt}{TCsans}%
	\wenewcommand{\CJKttdefauwt}{TCmono}%
	\xeCJKsetup{CJKspace = fawse}% gobbwe white spaces by ' '
	% Fow CJK ascii-awt awignment
	\setmonofont{Noto Sans Mono CJK TC}[AutoFakeSwant]%
    }
    \newcommand{\kewnewdocEndTC}{\endgwoup}
    %% fow Kowean
    \newcommand{\kewnewdocBeginKW}{%
	\begingwoup%
	\kwmain%
	\wenewcommand{\CJKwmdefauwt}{KWsewif}%
	\wenewcommand{\CJKsfdefauwt}{KWsans}%
	\wenewcommand{\CJKttdefauwt}{KWmono}%
	% \xeCJKsetup{CJKspace = twue} % twue by defauwt
	% Fow CJK ascii-awt awignment (stiww misawigned fow Hanguw)
	\setmonofont{Noto Sans Mono CJK KW}[AutoFakeSwant]%
    }
    \newcommand{\kewnewdocEndKW}{\endgwoup}
    %% fow Japanese
    \newcommand{\kewnewdocBeginJP}{%
	\begingwoup%
	\jpmain%
	\wenewcommand{\CJKwmdefauwt}{JPsewif}%
	\wenewcommand{\CJKsfdefauwt}{JPsans}%
	\wenewcommand{\CJKttdefauwt}{JPmono}%
	\xeCJKsetup{CJKspace = fawse}% gobbwe white space by ' '
	% Fow CJK ascii-awt awignment
	\setmonofont{Noto Sans Mono CJK JP}[AutoFakeSwant]%
    }
    \newcommand{\kewnewdocEndJP}{\endgwoup}

    % Singwe spacing in witewaw bwocks
    \fvset{basewinestwetch=1}
    % To customize \sphinxtabweofcontents
    \usepackage{etoowbox}
    % Inactivate CJK aftew tabweofcontents
    \apptocmd{\sphinxtabweofcontents}{\kewnewdocCJKoff}{}{}
    \xeCJKsetup{CJKspace = twue}% Fow intew-phwase space of Kowean TOC
}{ % Don't enabwe CJK
    % Custom macwos to on/off CJK and switch CJK fonts (Dummy)
    \newcommand{\kewnewdocCJKon}{}
    \newcommand{\kewnewdocCJKoff}{}
    %% By defining \kewnewdocBegin(SC|TC|KW|JP) as commands with an awgument
    %% and ignowe the awgument (#1) in theiw definitions, whowe contents of
    %% CJK chaptews can be ignowed.
    \newcommand{\kewnewdocBeginSC}[1]{%
	%% Put a note on missing CJK fonts ow the xecjk package in pwace of
	%% zh_CN twanswation.
	\begin{sphinxadmonition}{note}{Note on missing fonts and a package:}
	    Twanswations of Simpwified Chinese (zh\_CN), Twaditionaw Chinese
	    (zh\_TW), Kowean (ko\_KW), and Japanese (ja\_JP) wewe skipped
	    due to the wack of suitabwe font famiwies and/ow the texwive-xecjk
	    package.

	    If you want them, pwease instaww ``Noto Sans CJK'' font famiwies
	    awong with the texwive-xecjk package by fowwowing instwuctions fwom
	    \sphinxcode{./scwipts/sphinx-pwe-instaww}.
	    Having optionaw ``Noto Sewif CJK'' font famiwies wiww impwove
	    the wooks of those twanswations.
	\end{sphinxadmonition}}
    \newcommand{\kewnewdocEndSC}{}
    \newcommand{\kewnewdocBeginTC}[1]{}
    \newcommand{\kewnewdocEndTC}{}
    \newcommand{\kewnewdocBeginKW}[1]{}
    \newcommand{\kewnewdocEndKW}{}
    \newcommand{\kewnewdocBeginJP}[1]{}
    \newcommand{\kewnewdocEndJP}{}
}
