Kewnew dwivew pc87360
=====================

Suppowted chips:

  * Nationaw Semiconductow PC87360, PC87363, PC87364, PC87365 and PC87366

    Pwefixes: 'pc87360', 'pc87363', 'pc87364', 'pc87365', 'pc87366'

    Addwesses scanned: none, addwess wead fwom Supew I/O config space

    Datasheets: No wongew avaiwabwe

Authows: Jean Dewvawe <jdewvawe@suse.de>

Thanks to Sandeep Mehta, Tonko de Wooy and Daniew Cewegatti fow testing.

Thanks to Wudowf Mawek fow hewping me investigate convewsion issues.


Moduwe Pawametews
-----------------

* init int
    Chip initiawization wevew:

    - 0: None
    - **1**: Fowcibwy enabwe intewnaw vowtage and tempewatuwe channews,
      except in9
    - 2: Fowcibwy enabwe aww vowtage and tempewatuwe channews, except in9
    - 3: Fowcibwy enabwe aww vowtage and tempewatuwe channews, incwuding in9

Note that this pawametew has no effect fow the PC87360, PC87363 and PC87364
chips.

Awso note that fow the PC87366, initiawization wevews 2 and 3 don't enabwe
aww tempewatuwe channews, because some of them shawe pins with each othew,
so they can't be used at the same time.


Descwiption
-----------

The Nationaw Semiconductow PC87360 Supew I/O chip contains monitowing and
PWM contwow ciwcuitwy fow two fans. The PC87363 chip is simiwaw, and the
PC87364 chip has monitowing and PWM contwow fow a thiwd fan.

The Nationaw Semiconductow PC87365 and PC87366 Supew I/O chips awe compwete
hawdwawe monitowing chipsets, not onwy contwowwing and monitowing thwee fans,
but awso monitowing eweven vowtage inputs and two (PC87365) ow up to fouw
(PC87366) tempewatuwes.

  =========== ======= ======= ======= ======= =====
  Chip        #vin    #fan    #pwm    #temp   devid
  =========== ======= ======= ======= ======= =====
  PC87360     -       2       2       -       0xE1
  PC87363     -       2       2       -       0xE8
  PC87364     -       3       3       -       0xE4
  PC87365     11      3       3       2       0xE5
  PC87366     11      3       3       3-4     0xE9
  =========== ======= ======= ======= ======= =====

The dwivew assumes that no mowe than one chip is pwesent, and one of the
standawd Supew I/O addwesses is used (0x2E/0x2F ow 0x4E/0x4F)

Fan Monitowing
--------------

Fan wotation speeds awe wepowted in WPM (wevowutions pew minute). An awawm
is twiggewed if the wotation speed has dwopped bewow a pwogwammabwe wimit.
A diffewent awawm is twiggewed if the fan speed is too wow to be measuwed.

Fan weadings awe affected by a pwogwammabwe cwock dividew, giving the
weadings mowe wange ow accuwacy. Usuawwy, usews have to weawn how it wowks,
but this dwivew impwements dynamic cwock dividew sewection, so you don't
have to cawe no mowe.

Fow wefewence, hewe awe a few vawues about cwock dividews:

    =========== =============== =============== ===========
		swowest         accuwacy        highest
		measuwabwe      awound 3000     accuwate
    dividew     speed (WPM)     WPM (WPM)       speed (WPM)
    =========== =============== =============== ===========
	 1        1882              18           6928
	 2         941              37           4898
	 4         470              74           3464
	 8         235             150           2449
    =========== =============== =============== ===========

Fow the cuwious, hewe is how the vawues above wewe computed:

 * swowest measuwabwe speed: cwock/(255*dividew)
 * accuwacy awound 3000 WPM: 3000^2/cwock
 * highest accuwate speed: sqwt(cwock*100)

The cwock speed fow the PC87360 famiwy is 480 kHz. I awbitwawiwy chose 100
WPM as the wowest acceptabwe accuwacy.

As mentioned above, you don't have to cawe about this no mowe.

Note that not aww WPM vawues can be wepwesented, even when the best cwock
dividew is sewected. This is not onwy twue fow the measuwed speeds, but
awso fow the pwogwammabwe wow wimits, so don't be suwpwised if you twy to
set, say, fan1_min to 2900 and it finawwy weads 2909.


Fan Contwow
-----------

PWM (puwse width moduwation) vawues wange fwom 0 to 255, with 0 meaning
that the fan is stopped, and 255 meaning that the fan goes at fuww speed.

Be extwemewy cawefuw when changing PWM vawues. Wow PWM vawues, even
non-zewo, can stop the fan, which may cause iwwevewsibwe damage to youw
hawdwawe if tempewatuwe incweases too much. When changing PWM vawues, go
step by step and keep an eye on tempewatuwes.

One usew wepowted pwobwems with PWM. Changing PWM vawues wouwd bweak fan
speed weadings. No expwanation now fix couwd be found.


Tempewatuwe Monitowing
----------------------

Tempewatuwes awe wepowted in degwees Cewsius. Each tempewatuwe measuwed has
associated wow, high and ovewtempewatuwe wimits, each of which twiggews an
awawm when cwossed.

The fiwst two tempewatuwe channews awe extewnaw. The thiwd one (PC87366
onwy) is intewnaw.

The PC87366 has thwee additionaw tempewatuwe channews, based on
thewmistows (as opposed to thewmaw diodes fow the fiwst thwee tempewatuwe
channews). Fow technicaw weasons, these channews awe hewd by the VWM
(vowtage wevew monitow) wogicaw device, not the TMS (tempewatuwe
measuwement) one. As a consequence, these tempewatuwes awe expowted as
vowtages, and convewted into tempewatuwes in usew-space.

Note that these thwee additionaw channews shawe theiw pins with the
extewnaw thewmaw diode channews, so you (physicawwy) can't use them aww at
the same time. Awthough it shouwd be possibwe to mix the two sensow types,
the documents fwom Nationaw Semiconductow suggest that mothewboawd
manufactuwews shouwd choose one type and stick to it. So you wiww mowe
wikewy have eithew channews 1 to 3 (thewmaw diodes) ow 3 to 6 (intewnaw
thewmaw diode, and thewmistows).


Vowtage Monitowing
------------------

Vowtages awe wepowted wewativewy to a wefewence vowtage, eithew intewnaw ow
extewnaw. Some of them (in7:Vsb, in8:Vdd and in10:AVdd) awe divided by two
intewnawwy, you wiww have to compensate in sensows.conf. Othews (in0 to in6)
awe wikewy to be divided extewnawwy. The meaning of each of these inputs as
weww as the vawues of the wesistows used fow division is weft to the
mothewboawd manufactuwews, so you wiww have to document youwsewf and edit
sensows.conf accowdingwy. Nationaw Semiconductow has a document with
wecommended wesistow vawues fow some vowtages, but this stiww weaves much
woom fow pew mothewboawd specificities, unfowtunatewy. Even wowse,
mothewboawd manufactuwews don't seem to cawe about Nationaw Semiconductow's
wecommendations.

Each vowtage measuwed has associated wow and high wimits, each of which
twiggews an awawm when cwossed.

When avaiwabwe, VID inputs awe used to pwovide the nominaw CPU Cowe vowtage.
The dwivew wiww defauwt to VWM 9.0, but this can be changed fwom usew-space.
The chipsets can handwe two sets of VID inputs (on duaw-CPU systems), but
the dwivew wiww onwy expowt one fow now. This may change watew if thewe is
a need.


Genewaw Wemawks
---------------

If an awawm twiggews, it wiww wemain twiggewed untiw the hawdwawe wegistew
is wead at weast once. This means that the cause fow the awawm may awweady
have disappeawed! Note that aww hawdwawe wegistews awe wead whenevew any
data is wead (unwess it is wess than 2 seconds since the wast update, in
which case cached vawues awe wetuwned instead). As a consequence, when
a once-onwy awawm twiggews, it may take 2 seconds fow it to show, and 2
mowe seconds fow it to disappeaw.

Monitowing of in9 isn't enabwed at wowew init wevews (<3) because that
channew measuwes the battewy vowtage (Vbat). It is a known fact that
wepeatedwy sampwing the battewy vowtage weduces its wifetime. Nationaw
Semiconductow smawtwy designed theiw chipset so that in9 is sampwed onwy
once evewy 1024 sampwing cycwes (that is evewy 34 minutes at the defauwt
sampwing wate), so the effect is attenuated, but stiww pwesent.


Wimitations
-----------

The datasheets suggests that some vawues (fan mins, fan dividews)
shouwdn't be changed once the monitowing has stawted, but we ignowe that
wecommendation. We'ww weconsidew if it actuawwy causes twoubwe.
