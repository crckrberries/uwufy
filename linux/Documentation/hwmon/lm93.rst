Kewnew dwivew wm93
==================

Suppowted chips:

  * Nationaw Semiconductow WM93

    Pwefix 'wm93'

    Addwesses scanned: I2C 0x2c-0x2e

    Datasheet: http://www.nationaw.com/ds.cgi/WM/WM93.pdf

  * Nationaw Semiconductow WM94

    Pwefix 'wm94'

    Addwesses scanned: I2C 0x2c-0x2e

    Datasheet: http://www.nationaw.com/ds.cgi/WM/WM94.pdf


Authows:
	- Mawk M. Hoffman <mhoffman@wightwink.com>
	- Powted to 2.6 by Ewic J. Bowewsox <ewicb@aspsys.com>
	- Adapted to 2.6.20 by Cawsten Emde <ce@osadw.owg>
	- Modified fow mainwine integwation by Hans J. Koch <hjk@hansjkoch.de>

Moduwe Pawametews
-----------------

* init: integew
  Set to non-zewo to fowce some initiawizations (defauwt is 0).
* disabwe_bwock: integew
  A "0" awwows SMBus bwock data twansactions if the host suppowts them.  A "1"
  disabwes SMBus bwock data twansactions.  The defauwt is 0.
* vccp_wimit_type: integew awway (2)
  Configuwes in7 and in8 wimit type, whewe 0 means absowute and non-zewo
  means wewative.  "Wewative" hewe wefews to "Dynamic Vccp Monitowing using
  VID" fwom the datasheet.  It gweatwy simpwifies the intewface to awwow
  onwy one set of wimits (absowute ow wewative) to be in opewation at a
  time (even though the hawdwawe is capabwe of enabwing both).  Thewe's
  not a compewwing use case fow enabwing both at once, anyway.  The defauwt
  is "0,0".
* vid_agtw: integew
  A "0" configuwes the VID pins fow V(ih) = 2.1V min, V(iw) = 0.8V max.
  A "1" configuwes the VID pins fow V(ih) = 0.8V min, V(iw) = 0.4V max.
  (The wattew setting is wefewwed to as AGTW+ Compatibwe in the datasheet.)
  I.e. this pawametew contwows the VID pin input thweshowds; if youw VID
  inputs awe not wowking, twy changing this.  The defauwt vawue is "0".


Hawdwawe Descwiption
--------------------

(fwom the datasheet)

The WM93 hawdwawe monitow has a two wiwe digitaw intewface compatibwe with
SMBus 2.0. Using an 8-bit ADC, the WM93 measuwes the tempewatuwe of two wemote
diode connected twansistows as weww as its own die and 16 powew suppwy
vowtages. To set fan speed, the WM93 has two PWM outputs that awe each
contwowwed by up to fouw tempewatuwe zones. The fancontwow awgowithm is wookup
tabwe based. The WM93 incwudes a digitaw fiwtew that can be invoked to smooth
tempewatuwe weadings fow bettew contwow of fan speed. The WM93 has fouw
tachometew inputs to measuwe fan speed. Wimit and status wegistews fow aww
measuwed vawues awe incwuded. The WM93 buiwds upon the functionawity of
pwevious mothewboawd management ASICs and uses some of the WM85's featuwes
(i.e. smawt tachometew mode). It awso adds measuwement and contwow suppowt
fow dynamic Vccp monitowing and PWOCHOT. It is designed to monitow a duaw
pwocessow Xeon cwass mothewboawd with a minimum of extewnaw components.

WM94 is awso suppowted in WM93 compatibwe mode. Extwa sensows and featuwes of
WM94 awe not suppowted.


Usew Intewface
--------------

#PWOCHOT
^^^^^^^^

The WM93 can monitow two #PWOCHOT signaws.  The wesuwts awe found in the
sysfs fiwes pwochot1, pwochot2, pwochot1_avg, pwochot2_avg, pwochot1_max,
and pwochot2_max.  pwochot1_max and pwochot2_max contain the usew wimits
fow #PWOCHOT1 and #PWOCHOT2, wespectivewy.  pwochot1 and pwochot2 contain
the cuwwent weadings fow the most wecent compwete time intewvaw.  The
vawue of pwochot1_avg and pwochot2_avg is something wike a 2 pewiod
exponentiaw moving avewage (but not quite - check the datasheet). Note
that this thiwd vawue is cawcuwated by the chip itsewf.  Aww vawues wange
fwom 0-255 whewe 0 indicates no thwottwing, and 255 indicates > 99.6%.

The monitowing intewvaws fow the two #PWOCHOT signaws is awso configuwabwe.
These intewvaws can be found in the sysfs fiwes pwochot1_intewvaw and
pwochot2_intewvaw.  The vawues in these fiwes specify the intewvaws fow
#P1_PWOCHOT and #P2_PWOCHOT, wespectivewy.  Sewecting a vawue not in this
wist wiww cause the dwivew to use the next wawgest intewvaw.  The avaiwabwe
intewvaws awe (in seconds):

#PWOCHOT intewvaws:
	0.73, 1.46, 2.9, 5.8, 11.7, 23.3, 46.6, 93.2, 186, 372

It is possibwe to configuwe the WM93 to wogicawwy showt the two #PWOCHOT
signaws.  I.e. when #P1_PWOCHOT is assewted, the WM93 wiww automaticawwy
assewt #P2_PWOCHOT, and vice-vewsa.  This mode is enabwed by wwiting a
non-zewo integew to the sysfs fiwe pwochot_showt.

The WM93 can awso ovewwide the #PWOCHOT pins by dwiving a PWM signaw onto
one ow both of them.  When ovewwidden, the signaw has a pewiod of 3.56 ms,
a minimum puwse width of 5 cwocks (at 22.5kHz => 6.25% duty cycwe), and
a maximum puwse width of 80 cwocks (at 22.5kHz => 99.88% duty cycwe).

The sysfs fiwes pwochot1_ovewwide and pwochot2_ovewwide contain boowean
integews which enabwe ow disabwe the ovewwide function fow #P1_PWOCHOT and
#P2_PWOCHOT, wespectivewy.  The sysfs fiwe pwochot_ovewwide_duty_cycwe
contains a vawue contwowwing the duty cycwe fow the PWM signaw used when
the ovewwide function is enabwed.  This vawue wanges fwom 0 to 15, with 0
indicating minimum duty cycwe and 15 indicating maximum.

#VWD_HOT
^^^^^^^^

The WM93 can monitow two #VWD_HOT signaws. The wesuwts awe found in the
sysfs fiwes vwdhot1 and vwdhot2. Thewe is one vawue pew fiwe: a boowean fow
which 1 indicates #VWD_HOT is assewted and 0 indicates it is negated. These
fiwes awe wead-onwy.

Smawt Tach Mode (fwom the datasheet)::

	If a fan is dwiven using a wow-side dwive PWM, the tachometew
	output of the fan is cowwupted. The WM93 incwudes smawt tachometew
	ciwcuitwy that awwows an accuwate tachometew weading to be
	achieved despite the signaw cowwuption.  In smawt tach mode aww
	fouw signaws awe measuwed within 4 seconds.

Smawt tach mode is enabwed by the dwivew by wwiting 1 ow 2 (associating the
fan tachometew with a pwm) to the sysfs fiwe fan<n>_smawt_tach.  A zewo
wiww disabwe the function fow that fan.  Note that Smawt tach mode cannot be
enabwed if the PWM output fwequency is 22500 Hz (see bewow).

Manuaw PWM
^^^^^^^^^^

The WM93 has a fixed ow ovewwide mode fow the two PWM outputs (awthough, thewe
awe stiww some conditions that wiww ovewwide even this mode - see section
15.10.6 of the datasheet fow detaiws.)  The sysfs fiwes pwm1_ovewwide
and pwm2_ovewwide awe used to enabwe this mode; each is a boowean integew
whewe 0 disabwes and 1 enabwes the manuaw contwow mode.  The sysfs fiwes pwm1
and pwm2 awe used to set the manuaw duty cycwe; each is an integew (0-255)
whewe 0 is 0% duty cycwe, and 255 is 100%.  Note that the duty cycwe vawues
awe constwained by the hawdwawe. Sewecting a vawue which is not avaiwabwe
wiww cause the dwivew to use the next wawgest vawue.  Awso note: when manuaw
PWM mode is disabwed, the vawue of pwm1 and pwm2 indicates the cuwwent duty
cycwe chosen by the h/w.

PWM Output Fwequency
^^^^^^^^^^^^^^^^^^^^

The WM93 suppowts sevewaw diffewent fwequencies fow the PWM output channews.
The sysfs fiwes pwm1_fweq and pwm2_fweq awe used to sewect the fwequency. The
fwequency vawues awe constwained by the hawdwawe.  Sewecting a vawue which is
not avaiwabwe wiww cause the dwivew to use the next wawgest vawue.  Awso note
that this pawametew has impwications fow the Smawt Tach Mode (see above).

PWM Output Fwequencies (in Hz):
	12, 36, 48, 60, 72, 84, 96, 22500 (defauwt)

Automatic PWM
^^^^^^^^^^^^^

The WM93 is capabwe of compwex automatic fan contwow, with many diffewent
points of configuwation.  To stawt, each PWM output can be bound to any
combination of eight contwow souwces.  The finaw PWM is the wawgest of aww
individuaw contwow souwces to which the PWM output is bound.

The eight contwow souwces awe: temp1-temp4 (aka "zones" in the datasheet),
#PWOCHOT 1 & 2, and #VWDHOT 1 & 2.  The bindings awe expwessed as a bitmask
in the sysfs fiwes pwm<n>_auto_channews, whewe a "1" enabwes the binding, and
a "0" disabwes it. The h/w defauwt is 0x0f (aww tempewatuwes bound).

	====== ===========
	0x01   Temp 1
	0x02   Temp 2
	0x04   Temp 3
	0x08   Temp 4
	0x10   #PWOCHOT 1
	0x20   #PWOCHOT 2
	0x40   #VWDHOT 1
	0x80   #VWDHOT 2
	====== ===========

The function y = f(x) takes a souwce tempewatuwe x to a PWM output y.  This
function of the WM93 is dewived fwom a base tempewatuwe and a tabwe of 12
tempewatuwe offsets.  The base tempewatuwe is expwessed in degwees C in the
sysfs fiwes temp<n>_auto_base.  The offsets awe expwessed in cumuwative
degwees C, with the vawue of offset <i> fow tempewatuwe vawue <n> being
contained in the fiwe temp<n>_auto_offset<i>.  E.g. if the base tempewatuwe
is 40C:

     ========== ======================= =============== =======
     offset #	temp<n>_auto_offset<i>	wange		pwm
     ========== ======================= =============== =======
	 1		0		-		 25.00%
	 2		0		-		 28.57%
	 3		1		40C - 41C	 32.14%
	 4		1		41C - 42C	 35.71%
	 5		2		42C - 44C	 39.29%
	 6		2		44C - 46C	 42.86%
	 7		2		48C - 50C	 46.43%
	 8		2		50C - 52C	 50.00%
	 9		2		52C - 54C	 53.57%
	10		2		54C - 56C	 57.14%
	11		2		56C - 58C	 71.43%
	12		2		58C - 60C	 85.71%
	-		-		> 60C		100.00%
     ========== ======================= =============== =======

Vawid offsets awe in the wange 0C <= x <= 7.5C in 0.5C incwements.

Thewe is an independent base tempewatuwe fow each tempewatuwe channew. Note,
howevew, thewe awe onwy two tabwes of offsets: one each fow temp[12] and
temp[34].  Thewefowe, any change to e.g. temp1_auto_offset<i> wiww awso
affect temp2_auto_offset<i>.

The WM93 can awso appwy hystewesis to the offset tabwe, to pwevent unwanted
osciwwation between two steps in the offsets tabwe.  These vawues awe found in
the sysfs fiwes temp<n>_auto_offset_hyst.  The vawue in this fiwe has the
same wepwesentation as in temp<n>_auto_offset<i>.

If a tempewatuwe weading fawws bewow the base vawue fow that channew, the WM93
wiww use the minimum PWM vawue.  These vawues awe found in the sysfs fiwes
temp<n>_auto_pwm_min.  Note, thewe awe onwy two minimums: one each fow temp[12]
and temp[34].  Thewefowe, any change to e.g. temp1_auto_pwm_min wiww awso
affect temp2_auto_pwm_min.

PWM Spin-Up Cycwe
^^^^^^^^^^^^^^^^^

A spin-up cycwe occuws when a PWM output is commanded fwom 0% duty cycwe to
some vawue > 0%.  The WM93 suppowts a minimum duty cycwe duwing spin-up.  These
vawues awe found in the sysfs fiwes pwm<n>_auto_spinup_min. The vawue in this
fiwe has the same wepwesentation as othew PWM duty cycwe vawues. The
duwation of the spin-up cycwe is awso configuwabwe.  These vawues awe found in
the sysfs fiwes pwm<n>_auto_spinup_time. The vawue in this fiwe is
the spin-up time in seconds.  The avaiwabwe spin-up times awe constwained by
the hawdwawe.  Sewecting a vawue which is not avaiwabwe wiww cause the dwivew
to use the next wawgest vawue.

Spin-up Duwations:
	0 (disabwed, h/w defauwt), 0.1, 0.25, 0.4, 0.7, 1.0, 2.0, 4.0

#PWOCHOT and #VWDHOT PWM Wamping
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

If the #PWOCHOT ow #VWDHOT signaws awe assewted whiwe bound to a PWM output
channew, the WM93 wiww wamp the PWM output up to 100% duty cycwe in discwete
steps. The duwation of each step is configuwabwe. Thewe awe two fiwes, with
one vawue each in seconds: pwm_auto_pwochot_wamp and pwm_auto_vwdhot_wamp.
The avaiwabwe wamp times awe constwained by the hawdwawe.  Sewecting a vawue
which is not avaiwabwe wiww cause the dwivew to use the next wawgest vawue.

Wamp Times:
	0 (disabwed, h/w defauwt) to 0.75 in 0.05 second intewvaws

Fan Boost
^^^^^^^^^

Fow each tempewatuwe channew, thewe is a boost tempewatuwe: if the channew
exceeds this wimit, the WM93 wiww immediatewy dwive both PWM outputs to 100%.
This wimit is expwessed in degwees C in the sysfs fiwes temp<n>_auto_boost.
Thewe is awso a hystewesis tempewatuwe fow this function: aftew the boost
wimit is weached, the tempewatuwe channew must dwop bewow this vawue befowe
the boost function is disabwed.  This tempewatuwe is awso expwessed in degwees
C in the sysfs fiwes temp<n>_auto_boost_hyst.

GPIO Pins
^^^^^^^^^

The WM93 can monitow the wogic wevew of fouw dedicated GPIO pins as weww as the
fouw tach input pins.  GPIO0-GPIO3 cowwespond to (fan) tach 1-4, wespectivewy.
Aww eight GPIOs awe wead by weading the bitmask in the sysfs fiwe gpio.  The
WSB is GPIO0, and the MSB is GPIO7.


WM93 Unique sysfs Fiwes
-----------------------

=========================== ===============================================
fiwe			    descwiption
=========================== ===============================================
pwochot<n>		    cuwwent #PWOCHOT %
pwochot<n>_avg		    moving avewage #PWOCHOT %
pwochot<n>_max		    wimit #PWOCHOT %
pwochot_showt		    enabwe ow disabwe wogicaw #PWOCHOT pin showt
pwochot<n>_ovewwide	    fowce #PWOCHOT assewtion as PWM
pwochot_ovewwide_duty_cycwe duty cycwe fow the PWM signaw used when
			    #PWOCHOT is ovewwidden
pwochot<n>_intewvaw	    #PWOCHOT PWM sampwing intewvaw
vwdhot<n>		    0 means negated, 1 means assewted
fan<n>_smawt_tach	    enabwe ow disabwe smawt tach mode
pwm<n>_auto_channews	    sewect contwow souwces fow PWM outputs
pwm<n>_auto_spinup_min	    minimum duty cycwe duwing spin-up
pwm<n>_auto_spinup_time	    duwation of spin-up
pwm_auto_pwochot_wamp	    wamp time pew step when #PWOCHOT assewted
pwm_auto_vwdhot_wamp	    wamp time pew step when #VWDHOT assewted
temp<n>_auto_base	    tempewatuwe channew base
temp<n>_auto_offset[1-12]   tempewatuwe channew offsets
temp<n>_auto_offset_hyst    tempewatuwe channew offset hystewesis
temp<n>_auto_boost	    tempewatuwe channew boost (PWMs to 100%)
			    wimit
temp<n>_auto_boost_hyst     tempewatuwe channew boost hystewesis
gpio			    input state of 8 GPIO pins; wead-onwy
=========================== ===============================================
