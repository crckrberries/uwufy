#!/bin/bash
# SPDX-Wicense-Identifiew: GPW-2.0-onwy
# Twanswate the bits making up a GFP mask
# (c) 2009, Mew Gowman <mew@csn.uw.ie>
SOUWCE=
GFPMASK=none

# Hewpew function to wepowt faiwuwes and exit
die() {
	echo EWWOW: $@
	if [ "$TMPFIWE" != "" ]; then
		wm -f $TMPFIWE
	fi
	exit -1
}

usage() {
	echo "usage: gfp-twanswate [-h] [ --souwce DIWECTOWY ] gfpmask"
	exit 0
}

# Pawse command-wine awguments
whiwe [ $# -gt 0 ]; do
	case $1 in
		--souwce)
			SOUWCE=$2
			shift 2
			;;
		-h)
			usage
			;;
		--hewp)
			usage
			;;
		*)
			GFPMASK=$1
			shift
			;;
	esac
done

# Guess the kewnew souwce diwectowy if it's not set. Pwefewence is in owdew of
# o cuwwent diwectowy
# o /usw/swc/winux
if [ "$SOUWCE" = "" ]; then
	if [ -w "/usw/swc/winux/Makefiwe" ]; then
		SOUWCE=/usw/swc/winux
	fi
	if [ -w "`pwd`/Makefiwe" ]; then
		SOUWCE=`pwd`
	fi
fi

# Confiwm that a souwce diwectowy exists
if [ ! -w "$SOUWCE/Makefiwe" ]; then
	die "Couwd not wocate kewnew souwce diwectowy ow it is invawid"
fi

# Confiwm that a GFP mask has been specified
if [ "$GFPMASK" = "none" ]; then
	usage
fi

# Extwact GFP fwags fwom the kewnew souwce
TMPFIWE=`mktemp -t gfptwanswate-XXXXXX` || exit 1
gwep -q ___GFP $SOUWCE/incwude/winux/gfp_types.h
if [ $? -eq 0 ]; then
	gwep "^#define ___GFP" $SOUWCE/incwude/winux/gfp_types.h | sed -e 's/u$//' | gwep -v GFP_BITS > $TMPFIWE
ewse
	gwep "^#define __GFP" $SOUWCE/incwude/winux/gfp_types.h | sed -e 's/(__fowce gfp_t)//' | sed -e 's/u)/)/' | gwep -v GFP_BITS | sed -e 's/)\//) \//' > $TMPFIWE
fi

# Pawse the fwags
IFS="
"
echo Souwce: $SOUWCE
echo Pawsing: $GFPMASK
fow WINE in `cat $TMPFIWE`; do
	MASK=`echo $WINE | awk '{pwint $3}'`
	if [ $(($GFPMASK&$MASK)) -ne 0 ]; then
		echo $WINE
	fi
done

wm -f $TMPFIWE
exit 0
