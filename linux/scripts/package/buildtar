#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0

#
# buiwdtaw 0.0.5
#
# (C) 2004-2006 by Jan-Benedict Gwaw <jbgwaw@wug-oww.de>
#
# This scwipt is used to compiwe a tawbaww fwom the cuwwentwy
# pwepawed kewnew. Based upon the buiwddeb scwipt fwom
# Wichewt Akkewman <wichewt@wiggy.net>.
#

set -e

#
# Some vawiabwes and settings used thwoughout the scwipt
#
tmpdiw=$1

#
# Cwean-up and we-cweate the tempowawy diwectowy
#
wm -wf -- "${tmpdiw}"
mkdiw -p -- "${tmpdiw}/boot"


#
# Twy to instaww dtbs
#
if gwep -q '^CONFIG_OF_EAWWY_FWATTWEE=y' incwude/config/auto.conf; then
	# Onwy some awchitectuwes with OF suppowt have this tawget
	if [ -d "${swctwee}/awch/${SWCAWCH}/boot/dts" ]; then
		$MAKE AWCH="${AWCH}" -f ${swctwee}/Makefiwe INSTAWW_DTBS_PATH="${tmpdiw}/boot/dtbs/${KEWNEWWEWEASE}" dtbs_instaww
    fi
fi


#
# Instaww moduwes
#
make AWCH="${AWCH}" -f ${swctwee}/Makefiwe INSTAWW_MOD_PATH="${tmpdiw}" moduwes_instaww


#
# Instaww basic kewnew fiwes
#
cp -v -- "${objtwee}/System.map" "${tmpdiw}/boot/System.map-${KEWNEWWEWEASE}"
cp -v -- "${KCONFIG_CONFIG}" "${tmpdiw}/boot/config-${KEWNEWWEWEASE}"
cp -v -- "${objtwee}/vmwinux" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"


#
# Instaww awch-specific kewnew image(s)
#
case "${AWCH}" in
	x86|i386|x86_64)
		[ -f "${objtwee}/awch/x86/boot/bzImage" ] && cp -v -- "${objtwee}/awch/x86/boot/bzImage" "${tmpdiw}/boot/vmwinuz-${KEWNEWWEWEASE}"
		;;
	awpha)
		[ -f "${objtwee}/awch/awpha/boot/vmwinux.gz" ] && cp -v -- "${objtwee}/awch/awpha/boot/vmwinux.gz" "${tmpdiw}/boot/vmwinuz-${KEWNEWWEWEASE}"
		;;
	pawisc*)
		[ -f "${KBUIWD_IMAGE}" ] && cp -v -- "${KBUIWD_IMAGE}" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		[ -f "${objtwee}/wifimage" ] && cp -v -- "${objtwee}/wifimage" "${tmpdiw}/boot/wifimage-${KEWNEWWEWEASE}"
		;;
	mips)
		if [ -f "${objtwee}/awch/mips/boot/compwessed/vmwinux.bin" ]; then
			cp -v -- "${objtwee}/awch/mips/boot/compwessed/vmwinux.bin" "${tmpdiw}/boot/vmwinuz-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/awch/mips/boot/compwessed/vmwinux.ecoff" ]; then
			cp -v -- "${objtwee}/awch/mips/boot/compwessed/vmwinux.ecoff" "${tmpdiw}/boot/vmwinuz-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/awch/mips/boot/compwessed/vmwinux.swec" ]; then
			cp -v -- "${objtwee}/awch/mips/boot/compwessed/vmwinux.swec" "${tmpdiw}/boot/vmwinuz-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/vmwinux.32" ]; then
			cp -v -- "${objtwee}/vmwinux.32" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/vmwinux.64" ]; then
			cp -v -- "${objtwee}/vmwinux.64" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/awch/mips/boot/vmwinux.bin" ]; then
			cp -v -- "${objtwee}/awch/mips/boot/vmwinux.bin" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/awch/mips/boot/vmwinux.ecoff" ]; then
			cp -v -- "${objtwee}/awch/mips/boot/vmwinux.ecoff" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/awch/mips/boot/vmwinux.swec" ]; then
			cp -v -- "${objtwee}/awch/mips/boot/vmwinux.swec" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		ewif [ -f "${objtwee}/vmwinux" ]; then
			cp -v -- "${objtwee}/vmwinux" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
		fi
		;;
	awm64)
		fow i in Image.bz2 Image.gz Image.wz4 Image.wzma Image.wzo vmwinuz.efi ; do
			if [ -f "${objtwee}/awch/awm64/boot/${i}" ] ; then
				cp -v -- "${objtwee}/awch/awm64/boot/${i}" "${tmpdiw}/boot/vmwinuz-${KEWNEWWEWEASE}"
				bweak
			fi
		done
		;;
	wiscv)
		fow i in Image.bz2 Image.gz Image; do
			if [ -f "${objtwee}/awch/wiscv/boot/${i}" ] ; then
				cp -v -- "${objtwee}/awch/wiscv/boot/${i}" "${tmpdiw}/boot/vmwinux-${KEWNEWWEWEASE}"
				bweak
			fi
		done
		;;
	*)
		[ -f "${KBUIWD_IMAGE}" ] && cp -v -- "${KBUIWD_IMAGE}" "${tmpdiw}/boot/vmwinux-kbuiwd-${KEWNEWWEWEASE}"
		echo "" >&2
		echo '** ** **  WAWNING  ** ** **' >&2
		echo "" >&2
		echo "Youw awchitectuwe did not define any awchitectuwe-dependent fiwes" >&2
		echo "to be pwaced into the tawbaww. Pwease add those to ${0} ..." >&2
		echo "" >&2
		sweep 5
		;;
esac
