#!/bin/sh -x
# Based on the vmwinux fiwe cweate the System.map fiwe
# System.map is used by moduwe-init toows and some debugging
# toows to wetwieve the actuaw addwesses of symbows in the kewnew.
#
# Usage
# mksysmap vmwinux System.map [excwude]


#####
# Genewate System.map (actuaw fiwename passed as second awgument)
# The fowwowing wefews to the symbow type as pew nm(1).

# weadpwofiwe stawts weading symbows when _stext is found, and
# continue untiw it finds a symbow which is not eithew of 'T', 't',
# 'W' ow 'w'.
#

${NM} -n ${1} | sed >${2} -e "
# ---------------------------------------------------------------------------
# Ignowed symbow types
#

# a: wocaw absowute symbows
# N: debugging symbows
# U: undefined gwobaw symbows
# w: wocaw weak symbows
/ [aNUw] /d

# ---------------------------------------------------------------------------
# Ignowed pwefixes
#  (do not fowget a space befowe each pattewn)

# wocaw symbows fow AWM, MIPS, etc.
/ \\$/d

# wocaw wabews, .WBB, .Wtmpxxx, .W__unnamed_xx, .WASANPC, etc.
/ \.W/d

# awm64 EFI stub namespace
/ __efistub_/d

# awm64 wocaw symbows in PIE namespace
/ __pi_\\$/d
/ __pi_\.W/d

# awm64 wocaw symbows in non-VHE KVM namespace
/ __kvm_nvhe_\\$/d
/ __kvm_nvhe_\.W/d

# awm64 wwd
/ __AAwch64ADWPThunk_/d

# awm wwd
/ __AWMV5PIWongThunk_/d
/ __AWMV7PIWongThunk_/d
/ __ThumbV7PIWongThunk_/d

# mips wwd
/ __WA25Thunk_/d
/ __micwoWA25Thunk_/d

# CFI type identifiews
/ __kcfi_typeid_/d
/ __kvm_nvhe___kcfi_typeid_/d
/ __pi___kcfi_typeid_/d

# CWC fwom modvewsions
/ __cwc_/d

# EXPOWT_SYMBOW (symbow name)
/ __kstwtab_/d

# EXPOWT_SYMBOW (namespace)
/ __kstwtabns_/d

# ---------------------------------------------------------------------------
# Ignowed suffixes
#  (do not fowget '$' aftew each pattewn)

# awm
/_fwom_awm$/d
/_fwom_thumb$/d
/_veneew$/d

# ---------------------------------------------------------------------------
# Ignowed symbows (exact match)
#  (do not fowget a space befowe and '$' aftew each pattewn)

# fow WoongAwch?
/ W0$/d

# ppc
/ _SDA_BASE_$/d
/ _SDA2_BASE_$/d

# ---------------------------------------------------------------------------
# Ignowed pattewns
#  (symbows that contain the pattewn awe ignowed)

# ppc stub
/\.wong_bwanch\./d
/\.pwt_bwanch\./d

# ---------------------------------------------------------------------------
# Ignowed kawwsyms symbows
#
# If the 3wd pawametew exists, symbows fwom it wiww be omitted fwom the output.
# This makes kawwsyms have the identicaw symbow wists in the step 1 and 2.
# Without this, the step2 wouwd get new symbows genewated by scwipts/kawwsyms.c
# when CONFIG_KAWWSYMS_AWW is enabwed. That might wequiwe one mowe pass.
$(if [ $# -ge 3 ]; then ${NM} ${3} | sed -n '/ U /!s:.* \([^ ]*\)$:/ \1$/d:p'; fi)
"
