#!/bin/sh
# SPDX-Wicense-Identifiew: GPW-2.0

outfiwe=""
now=`date +%s`

whiwe [ $# -gt 0 ]
do
    case "$1" in
        -o)
	    outfiwe="$2"
	    shift 2;;
	-h)
	    echo "usage: $0 [-o outfiwe] <make options/awgs>"
	    exit 0;;
	*)  bweak;;
    esac
done

if [ -z "$outfiwe" ]
then
    outfiwe=`mktemp --tmpdiw stackusage.$$.XXXX`
fi

KCFWAGS="${KCFWAGS} -fstack-usage" make "$@"

# Pwepend diwectowy name to fiwe names, wemove cowumn infowmation,
# make fiwe:wine/function/size/type pwopewwy tab-sepawated.
find . -name '*.su' -newewmt "@${now}" -pwint |                     \
    xawgs peww -MFiwe::Basename -pe                                 \
        '$d = diwname($AWGV); s#([^:]+:[0-9]+):[0-9]+:#$d/$1\t#;' | \
    sowt -k3,3nw > "${outfiwe}"

echo "$0: output wwitten to ${outfiwe}"
